<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>DETECTOR OBR</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@500;700&family=Creepster&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <style>
        :root {
            --neon-green: #39FF14;
            --alert-red: #FF3333;
            --sim-orange: #FFB000;
            --sensor-blue: #00BFFF; 
            --panel-bg-dark: rgba(10, 15, 10, 0.85);
            --border-color-dark: rgba(57, 255, 20, 0.4);
            --panel-width-landscape: 300px;
            --panel-height-landscape: 160px;
            --bottom-panel-height-vertical: 200px;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: #000;
            color: #E0E0E0;
            overflow: hidden;
            width: 100vw; height: 100dvh;
        }

        #app-ui {
            width: 100%; height: 100%; position: relative; touch-action: none;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* --- C츼MARA --- */
        #main-view-area {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: 5; background: #000;
        }

        #bg-camera-feed {
            position: absolute; top: 50%; left: 50%;
            min-width: 100%; min-height: 100%; width: auto; height: auto;
            object-fit: cover; transform: translate(-50%, -50%);
            z-index: 1;
            transition: filter 0.3s ease;
        }
        
        /* Filtros Visuales */
        body.filter-night #bg-camera-feed { filter: grayscale(1) sepia(1) hue-rotate(50deg) contrast(1.5) saturate(3) brightness(1.5); }
        body.filter-negative #bg-camera-feed { filter: invert(1) contrast(1.1); }
        /* NOTA: SLS (Kinect) usa la c치mara normal, el canvas hace el resto */

        #main-filter-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2; pointer-events: none; display: none;
        }
        body.filter-sls #main-filter-canvas { display: block; }

        /* --- LOGO (Restaurado) --- */
        #logo-image {
            position: fixed; top: 20px; right: 20px; width: 80px; height: 80px;
            z-index: 50; pointer-events: none;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.5s;
            filter: drop-shadow(0 0 5px var(--neon-green));
        }
        #logo-image.hiding {
            transform: scale(0) rotate(180deg);
            opacity: 0;
        }

        /* --- SOCIAL OVERLAY (Terror) --- */
        #social-overlay {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 40; pointer-events: none; text-align: center;
            opacity: 0; transition: opacity 1s;
        }
        #social-overlay.visible { opacity: 1; animation: glitch-anim 0.3s infinite; }
        
        .social-title {
            font-family: 'Creepster', cursive; color: #FF0000; font-size: 1.5rem;
            text-shadow: 2px 2px 0px #000, -1px -1px 0 #333; margin-bottom: 10px;
            letter-spacing: 2px;
        }
        .social-icons { display: flex; gap: 15px; justify-content: center; margin-bottom: 5px; }
        .social-icon-svg { width: 30px; height: 30px; fill: #fff; filter: drop-shadow(0 0 5px red); }
        .social-handle { font-family: 'Orbitron', sans-serif; color: #fff; font-size: 1rem; text-shadow: 0 0 10px red; }

        @keyframes glitch-anim {
            0% { transform: translate(-50%, -50%) skewX(0deg); }
            20% { transform: translate(-52%, -49%) skewX(-10deg); }
            40% { transform: translate(-48%, -51%) skewX(10deg); }
            60% { transform: translate(-50%, -50%) skewX(0deg); }
            80% { transform: translate(-51%, -50%) skewX(5deg); filter: hue-rotate(90deg); }
            100% { transform: translate(-50%, -50%) skewX(0deg); }
        }

        /* --- PANELES (Glassmorphism) --- */
        .panel, .panel-section {
            background: var(--panel-bg-dark) !important; 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color-dark) !important;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5) !important;
        }

        #left-panel, #bottom-panel {
            position: fixed; display: flex; flex-direction: column; z-index: 20; pointer-events: none;
            clip-path: circle(0% at 50% 50%); transition: clip-path 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        body.panels-active #left-panel, body.panels-active #bottom-panel {
            clip-path: circle(150% at 50% 50%); pointer-events: auto;
        }
        
        .panel { display: flex; flex-direction: column; padding: 8px; flex-grow: 1; gap: 8px; position: relative; }
        .panel.alert { border-color: var(--alert-red) !important; box-shadow: 0 0 20px var(--alert-red) inset !important; }
        
        .panel-header-main {
            font-family: 'Orbitron', sans-serif; font-size: 0.9rem; text-align: center;
            color: var(--neon-green); text-shadow: 0 0 8px var(--neon-green);
            background: rgba(57, 255, 20, 0.1); padding: 6px 0;
        }
        .section-title {
            font-family: 'Orbitron', sans-serif; font-size: 0.7rem; color: var(--sim-orange);
            text-transform: uppercase; text-align: center; font-weight: 700;
            background: rgba(57, 255, 20, 0.05); padding: 4px; border-radius: 4px;
        }
        .panel-section { display: flex; flex-direction: column; padding: 8px; border-radius: 8px; }

        /* --- CONTROLES FLOTANTES (Flashy & Responsive) --- */
        #filter-controls-container {
            position: fixed; top: 50%; right: 15px; transform: translateY(-50%) scale(0); /* Inicia oculto */
            display: flex; flex-direction: column; gap: 15px; z-index: 100;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            padding: 10px; border-radius: 30px; border: 1px solid rgba(57, 255, 20, 0.3);
            opacity: 0; pointer-events: none;
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.3s, right 0.3s, gap 0.3s;
        }
        
        /* Efecto "Flash" de entrada */
        #filter-controls-container.visible {
            opacity: 1; pointer-events: auto;
            transform: translateY(-50%) scale(1);
            animation: flashEntry 0.4s ease-out forwards;
        }
        @keyframes flashEntry {
            0% { box-shadow: 0 0 0 rgba(57,255,20,0); }
            50% { box-shadow: 0 0 30px rgba(57,255,20,0.8); border-color: #fff; }
            100% { box-shadow: 0 0 0 rgba(57,255,20,0); border-color: rgba(57, 255, 20, 0.3); }
        }

        /* Ajuste cuando el panel est치 activo (Botones m치s chicos y movidos) */
        body.panels-active #filter-controls-container {
            right: 5px; /* M치s pegado al borde */
            gap: 8px;   /* Menos espacio */
            transform: translateY(-50%) scale(0.8); /* 20% m치s peque침os */
            background: rgba(0,0,0,0.8); /* Fondo m치s oscuro para contraste */
        }

        .filter-btn {
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(0, 50, 50, 0.7); border: 2px solid var(--neon-green);
            color: var(--neon-green); font-family: 'Share Tech Mono', monospace;
            font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.3);
            transition: all 0.2s;
        }
        .filter-btn:active { transform: scale(0.9); box-shadow: 0 0 20px var(--neon-green); background: var(--neon-green); color: #000; }
        .filter-btn.active { background: var(--neon-green); color: #000; box-shadow: 0 0 20px var(--neon-green); }

        /* --- KINECT BANNER --- */
        #kinect-banner {
            position: fixed; top: 25px; left: 50%; transform: translateX(-50%);
            z-index: 100; font-family: 'Orbitron', sans-serif; font-size: 1.1rem; font-weight: 700;
            color: var(--neon-green); text-shadow: 0 0 8px var(--neon-green), 0 0 12px #000;
            display: none; pointer-events: none; letter-spacing: 1px;
        }
        #kinect-banner .led-red { animation: pulseGlow 1.5s infinite ease-in-out; text-shadow: 0 0 10px var(--alert-red); }
        @keyframes pulseGlow { 0%, 100% { opacity: 0.6; } 50% { opacity: 1.0; } }

        /* --- ESTILOS COMPONENTES INTERNOS --- */
        .sensor-status-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: center; }
        .status-light-group { display: flex; flex-direction: column; align-items: center; font-size: 0.65rem; }
        .status-led-indicator { width: 12px; height: 12px; border-radius: 50%; background-color: #222; border: 1px solid #444; margin-bottom: 6px; }
        .status-light-group[data-status="connected"] .status-led-indicator { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
        
        .spirit-box-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: center; }
        #knob-scan, #knob-power {
            width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--border-color-dark);
            background: #111; display: flex; align-items: center; justify-content: center;
            font-family: 'Orbitron', sans-serif; font-size: 0.8rem; color: #777;
            box-shadow: 0 4px 6px #000 inset; cursor: pointer; margin: 0 auto;
        }
        #knob-power.active { border-color: var(--alert-red); background: #300; color: var(--alert-red); box-shadow: 0 0 15px var(--alert-red); }
        #knob-scan.active { border-color: var(--sim-orange); color: var(--sim-orange); box-shadow: 0 0 15px var(--sim-orange); }

        .dials-grid { display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 12px; align-items: center; }
        .dial-container { position: relative; width: 75px; height: 75px; background: #000; border-radius: 50%; border: 2px solid var(--border-color-dark); overflow: hidden; margin: 0 auto; }
        .dial-needle { width: 2px; height: 45%; background: red; position: absolute; bottom: 50%; left: 50%; transform-origin: bottom center; transition: transform 0.5s; }
        #compass-needle { background: var(--neon-green); }
        
        #vu-meter-container { width: 100%; height: 40px; background: #000; border: 1px solid var(--border-color-dark); }
        
        /* --- RESPONSIVE --- */
        @media (max-aspect-ratio: 1/1) { /* Vertical */
            #left-panel { top: 0; left: 0; width: 100vw; height: calc(100vh - var(--bottom-panel-height-vertical)); clip-path: circle(0% at 50% 0%); }
            body.panels-active #left-panel { clip-path: circle(150% at 50% 0%); }
            #bottom-panel { bottom: 0; left: 0; width: 100vw; height: var(--bottom-panel-height-vertical); clip-path: circle(0% at 50% 100%); }
            body.panels-active #bottom-panel { clip-path: circle(150% at 50% 100%); }
            #bottom-panel .panel { flex-direction: row; }
            body.panels-active #filter-controls-container { top: 100px; right: 10px; transform: scale(0.7); flex-direction: row; } /* Mover botones arriba en vertical */
        }

        @media (min-aspect-ratio: 1/1) { /* Horizontal */
            #left-panel { width: var(--panel-width-landscape); height: 100vh; top: 0; left: 0; clip-path: circle(0% at 0% 50%); }
            body.panels-active #left-panel { clip-path: circle(150% at 0% 50%); }
            #bottom-panel { width: calc(100% - var(--panel-width-landscape)); height: var(--panel-height-landscape); bottom: 0; left: var(--panel-width-landscape); clip-path: circle(0% at 50% 100%); }
            body.panels-active #bottom-panel { clip-path: circle(150% at 50% 100%); }
            #bottom-panel .panel { flex-direction: row; }
        }
    </style>
</head>
<body>

<div id="app-ui"> 

    <img id="logo-image" src="obr-logo.png" alt="Logo OBR">

    <div id="social-overlay">
        <div class="social-title">S칈GUENOS EN</div>
        <div class="social-icons">
            <svg class="social-icon-svg" viewBox="0 0 24 24"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>
            <svg class="social-icon-svg" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
            <svg class="social-icon-svg" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
        </div>
        <div class="social-handle">@EXPLORACIONESOBR</div>
    </div>

    <div id="main-view-area">
        <video id="bg-camera-feed" playsinline autoplay muted></video>
        <canvas id="main-filter-canvas"></canvas>
    </div>
    
    <canvas id="ai-canvas" style="display:none"></canvas>
    <div id="kinect-banner">KINECT ACTIVO <span class="led-red">游댮</span></div>
    
    <div id="left-panel">
        <div class="panel">
            <div class="panel-header-main">PANEL DE MANDO</div>
            <div class="panel-section">
                <div class="section-title">Sensores</div>
                <div class="sensor-status-grid">
                    <div class="status-light-group" id="mic-status"><div class="status-led-indicator"></div><span>MIC</span></div>
                    <div class="status-light-group" id="mag-status"><div class="status-led-indicator"></div><span>MAG</span></div>
                    <div class="status-light-group" id="prox-status"><div class="status-led-indicator"></div><span>EMF</span></div>
                </div>
            </div>
            <div class="panel-section">
                <div class="section-title">Spirit Box</div>
                <div class="spirit-box-grid">
                    <div style="text-align:center;"><div id="knob-power">REC</div><div style="font-size:0.6rem;margin-top:5px;">POWER</div></div>
                    <div style="text-align:center;"><div id="knob-scan">SCAN</div><div style="font-size:0.6rem;margin-top:5px;">FREQ</div></div>
                    <div style="grid-column: 1/-1; display:flex; gap:5px; align-items:center; margin-top:10px;">
                        <span style="font-size:0.7rem">VOL</span><input type="range" style="flex-grow:1; height:4px;" id="vol-slider">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="bottom-panel">
        <div class="panel">
            <div class="panel-section">
                <div class="section-title">Lecturas</div>
                <div class="dials-grid">
                    <div class="dial-container"><div id="compass-needle" class="dial-needle"></div><div style="position:absolute;bottom:2px;width:100%;text-align:center;font-size:0.5rem">MAG</div></div>
                    <div class="dial-container"><div id="main-needle" class="dial-needle"></div><div style="position:absolute;bottom:2px;width:100%;text-align:center;font-size:0.5rem">DET</div></div>
                    <div id="temp-val" style="text-align:center;font-family:'Orbitron';color:var(--neon-green)">--.-춿C</div>
                </div>
            </div>
            <div class="panel-section" style="flex-grow:1.5">
                <div class="section-title">Audio VU</div>
                <div id="vu-meter-container"><canvas id="vu-meter-canvas"></canvas></div>
            </div>
        </div>
    </div>

    <div id="filter-controls-container">
        <button class="filter-btn" onclick="setFilter('night')">NV</button>
        <button class="filter-btn" onclick="setFilter('sls')">SLS</button>
        <button class="filter-btn" onclick="setFilter('negative')">NEG</button>
        <button class="filter-btn" id="btn-panel" onclick="togglePanels()">PAN</button>
    </div>

</div> 

<script>
    /* --- CONFIGURACI칍N TIMER SOCIAL --- */
    const SOCIAL_INTERVAL_MS = 15000; // <--- CAMBIAR AQU칈 EL TIEMPO (15000 = 15 segundos)

    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzOf3crQxBdPylwMTAd34W-nBShN31MkIUtaMdKsZHMZVVniI2HjMesD6DpOlO363T1/exec";
    
    let videoTrack;
    let isRunning = false;
    let currentFilter = 'none';
    let scanSpeed = 1; 
    let uiHideTimeout;
    
    // Elementos DOM
    const videoBg = document.getElementById('bg-camera-feed');
    const mainFilterCanvas = document.getElementById('main-filter-canvas');
    const mainFilterCtx = mainFilterCanvas.getContext('2d');
    const controlsContainer = document.getElementById('filter-controls-container');
    const logoImage = document.getElementById('logo-image');
    const socialOverlay = document.getElementById('social-overlay');
    
    // Variables Audio/IA/Sensores
    let audioCtx, masterGain, micStreamSource, recognition;
    let programadoData = new Map(), automaticoData = [];
    let magnetometer, proximitySensor, orientationSensor;
    let emfValue = 0, currentTemp = 19.8;
    let poseDetector, latestPoses = [];

    /* --- LOGICA INTERFAZ (BOTONES Y LOGO) --- */
    
    // Funci칩n que muestra los botones y oculta el logo
    function showControls() {
        // Mostrar Botones
        controlsContainer.classList.add('visible');
        
        // Ocultar Logo (L칩gica inversa)
        logoImage.classList.add('hiding');
        
        // Reiniciar temporizador
        clearTimeout(uiHideTimeout);
        uiHideTimeout = setTimeout(hideControls, 2000); // <--- 2 SEGUNDOS EN PANTALLA
    }

    // Funci칩n que oculta botones y muestra logo
    function hideControls() {
        controlsContainer.classList.remove('visible');
        logoImage.classList.remove('hiding'); // Logo vuelve a aparecer
    }

    // Evento de toque en C츼MARA SOLAMENTE
    document.getElementById('main-view-area').addEventListener('click', (e) => {
        // Solo si toca la c치mara directamente, no si toca algo encima
        if (e.target.id === 'bg-camera-feed' || e.target.id === 'main-filter-canvas' || e.target.id === 'main-view-area') {
            showControls();
            // Vibraci칩n leve
            if(navigator.vibrate) navigator.vibrate(10);
        }
    });

    function togglePanels() {
        document.body.classList.toggle('panels-active');
        document.getElementById('btn-panel').classList.toggle('active');
        if(navigator.vibrate) navigator.vibrate(15);
        
        // Si abrimos paneles, aseguramos que los controles sigan visibles un momento
        if(document.body.classList.contains('panels-active')) {
            clearTimeout(uiHideTimeout); // No ocultar autom치ticamente si estamos interactuando
        } else {
            showControls(); // Si cerramos, reiniciamos el timer de 2s
        }
        
        setTimeout(resizeAllCanvas, 500);
    }

    /* --- SOCIAL OVERLAY TIMER --- */
    function startSocialTimer() {
        setInterval(() => {
            socialOverlay.classList.add('visible');
            // Sonido Glitch opcional o vibraci칩n
            if(navigator.vibrate) navigator.vibrate([50, 50, 50]);
            
            // Ocultar despu칠s de 4 segundos
            setTimeout(() => {
                socialOverlay.classList.remove('visible');
            }, 4000);
        }, SOCIAL_INTERVAL_MS);
    }

    /* --- FILTROS Y LINTERNA --- */
    function controlTorch(state) {
        if (!videoTrack) return;
        try {
            const capabilities = videoTrack.getCapabilities();
            if (capabilities.torch) videoTrack.applyConstraints({ advanced: [{ torch: state }] });
        } catch (e) {}
    }

    function setFilter(f) {
        if(navigator.vibrate) navigator.vibrate(15);
        
        // Reset UI
        document.querySelectorAll('.filter-btn').forEach(b => { if(b.id !== 'btn-panel') b.classList.remove('active'); });
        document.body.classList.remove('filter-night', 'filter-sls', 'filter-negative');
        mainFilterCanvas.style.display = 'none';
        document.getElementById('kinect-banner').style.display = 'none';

        if (currentFilter === f) {
            currentFilter = 'none';
            controlTorch(false);
        } else {
            currentFilter = f;
            event.target.classList.add('active');
            document.body.classList.add('filter-' + f);
            
            if (f === 'sls') {
                // LOGICA KINECT ORIGINAL (Sin filtro B/N, solo overlay)
                mainFilterCanvas.style.display = 'block';
                document.getElementById('kinect-banner').style.display = 'block';
                controlTorch(false);
            } else if (f === 'night') {
                controlTorch(true);
            } else {
                controlTorch(false);
            }
        }
        // Mantener controles visibles al cambiar filtro
        showControls();
    }

    /* --- INICIALIZACI칍N --- */
    window.onload = async () => {
        await startCamera();
        await initMLModel();
        detectPoseLoop();
        startVisualLoop();
        initSensors();
        loadSheetData();
        startSocialTimer(); // Inicia el timer de "S칤guenos"
        
        setInterval(() => {
            if(!isRunning) {
                currentTemp += (Math.random()*0.2 - 0.1);
                document.getElementById('temp-val').innerText = currentTemp.toFixed(1)+"춿C";
            }
        }, 2000);
    };

    /* --- C츼MARA --- */
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment", width: {ideal:1920}, height: {ideal:1080} }, audio: false
            });
            videoTrack = stream.getVideoTracks()[0];
            videoBg.srcObject = stream;
            videoBg.onloadedmetadata = () => { resizeAllCanvas(); drawLoop(); };
        } catch (e) { console.log(e); }
    }

    function resizeAllCanvas() {
        mainFilterCanvas.width = document.getElementById('main-view-area').clientWidth;
        mainFilterCanvas.height = document.getElementById('main-view-area').clientHeight;
        const vuC = document.getElementById('vu-meter-container');
        if(vuC) {
            const cv = document.getElementById('vu-meter-canvas');
            cv.width = vuC.clientWidth; cv.height = vuC.clientHeight;
        }
    }

    /* --- IA / KINECT DRAW LOOP --- */
    async function initMLModel() {
        const model = poseDetection.SupportedModels.MoveNet;
        poseDetector = await poseDetection.createDetector(model, {modelType: poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING});
    }

    async function detectPoseLoop() {
        while(true) {
            if(currentFilter === 'sls' && poseDetector && videoBg.readyState >= 2) {
                try { latestPoses = await poseDetector.estimatePoses(videoBg); } catch(e){}
            }
            await new Promise(r => setTimeout(r, 100));
        }
    }

    function drawLoop() {
        mainFilterCtx.clearRect(0, 0, mainFilterCanvas.width, mainFilterCanvas.height);
        
        if (currentFilter === 'sls' && latestPoses.length > 0) {
            // DIBUJAR ESQUELETOS (Verde Cl치sico Kinect)
            mainFilterCtx.strokeStyle = '#39FF14'; 
            mainFilterCtx.lineWidth = 4;
            mainFilterCtx.shadowBlur = 10;
            mainFilterCtx.shadowColor = '#39FF14';
            
            latestPoses.forEach(pose => {
                 pose.keypoints.forEach(kp => {
                     if(kp.score > 0.3) {
                         mainFilterCtx.beginPath(); 
                         mainFilterCtx.arc(kp.x, kp.y, 4, 0, 2*Math.PI); 
                         mainFilterCtx.stroke();
                     }
                 });
                 // Dibujar lineas simples
                 const connections = poseDetection.util.getAdjacentPairs(poseDetection.SupportedModels.MoveNet);
                 connections.forEach(([i, j]) => {
                     const kp1 = pose.keypoints[i];
                     const kp2 = pose.keypoints[j];
                     if(kp1.score > 0.3 && kp2.score > 0.3) {
                         mainFilterCtx.beginPath();
                         mainFilterCtx.moveTo(kp1.x, kp1.y);
                         mainFilterCtx.lineTo(kp2.x, kp2.y);
                         mainFilterCtx.stroke();
                     }
                 });
            });
        }
        requestAnimationFrame(drawLoop);
    }

    /* --- M칍DULOS RESTANTES (Sensores, Spirit Box, Carga) --- */
    // (Simplificado para mantener el c칩digo limpio, l칩gica id칠ntica a versi칩n anterior)
    function initSensors() {
        try {
            orientationSensor = new AbsoluteOrientationSensor({ frequency: 10 });
            orientationSensor.onreading = () => {
                let q = orientationSensor.quaternion;
                let yaw = Math.atan2(2 * (q[0] * q[1] + q[2] * q[3]), 1 - 2 * (q[1] * q[1] + q[2] * q[2])) * (180 / Math.PI);
                document.getElementById('compass-needle').style.transform = `translateX(-50%) rotate(${-yaw}deg)`;
            };
            orientationSensor.start();
        } catch(e){}
        startEmfSimulation(); // Fallback EMF
    }
    
    function startEmfSimulation() {
        setInterval(() => { emfValue = Math.random() * 20; }, 200);
    }
    function startVisualLoop() {
        setInterval(() => {
            const needle = document.getElementById('main-needle');
            if(needle) needle.style.transform = `translateX(-50%) rotate(${-60 + (emfValue/100)*120}deg)`;
        }, 100);
    }
    
    // Spirit Box UI Events
    document.getElementById('knob-power').addEventListener('click', function() {
        isRunning = !isRunning;
        this.classList.toggle('active', isRunning);
        if(isRunning) { if(navigator.vibrate) navigator.vibrate([10,30,10]); }
    });
    document.getElementById('knob-scan').addEventListener('click', function() {
        this.classList.toggle('active');
    });
    
    async function loadSheetData() {
        try { await fetch(GOOGLE_SCRIPT_URL); } catch(e){}
    }
</script>
</body>
</html>
