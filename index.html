<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>DETECTOR-OBR v7.5 MERGED</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@500;700;900&family=Creepster&display=swap" rel="stylesheet">

<!-- TFJS + MoveNet (SLS) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

<style>
:root{
  --hud-bg:#050510; --hud-cyan:#00f3ff; --hud-green:#00ff41;
  --hud-orange:#ffae00; --hud-red:#ff3333; --glass-panel:rgba(6,10,20,0.96);
  --panel-w: 360px; --panel-h: 150px;
}

/* Base layout */
body{margin:0; font-family:'Share Tech Mono',monospace; background:var(--hud-bg); color:var(--hud-cyan); overflow:hidden}
#app-ui{width:100vw;height:100vh;position:relative;touch-action:none}

/* Camera area */
#main-view-area{position:fixed;top:0;left:0;width:100%;height:100%;z-index:5;background:#000;transition:all .35s}
#bg-camera-feed{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);min-width:100%;min-height:100%;object-fit:cover;z-index:1}

/* Filter canvases */
#main-filter-canvas,#gl-bluewave{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;display:none}
body.filter-sls #main-filter-canvas{display:block;z-index:4}
body.filter-spectral #gl-bluewave{display:block;z-index:4;mix-blend-mode:screen}

/* Panels */
#left-panel,#bottom-panel{position:fixed;display:flex;flex-direction:column;z-index:20;pointer-events:none;transition:transform .35s;background:var(--glass-panel);backdrop-filter: blur(6px);border:1px solid rgba(0,243,255,0.12)}
body.panels-active #left-panel, body.panels-active #bottom-panel{pointer-events:auto;transform:none}

/* make panels prominent when active */
#left-panel{top:0;left:0;width:var(--panel-w);height:100vh;transform:translateX(-100%)}
#bottom-panel{right:20px;bottom:20px;width:calc(100% - var(--panel-w) - 60px);height:var(--panel-h);transform:translateY(110%)}

/* Panel internals */
.panel{padding:10px; display:flex; flex-direction:column; gap:8px; box-sizing:border-box}
.section-title{font-family:'Orbitron';font-size:0.7rem;font-weight:800;color:var(--hud-cyan);text-transform:uppercase;border-bottom:1px solid rgba(0,243,255,0.08);padding-bottom:4px}

/* SENSORS - give prominence */
#sensors-section{border:2px solid rgba(0,255,65,0.06);background:linear-gradient(90deg, rgba(0,0,0,0.25), rgba(0,0,0,0.1));padding:8px;border-radius:6px;box-shadow:0 6px 30px rgba(0,255,65,0.03)}
.sensor-row{display:flex;justify-content:space-between;align-items:center;font-size:0.8rem;padding:6px;border-radius:6px;background:rgba(255,255,255,0.02)}
.sensor-led{width:10px;height:10px;border-radius:50%;background:#222;margin-right:8px;box-shadow:0 0 6px rgba(0,0,0,0.3)}
.sensor-label{display:flex;align-items:center;gap:8px}

/* Spirit box prominence */
#spirit-box-section{border:2px solid rgba(0,255,65,0.12);background:linear-gradient(180deg, rgba(0,20,0,0.25), rgba(0,0,0,0.1));padding:10px;border-radius:8px;box-shadow:0 8px 40px rgba(0,255,65,0.05)}
.voice-led{width:16px;height:16px;border-radius:50%;background:#111;border:2px solid #333;transition:all .12s}
.voice-led.listening{background:var(--hud-green);box-shadow:0 0 18px var(--hud-green), inset 0 0 8px #fff}

/* Spirit controls bigger */
.control-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.btn-control{background:#111;border:1px solid #333;color:#ddd;padding:10px;font-family:'Orbitron';cursor:pointer}
.pwr-on{border-color:var(--hud-green);color:var(--hud-green);background:rgba(0,40,0,0.45)}
.spd-1{border-color:var(--hud-blue);color:var(--hud-blue)}
.spd-2{border-color:var(--hud-orange);color:var(--hud-orange)}
.spd-3{border-color:var(--hud-red);color:var(--hud-red)}

/* Dials - enlarge MAG & EMF */
.dials-grid{display:grid;grid-template-columns:120px 120px 1fr 1fr;gap:10px;align-items:center;height:100%}
.dial-wrapper{text-align:center}
.dial-container{width:106px;height:106px;border-radius:50%;background:#07070b;border:1px solid #111;display:flex;align-items:center;justify-content:center;position:relative;box-shadow:inset 0 0 20px rgba(0,0,0,0.6)}
.dial-needle{position:absolute;width:3px;height:36px;background:#fff;bottom:50%;left:50%;transform-origin:bottom center;transform:translateX(-50%) rotate(-45deg);transition:transform .25s}

/* TEMP: digital retro */
.temp-digital{font-family:'Orbitron';background:#020202;border:1px solid rgba(255,255,255,0.04);padding:6px;border-radius:6px;color:#ff7f00;font-size:1.5rem;letter-spacing:2px;text-align:center;box-shadow:0 6px 24px rgba(255,127,0,0.06)}
.knob-label{font-size:0.75rem;color:var(--hud-cyan);margin-top:6px;font-weight:700}

/* ENERGY: small compact container */
#energy-display{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:6px;background:rgba(0,0,0,0.18);border-radius:6px}
#energy-bars-container{width:100%;height:46px;display:flex;gap:4px;align-items:flex-end}
.energy-bar{flex:1;height:6%;background:linear-gradient(to top,var(--hud-green),var(--hud-orange),var(--hud-red));transition:height .06s ease;opacity:0.95;border-radius:2px}

/* Filter controls */
#filter-controls-container{position:fixed;top:50%;right:14px;transform:translateY(-50%);display:flex;flex-direction:column;gap:8px;z-index:100}
.filter-btn{width:48px;height:42px;background:rgba(0,10,20,0.9);border:1px solid var(--hud-cyan);color:var(--hud-cyan);cursor:pointer;border-radius:6px}
.filter-btn.active{background:var(--hud-cyan);color:#000}

/* Loading + rec */
#loading-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;background:radial-gradient(#111,#000)}
#rec-indicator{position:absolute;top:18px;left:18px;color:var(--hud-red);font-family:'Orbitron';z-index:50;display:flex;align-items:center;gap:8px}

/* ui hiding */
.ui-hiding{opacity:0;transform:scale(.98);filter:blur(3px);transition:all .35s}

/* responsive tweaks */
@media (max-aspect-ratio:1/1){ .dials-grid{grid-template-columns:80px 80px 1fr 1fr} .dial-container{width:70px;height:70px}.dial-needle{height:24px} }
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading-overlay">
  <div style="text-align:center;color:var(--hud-cyan)">
    <img src="obr-logo.png" style="width:80px;margin-bottom:12px"><div>CARGANDO <span id="load-percent">0%</span></div>
    <div style="width:220px;height:6px;background:#111;margin:10px auto;border-radius:4px"><div id="loading-bar" style="width:0%;height:100%;background:var(--hud-cyan)"></div></div>
    <button id="enter-btn" onclick="enterApp()" style="margin-top:8px;padding:8px 18px;border:2px solid var(--hud-green);background:transparent;color:var(--hud-green);display:none">INGRESAR</button>
  </div>
</div>

<div id="app-ui" onclick="handleUITap(event)">
  <div id="main-view-area">
    <video id="bg-camera-feed" playsinline autoplay muted></video>
    <canvas id="main-filter-canvas"></canvas>
    <canvas id="gl-bluewave"></canvas>
    <div id="camera-frame"></div>

    <div id="rec-indicator"><div style="width:10px;height:10px;border-radius:50%;background:var(--hud-red);box-shadow:0 0 6px var(--hud-red)"></div><div style="font-family:Orbitron">[ REC ]</div></div>

    <div id="follow-banner" style="position:absolute;bottom:28px;left:50%;transform:translateX(-50%);opacity:0;pointer-events:none">
      <div style="display:flex;gap:18px;margin-bottom:6px">
        <!-- icons... -->
      </div>
      <div style="font-family:'Creepster';color:#ff0000">@EXPLORACIONESOBR</div>
    </div>
  </div>

  <!-- LEFT PANEL -->
  <div id="left-panel">
    <div class="panel">
      <div id="sensors-section">
        <div class="section-title">SENSORES (REQUIRED)</div>
        <div class="sensor-row"><div class="sensor-label"><div id="led-mag" class="sensor-led"></div><div>üß≠ MAG/GIRO</div></div><div id="val-mag" style="color:#aaa">OFF</div></div>
        <div class="sensor-row"><div class="sensor-label"><div id="led-acc" class="sensor-led"></div><div>üì° ACELER√ìMETRO</div></div><div id="val-acc" style="color:#aaa">OFF</div></div>
        <div class="sensor-row"><div class="sensor-label"><div id="led-prox" class="sensor-led"></div><div>üì∂ PROXIMIDAD</div></div><div id="val-prox" style="color:#aaa">OFF</div></div>
        <div class="sensor-row"><div class="sensor-label"><div id="led-mic" class="sensor-led"></div><div>üéôÔ∏è MICR√ìFONO</div></div><div id="val-mic" style="color:#aaa">OFF</div></div>
      </div>

      <div id="spirit-box-section" style="margin-top:8px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="section-title" style="margin:0;border:none;color:var(--hud-green);font-size:0.9rem">SPIRIT BOX</div>
          <div id="voice-led" class="voice-led" title="Escuchando / hablando"></div>
        </div>

        <div class="control-grid" style="margin-top:8px">
          <button id="btn-pwr" class="btn-control" onclick="toggleSpirit()">OFF</button>
          <button id="btn-spd" class="btn-control spd-1" onclick="cycleSpeed()">SPD 1</button>
        </div>

        <div style="margin-top:8px">
          <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:#aaa"><span>VOL</span><span id="vol-txt">100%</span></div>
          <input id="vol-slider" type="range" min="0" max="100" value="100" style="width:100%">
        </div>

        <div style="margin-top:8px;font-size:0.8rem;color:#ccc">Estado de sensores: <span id="sensors-ok" style="color:var(--hud-orange)">Verificando...</span></div>
      </div>
    </div>
  </div>

  <!-- BOTTOM PANEL -->
  <div id="bottom-panel">
    <div class="panel">
      <div class="dials-grid">
        <div class="dial-wrapper">
          <div class="dial-container"><div id="compass-needle" class="dial-needle"></div></div>
          <div class="knob-label">MAG</div>
        </div>

        <div class="dial-wrapper">
          <div class="dial-container"><div id="emf-needle" class="dial-needle"></div></div>
          <div class="knob-label">EMF</div>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-start">
          <div class="temp-digital" id="temp-disp">--¬∞</div>
          <div class="knob-label">TEMP</div>
        </div>

        <div id="energy-display">
          <div style="font-size:0.8rem;font-weight:700;color:var(--hud-cyan);margin-bottom:6px;text-align:center">ENERGY</div>
          <div id="energy-bars-container"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- FILTER CONTROLS -->
  <div id="filter-controls-container">
    <button class="filter-btn" onclick="toggleFilter('night-vision')">NVG</button>
    <button class="filter-btn" onclick="toggleFilter('sls')">SLS</button>
    <button class="filter-btn" onclick="toggleFilter('negative')">NEG</button>
    <button class="filter-btn" onclick="toggleFilter('spectral')">SPEC</button>
    <button class="filter-btn" id="btn-panel" onclick="togglePanels()">HUD</button>
  </div>
</div>

<script>
/* ------------- CONFIG / DATA ------------- */
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzOf3crQxBdPylwMTAd34W-nBShN31MkIUtaMdKsZHMZVVniI2HjMesD6DpOlO363T1/exec";
/* Audio fondo (opcional) */
const BACKGROUND_AUDIO = "FONDO_1.mp3";

/* ------------- STATE ------------- */
let audioCtx, masterGain, micSource, analyser;
let bgNode, bgGain, bgBuffer;
let recognition=null, isSpiritOn=false, speed=1;
let autoData = [], progData = new Map();
let videoTrack=null, currentFilter='none', uiVisible=false;
let poseDetector=null, latestPoses=[];
let proxSensor=null, proxAvailable=false;
let sensorsStatus = {mag:false,acc:false,prox:false,mic:false};
let energyBars = [];
const DISPLAY_BARS = 16;   // we will render 16 bars, but use 8 main bins (two drawn per bin)
const EFFECTIVE_BINS = 8;  // the 8 logical bins

/* ---------- UI refs ---------- */
const vid = document.getElementById('bg-camera-feed');
const canvasSLS = document.getElementById('main-filter-canvas');
const ctxSLS = canvasSLS.getContext('2d');
const energyContainer = document.getElementById('energy-bars-container');

/* --- build energy bars (16) --- */
(function createEnergyBars(){
  energyContainer.innerHTML='';
  for(let i=0;i<DISPLAY_BARS;i++){
    const b = document.createElement('div');
    b.className='energy-bar';
    b.style.height='6%';
    energyContainer.appendChild(b);
    energyBars.push(b);
  }
})();

/* ------------- LOAD & START ------------- */
window.onload = () => {
  let p=0;
  const bar = document.getElementById('loading-bar');
  const txt = document.getElementById('load-percent');
  const btn = document.getElementById('enter-btn');
  let t = setInterval(()=>{ p+=8; if(p>100)p=100; bar.style.width=p+'%'; txt.innerText=p+'%';
    if(p===100){ clearInterval(t); setTimeout(()=>{ btn.style.display='inline-block'; document.getElementById('load-percent').innerText='LISTO';},250); }
  },80);
};

/* ------------- ENTER APP ------------- */
async function enterApp(){
  document.getElementById('loading-overlay').style.display='none';
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  masterGain = audioCtx.createGain(); masterGain.connect(audioCtx.destination);
  // load background audio if present
  try{ bgBuffer = await loadAudio(BACKGROUND_AUDIO); }catch(e){/*ignore*/}

  await initMic();
  await startCam();
  await initMoveNet();            // SLS integrated
  initSensors(); initProximity();
  loadData(); // google sheet
  loop();
}

/* ------------- CAMERA ------------- */
async function startCam(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment", width:{ideal:1280},height:{ideal:720}}, audio:false});
    vid.srcObject = s; videoTrack = s.getVideoTracks()[0];
    vid.onloadedmetadata = () => { resizeAll(); }
    window.addEventListener('resize', resizeAll);
  }catch(e){ console.warn("Camera error",e); }
}
function resizeAll(){
  canvasSLS.width = window.innerWidth; canvasSLS.height = window.innerHeight;
}

/* ------------- FILTERS (no longer clear panels) ------------- */
async function toggleFilter(f){
  // if same -> turn off
  if(currentFilter===f){ deactivateAllFilters(); return; }
  // update UI button active states
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  const btn = document.querySelector(`button[onclick="toggleFilter('${f}')"]`);
  if(btn) btn.classList.add('active');

  // apply body classes without wiping other classes (so panels remain)
  document.body.classList.remove('filter-night-vision','filter-negative','filter-sls','filter-spectral');
  document.body.classList.add('filter-'+f);

  // individual effects
  if(f==='sls') canvasSLS.style.display='block'; else canvasSLS.style.display='none';
  if(f==='spectral' && window.BlueWave) window.BlueWave.start(); else if(window.BlueWave) window.BlueWave.stop();

  // try torch if available
  if(videoTrack){
    try{ await videoTrack.applyConstraints({advanced:[{torch: f==='night-vision'}]}); }catch(e){}
  }
  currentFilter = f;
}
async function deactivateAllFilters(){
  document.body.classList.remove('filter-night-vision','filter-negative','filter-sls','filter-spectral');
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  canvasSLS.style.display='none';
  if(window.BlueWave) window.BlueWave.stop();
  currentFilter='none';
}

/* ------------- PANELS ------------- */
function togglePanels(){
  document.body.classList.toggle('panels-active');
  document.getElementById('btn-panel').classList.toggle('active');
  setTimeout(resizeAll,450);
}

/* ------------- SENSORS (force usage) ------------- */
function initSensors(){
  let magOk=false, accOk=false;

  // DeviceOrientation (mag)
  if(window.DeviceOrientationEvent){
    const handler = (e) => {
      if(e.alpha !== null){
        magOk = true; sensorsStatus.mag = true;
        document.getElementById('compass-needle').style.transform = `translateX(-50%) rotate(${-e.alpha}deg)`;
        document.getElementById('val-mag').innerText = Math.round(e.alpha) + '¬∞';
        document.getElementById('led-mag').style.background = 'var(--hud-green)';
      }
    };
    window.addEventListener('deviceorientation', handler, true);
  }

  // DeviceMotion (acc / emf)
  if(window.DeviceMotionEvent){
    const hm = (e) => {
      const a = e.accelerationIncludingGravity;
      if(a){
        accOk = true; sensorsStatus.acc = true;
        let t = Math.abs(a.x||0)+Math.abs(a.y||0)+Math.abs(a.z||0);
        document.getElementById('val-acc').innerText = t.toFixed(1);
        // simple EMF needle mapping
        let rot = ((t*10)%180)-90;
        document.getElementById('emf-needle').style.transform = `translateX(-50%) rotate(${rot}deg)`;
        document.getElementById('led-acc').style.background = 'var(--hud-blue)';
      }
    };
    window.addEventListener('devicemotion', hm, true);
  }

  // Mic availability indicated in initMic -> sensorsStatus.mic
  // Evaluate required sensors after short timeout
  setTimeout(()=> evaluateSensorsRequirement(), 900);
}

function evaluateSensorsRequirement(){
  // force sensors: require mag + acc + prox + mic
  const ok = sensorsStatus.mag && sensorsStatus.acc && sensorsStatus.prox && sensorsStatus.mic;
  const statusEl = document.getElementById('sensors-ok');
  if(ok){
    statusEl.innerText = 'OK'; statusEl.style.color = 'var(--hud-green)';
    // enable spirit actions if previously disabled
  } else {
    statusEl.innerText = 'FALTA(S)'; statusEl.style.color = 'var(--hud-orange)';
    // if prox missing, keep trying; if permanently missing, show small note
    console.warn("Sensores faltantes", sensorsStatus);
  }
}

/* ------------- PROXIMITY (turn screen off when near ear) ------------- */
function initProximity(){
  // Try modern ProximitySensor
  if('ProximitySensor' in window){
    try{
      proxSensor = new ProximitySensor();
      proxSensor.addEventListener('reading', () => {
        sensorsStatus.prox = true;
        document.getElementById('val-prox').innerText = proxSensor.distance.toFixed(1) + 'cm';
        document.getElementById('led-prox').style.background = proxSensor.distance < 6 ? 'var(--hud-red)' : 'var(--hud-green)';
        if(proxSensor.distance < 6) { screenOff(true); } else { screenOff(false); }
      });
      proxSensor.addEventListener('error', e=>console.warn('prox err',e));
      proxSensor.start();
      proxAvailable = true;
    }catch(e){ proxAvailable = false; }
  }

  // Fallback: userproximity event (older)
  if(!proxAvailable && 'onuserproximity' in window){
    window.addEventListener('userproximity', (ev)=> {
      sensorsStatus.prox = true;
      document.getElementById('val-prox').innerText = ev.near ? 'CERCA' : 'LEJOS';
      document.getElementById('led-prox').style.background = ev.near ? 'var(--hud-red)' : 'var(--hud-green)';
      if(ev.near) screenOff(true); else screenOff(false);
    });
    proxAvailable = true;
  }

  // If none available, update UI and still allow simulation
  if(!proxAvailable){
    document.getElementById('val-prox').innerText = 'NO DISP';
    document.getElementById('led-prox').style.background = '#444';
    sensorsStatus.prox = false;
  }
}

function screenOff(off){
  // hide camera feed / dim overlay to simulate screen off
  const main = document.getElementById('main-view-area');
  if(off){
    // reduce visibility and pause video to save power
    main.style.opacity = '0.02';
    try{ if(vid && vid.pause) vid.pause(); }catch(e){}
  } else {
    main.style.opacity = '1';
    try{ if(vid && vid.play) vid.play(); }catch(e){}
  }
}

/* ------------- MICROPHONE + SPIRIT BOX ------------- */
async function loadAudio(u){ try{ const r = await fetch(u); const b = await r.arrayBuffer(); return await audioCtx.decodeAudioData(b);}catch(e){return null;} }

async function initMic(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({audio:true});
    micSource = audioCtx.createMediaStreamSource(s);
    analyser = audioCtx.createAnalyser(); analyser.fftSize = 256;
    micSource.connect(analyser);
    sensorsStatus.mic = true;
    document.getElementById('val-mic').innerText = 'ON';
    document.getElementById('led-mic').style.background = 'var(--hud-green)';
    evaluateSensorsRequirement();
    // do NOT auto-init recognition here permanently; start when spirit on
  }catch(e){
    sensorsStatus.mic = false;
    document.getElementById('val-mic').innerText = 'ERR';
    document.getElementById('led-mic').style.background = '#444';
  }
}

/* SPIRIT BOX control */
function toggleSpirit(){
  isSpiritOn = !isSpiritOn;
  const btn = document.getElementById('btn-pwr');
  const led = document.getElementById('voice-led');

  if(isSpiritOn){
    // require sensors
    if(!(sensorsStatus.mag && sensorsStatus.acc && sensorsStatus.mic)){
      alert('Se requieren sensores MAG, EMF y MIC para activar Spirit Box. Revisa permisos / sensores.');
      isSpiritOn = false; return;
    }

    btn.innerText = 'ON'; btn.classList.add('pwr-on');
    // background audio
    try{
      if(bgBuffer){
        bgNode = audioCtx.createBufferSource(); bgNode.buffer = bgBuffer; bgNode.loop = true;
        bgGain = audioCtx.createGain(); bgGain.gain.value = 0.6;
        bgNode.connect(bgGain); bgGain.connect(masterGain); bgNode.start();
      }
    }catch(e){ console.warn(e); }
    startAutoLoop();
    startRecognition();
  } else {
    btn.innerText = 'OFF'; btn.classList.remove('pwr-on');
    if(bgNode){ try{ bgNode.stop(); }catch(e){} bgNode=null; }
    stopRecognition();
    window.speechSynthesis.cancel();
  }
}

/* speed toggle */
function cycleSpeed(){ speed++; if(speed>3) speed=1; const b=document.getElementById('btn-spd'); b.innerText='SPD '+speed; b.className='btn-control spd-'+speed; }

/* Auto random loop (uses autoData) */
function startAutoLoop(){
  if(!isSpiritOn) return;
  let baseDelay = 15000;
  if(speed===2) baseDelay=8000; if(speed===3) baseDelay=3000;
  const delay = baseDelay + Math.random()*5000;
  setTimeout(()=>{ if(isSpiritOn && autoData.length>0 && !window.speechSynthesis.speaking){ speak(autoData[Math.floor(Math.random()*autoData.length)]);} startAutoLoop(); }, delay);
}

/* Recognition: robust restart + continuous handling */
function startRecognition(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) { console.warn('SpeechRecognition no disponible'); return; }
  if(recognition){ try{ recognition.abort(); }catch(e){} recognition=null; }

  recognition = new SR();
  recognition.lang = 'es-MX';
  recognition.interimResults = false;
  recognition.continuous = true;

  recognition.onstart = ()=> { document.getElementById('voice-led').classList.add('listening'); };
  recognition.onend = ()=> {
    document.getElementById('voice-led').classList.remove('listening');
    // auto-restart if spirit still on
    if(isSpiritOn) setTimeout(()=>{ try{ recognition.start(); }catch(e){} }, 400);
  };
  recognition.onerror = (ev)=>{ console.warn('rec err',ev); };
  recognition.onresult = (ev)=> {
    if(!isSpiritOn) return;
    const last = ev.results[ev.results.length-1];
    const text = last[0].transcript.toLowerCase().trim();
    // check programmed responses (progData) then fallback to autoData
    if(progData.has(text)){
      speak(progData.get(text));
    } else {
      // small chance to use programmed random else fallback automatico
      if(autoData.length>0) speak(autoData[Math.floor(Math.random()*autoData.length)]);
    }
  };

  try{ recognition.start(); }catch(e){ console.warn('start rec fail',e); }
}

function stopRecognition(){
  if(!recognition) return;
  try{ recognition.onend = null; recognition.stop(); }catch(e){}
  document.getElementById('voice-led').classList.remove('listening');
  recognition = null;
}

/* speak with background ducking */
function speak(txt){
  if(!window.speechSynthesis) return;
  if(bgGain) bgGain.gain.setTargetAtTime(0.2, audioCtx.currentTime, 0.05);
  document.getElementById('voice-led').classList.remove('listening');

  const u = new SpeechSynthesisUtterance(txt);
  u.lang = 'es-MX'; u.rate = 0.85 + (speed*0.05);
  u.onend = ()=>{ if(bgGain) bgGain.gain.setTargetAtTime(0.6, audioCtx.currentTime, 0.3); if(isSpiritOn) { try{ recognition.start(); }catch(e){} } };
  window.speechSynthesis.speak(u);
}

/* ------------- ENERGY DRAWING (8 bins -> 16 bars) ------------- */
function drawEnergy(){
  if(!analyser) return;
  const freqCount = analyser.frequencyBinCount;
  const data = new Uint8Array(freqCount);
  analyser.getByteFrequencyData(data);

  // compute EFFECTIVE_BINS bins by averaging frequency ranges
  const binSize = Math.floor(freqCount / EFFECTIVE_BINS);
  for(let b=0;b<EFFECTIVE_BINS;b++){
    let sum=0; let start = b*binSize; let end = start + binSize;
    for(let j=start;j<end && j<data.length;j++) sum += data[j];
    const avg = sum / (end-start || 1);
    // normalize height
    const h = Math.max(6, (avg/255)*100); // percent
    // set two visual bars: first full h, second half for variation
    const idx = b*2;
    if(energyBars[idx]) energyBars[idx].style.height = h + '%';
    if(energyBars[idx+1]) energyBars[idx+1].style.height = Math.max(4, h*0.5) + '%';
  }
}

/* ------------- LOOP ------------- */
let lastFps = performance.now(), frames=0;
function loop(){
  frames++;
  if(performance.now() - lastFps >= 1000){
    document.getElementById('f-res').innerText = vid.videoWidth + 'x' + vid.videoHeight;
    frames=0; lastFps = performance.now();
  }

  // SLS overlay when active
  if(currentFilter==='sls' && latestPoses.length>0){
    ctxSLS.clearRect(0,0,canvasSLS.width,canvasSLS.height);
    drawSLS(latestPoses);
  }

  drawEnergy();
  requestAnimationFrame(loop);
}

/* ------------- LOAD DATA (Google Sheets) ------------- */
async function loadData(){
  try{
    const r = await fetch(GOOGLE_SCRIPT_URL);
    const d = await r.json();
    autoData = (d.automatico||[]).map(x=>x.TEXTO).filter(Boolean);
    (d.programado||[]).forEach(i=>{ if(i.PREGUNTA) progData.set(i.PREGUNTA.toLowerCase().trim(), i.RESPUESTA); });
  }catch(e){ console.warn('load data',e); }
}

/* ------------- SLS / MoveNet (integrated) ------------- */
async function initMoveNet(){
  try{
    await tf.ready();
    const model = poseDetection.SupportedModels.MoveNet;
    poseDetector = await poseDetection.createDetector(model, { modelType: poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING });
    // polling loop for poses only when SLS filter active
    setInterval(async ()=>{
      if(currentFilter==='sls' && vid.readyState>=2 && poseDetector){
        latestPoses = await poseDetector.estimatePoses(vid);
      } else {
        latestPoses = [];
      }
    }, 120);
  }catch(e){ console.warn('MoveNet init error',e); }
}

const connections = [['left_shoulder','right_shoulder'],['left_shoulder','left_hip'],['right_shoulder','right_hip'],['left_hip','right_hip'],['left_shoulder','left_elbow'],['left_elbow','left_wrist'],['right_shoulder','right_elbow'],['right_elbow','right_wrist'],['left_hip','left_knee'],['left_knee','left_ankle'],['right_hip','right_knee'],['right_knee','right_ankle']];

function drawSLS(poses){
  const vidW = vid.videoWidth, vidH = vid.videoHeight;
  const canW = canvasSLS.width, canH = canvasSLS.height;
  const scale = Math.max(canW/vidW, canH/vidH);
  const xo = (canW - vidW*scale)/2, yo = (canH - vidH*scale)/2;
  ctxSLS.lineWidth = 3; ctxSLS.lineCap = 'round'; ctxSLS.strokeStyle = '#00ff41'; ctxSLS.shadowBlur = 12; ctxSLS.shadowColor = '#00ff41';
  poses.forEach(p=>{
    if(!p || p.score < 0.25) return;
    const kp = p.keypoints || [];
    const m = {}; kp.forEach(k=>m[k.name]=k);
    ctxSLS.beginPath();
    connections.forEach(([a,b])=>{
      const p1 = m[a], p2 = m[b];
      if(p1 && p2 && p1.score>0.3 && p2.score>0.3){
        ctxSLS.moveTo(p1.x * scale + xo, p1.y * scale + yo);
        ctxSLS.lineTo(p2.x * scale + xo, p2.y * scale + yo);
      }
    });
    ctxSLS.stroke();
    ctxSLS.fillStyle = '#ff0055';
    kp.forEach(k=>{ if(k.score>0.3){ ctxSLS.beginPath(); ctxSLS.arc(k.x*scale+xo, k.y*scale+yo, 4, 0, Math.PI*2); ctxSLS.fill(); }});
  });
}

/* ------------- HELPERS ------------- */
function handleUITap(e){
  if(e.target.closest('.panel') || e.target.closest('.filter-btn') || e.target.closest('input') || e.target.closest('button')) return;
  uiVisible = !uiVisible;
  if(uiVisible) showUI(); else hideUI();
}
let hideTO;
function showUI(){
  document.getElementById('filter-controls-container').style.opacity=1;
  document.getElementById('filter-controls-container').style.pointerEvents='auto';
  document.getElementById('left-panel').classList.remove('ui-hiding');
  document.getElementById('follow-banner').classList.remove('ui-hiding');
  clearTimeout(hideTO); hideTO = setTimeout(hideUI,5000);
}
function hideUI(){
  document.getElementById('filter-controls-container').style.opacity=0;
  document.getElementById('filter-controls-container').style.pointerEvents='none';
  document.getElementById('left-panel').classList.add('ui-hiding');
  document.getElementById('follow-banner').classList.add('ui-hiding');
}

/* ------------- Start/stop recognition helpers for external calls ------------- */
function startRecognition(){ if(!recognition) startRecognition(); }
function stopRecognition(){ if(recognition) stopRecognition(); }

/* ------------- Utility load audio (visible) ------------- */
async function loadAudio(url){
  if(!audioCtx) return null;
  try{ const res = await fetch(url); const ab = await res.arrayBuffer(); return await audioCtx.decodeAudioData(ab); }catch(e){ console.warn('audio load',e); return null; }
}

/* ------------- Wire volume slider ------------- */
document.getElementById('vol-slider').addEventListener('input', (e) => {
  const v = Number(e.target.value)/100;
  if(masterGain) masterGain.gain.value = v;
  document.getElementById('vol-txt').innerText = Math.round(v*100) + '%';
});

/* ------------- Load initial data silently ------------- */
loadData();
</script>

<!-- BlueWave spectral shader (kept) -->
<script>
(function(){
  let gl,p,pl,tl,t,active=false; const c=document.getElementById("gl-bluewave"), v=document.getElementById("bg-camera-feed");
  function i(){
    gl=c.getContext("webgl"); if(!gl) return;
    const vs=cs(gl,35633,`attribute vec2 p;attribute vec2 t;varying vec2 vt;void main(){gl_Position=vec4(p,0,1);vt=t;}`);
    const fs=cs(gl,35632,`precision mediump float;uniform sampler2D u;uniform float m;varying vec2 vt;void main(){vec2 uv=vt;uv.x+=sin(uv.y*10.0+m)*0.01;vec4 c=texture2D(u,uv);float g=c.g*0.5+c.b*0.5;gl_FragColor=vec4(0.0, g*0.8, g*1.5, 1.0);}`);
    p=cp(gl,vs,fs);pl=gl.getAttribLocation(p,"p");tl=gl.getAttribLocation(p,"t");
    gl.bindBuffer(34962,gl.createBuffer()); gl.bufferData(34962,new Float32Array([-1,-1,-1,1,1,-1,1,-1,-1,1,1,1]),35044);
    gl.bindBuffer(34962,gl.createBuffer()); gl.bufferData(34962,new Float32Array([0,1,0,0,1,1,1,1,0,0,1,0]),35044);
    t=gl.createTexture(); gl.bindTexture(3553,t); gl.texParameteri(3553,10242,33071); gl.texParameteri(3553,10243,33071); gl.texParameteri(3553,10241,9729);
  }
  function r(tm){
    if(!active) return; if(!gl) i();
    c.width=window.innerWidth; c.height=window.innerHeight; gl.viewport(0,0,c.width,c.height);
    gl.useProgram(p);
    gl.enableVertexAttribArray(pl); gl.bindBuffer(34962,gl.createBuffer()); gl.bufferData(34962,new Float32Array([-1,-1,-1,1,1,-1,1,-1,-1,1,1,1]),35044); gl.vertexAttribPointer(pl,2,5126,false,0,0);
    gl.enableVertexAttribArray(tl); gl.bindBuffer(34962,gl.createBuffer()); gl.bufferData(34962,new Float32Array([0,1,0,0,1,1,1,1,0,0,1,0]),35044); gl.vertexAttribPointer(tl,2,5126,false,0,0);
    gl.bindTexture(3553,t); if(v.readyState>=2) gl.texImage2D(3553,0,6408,6408,5121,v);
    gl.uniform1f(gl.getUniformLocation(p,"m"),tm*0.002);
    gl.drawArrays(4,0,6); requestAnimationFrame(r);
  }
  function cs(g,y,s){const x=g.createShader(y);g.shaderSource(x,s);g.compileShader(x);return x;}
  function cp(g,v,f){const x=g.createProgram(); let s=g.createShader(35633); g.shaderSource(s,v); g.compileShader(s); g.attachShader(x,s); s=g.createShader(35632); g.shaderSource(s,f); g.compileShader(s); g.attachShader(x,s); g.linkProgram(x); return x;}
  window.BlueWave = { start:()=>{ active=true; r(0); }, stop:()=>{ active=false; }, resize:()=>{ if(c){c.width=window.innerWidth; c.height=window.innerHeight;} } };
})();
</script>

</body>
</html>
