<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GhostTube Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --glow-color: #00FFFF; 
            --panel-bg: rgba(10, 15, 20, 0.9);
            --neon-green: #00FF00; 
            --alert-red: #FF3333;
        }
        
        body {
            font-family: 'Orbitron', sans-serif;
            background-color: #000;
            color: var(--glow-color);
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- Fondo de Cámara (NITIDO) --- */
        #bg-camera-feed {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            filter: brightness(0.6); 
        }

        /* --- Título Superior --- */
        .header-title {
            position: relative;
            z-index: 20;
            margin-top: 20px;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--glow-color);
            text-shadow: 0 0 10px var(--glow-color);
            text-align: center;
            letter-spacing: 1px;
            width: 100%;
            pointer-events: none;
        }

        /* --- Contenedor de Paneles --- */
        .bottom-container {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            height: auto;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding: 0 20px;
            pointer-events: none;
        }

        .panels-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            width: 100%;
            max-width: 1200px;
            pointer-events: auto;
        }

        .panel {
            background: var(--panel-bg);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 20px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.8), inset 0 0 20px rgba(0, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            padding: 15px;
            height: 320px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .panel.hidden { display: none; }

        .panel-header {
            font-size: 0.8rem;
            text-align: center;
            margin-bottom: 10px;
            color: var(--glow-color);
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
            padding-bottom: 5px;
        }

        /* --- PANEL 1: CÁMARA --- */
        .camera-view-box {
            flex-grow: 1;
            background: #000;
            border-radius: 10px;
            border: 1px solid #333;
            position: relative;
            overflow: hidden;
            margin-bottom: 10px;
        }
        #ghosttube-canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .camera-controls {
            display: flex;
            justify-content: space-between;
            gap: 5px;
        }
        .cam-btn {
            background: transparent;
            border: 1px solid var(--glow-color);
            color: var(--glow-color);
            font-size: 0.6rem;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            flex: 1;
            transition: all 0.2s;
            font-family: 'Share Tech Mono', monospace;
        }
        .cam-btn.active {
            background: var(--glow-color);
            color: #000;
            font-weight: bold;
            box-shadow: 0 0 10px var(--glow-color);
        }

        /* --- PANEL 2: DETECTOR --- */
        .emf-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            justify-content: space-between;
        }
        .vu-section {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 0 5px;
        }
        .vu-box {
            width: 48%;
            height: 30px;
            background: #111;
            border: 1px solid #333;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .vu-bar-fill {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #00ff00 0%, #ffff00 60%, #ff0000 100%);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.05s linear;
            opacity: 0.8;
        }

        .meter-section {
            flex-grow: 1;
            position: relative;
            background: url('data:image/svg+xml;utf8,<svg width="200" height="100" viewBox="0 0 200 100" xmlns="http://www.w3.org/2000/svg"><path d="M20,100 A80,80 0 0,1 180,100" fill="none" stroke="%23333" stroke-width="2"/><path d="M20,100 A80,80 0 0,1 60,30" fill="none" stroke="red" stroke-width="3" opacity="0.5"/></svg>') no-repeat bottom center;
            background-size: contain;
            margin-bottom: 5px;
        }
        #main-needle {
            width: 4px;
            height: 70%;
            background: red;
            position: absolute;
            bottom: 0;
            left: 50%;
            transform-origin: bottom center;
            transform: rotate(-45deg);
            transition: transform 0.1s ease-out;
            box-shadow: 0 0 5px red;
            border-radius: 2px;
        }

        .knobs-section {
            display: flex;
            justify-content: space-around;
            margin-bottom: 5px;
        }
        .knob-circle {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid var(--glow-color);
            position: relative;
            margin: 0 auto 5px auto;
            cursor: pointer;
            box-shadow: 0 0 5px var(--glow-color);
            transition: transform 0.2s ease; /* Transición suave para cambios manuales */
        }
        .knob-indicator {
            position: absolute;
            top: 2px;
            left: 50%;
            width: 3px;
            height: 8px;
            background: var(--glow-color);
            transform: translateX(-50%);
        }
        .knob-label { font-size: 0.6rem; color: var(--glow-color); text-align: center; }

        .volume-slider-container {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input[type=range] {
            flex-grow: 1;
            -webkit-appearance: none;
            height: 4px;
            background: #333;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: var(--glow-color);
            border-radius: 50%;
        }

        /* --- PANEL 3: AMBIENTE --- */
        .env-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }
        .temp-readout {
            font-size: 3rem;
            font-weight: bold;
            color: var(--glow-color);
            text-shadow: 0 0 15px var(--glow-color);
        }
        /* Alerta de Energía */
        .energy-label {
            font-size: 0.7rem;
            transition: all 0.2s;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .energy-alert {
            color: var(--alert-red);
            text-shadow: 0 0 10px var(--alert-red);
            font-weight: bold;
            animation: alertPulse 0.5s infinite alternate;
        }
        @keyframes alertPulse { from { opacity: 0.5; } to { opacity: 1; } }

        .energy-graph-box {
            width: 100%;
            height: 80px;
            background: #000;
            border: 1px solid #333;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }
        #energy-canvas { width: 100%; height: 100%; }
        
        .plate-obr {
            border: 1px solid #555;
            padding: 5px 15px;
            border-radius: 5px;
            background: linear-gradient(to bottom, #333, #111);
            color: #aaa;
            font-size: 0.7rem;
            letter-spacing: 2px;
        }

        /* --- Menú Flotante --- */
        #btn-ver {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid var(--glow-color);
            background: rgba(0, 0, 0, 0.6);
            color: var(--glow-color);
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 0 15px var(--glow-color);
            z-index: 100;
            pointer-events: auto;
        }
        #menu-tools {
            position: absolute;
            bottom: 90px;
            right: 20px;
            background: rgba(0,0,0,0.95);
            border: 1px solid var(--glow-color);
            border-radius: 10px;
            padding: 5px;
            display: none;
            z-index: 99;
            pointer-events: auto;
        }
        #menu-tools.visible { display: block; }
        .menu-item {
            padding: 10px 15px;
            color: var(--glow-color);
            border-bottom: 1px solid #333;
            cursor: pointer;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        /* SVG Overlay para SLS */
        #sls-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }

        /* Responsive Móvil Vertical */
        @media (max-width: 768px) and (orientation: portrait) {
            .panels-grid { grid-template-columns: 1fr; gap: 10px; }
            .panel { height: 280px; }
            .bottom-container { position: relative; margin-top: 20px; padding-bottom: 80px; }
            body { overflow-y: auto; justify-content: flex-start; }
        }
    </style>
</head>
<body>

    <!-- Fondo de Cámara -->
    <video id="bg-camera-feed" playsinline autoplay muted></video>

    <div class="header-title">EQUIPO PROFESIONAL DE EXPLORACIONES OBR</div>

    <div class="bottom-container">
        <div class="panels-grid">

            <!-- PANEL 1: CÁMARA -->
            <div class="panel" id="p-camera">
                <div class="panel-header">FILTROS CÁMARA</div>
                <div class="camera-view-box">
                    <canvas id="ghosttube-canvas"></canvas>
                    <svg id="sls-overlay" viewBox="0 0 320 240">
                        <!-- Grupo Esqueleto SLS -->
                        <g id="skeleton-group" stroke="var(--neon-green)" stroke-width="2" fill="none" stroke-linecap="round" style="display: none; filter: drop-shadow(0 0 4px var(--neon-green));">
                            <!-- Cabeza Técnica -->
                            <path id="sk-head-lines" d="M155,50 L165,50 L165,65 L155,65 Z" />
                            <!-- Columna -->
                            <line id="sk-spine" x1="160" y1="65" x2="160" y2="140" />
                            <!-- Hombros -->
                            <line id="sk-shoulder" x1="130" y1="80" x2="190" y2="80" />
                            <!-- Brazos -->
                            <line id="sk-arm-l" x1="130" y1="80" x2="120" y2="120" />
                            <line id="sk-arm-r" x1="190" y1="80" x2="200" y2="120" />
                            <!-- Piernas -->
                            <g id="sk-legs">
                                <line id="sk-hip" x1="140" y1="140" x2="180" y2="140" />
                                <line id="sk-leg-l" x1="140" y1="140" x2="140" y2="200" />
                                <line id="sk-leg-r" x1="180" y1="140" x2="180" y2="200" />
                                <circle cx="140" cy="140" r="2" fill="var(--neon-green)" stroke="none"/>
                                <circle cx="180" cy="140" r="2" fill="var(--neon-green)" stroke="none"/>
                            </g>
                            <!-- Uniones Superiores -->
                            <circle cx="160" cy="65" r="2" fill="var(--neon-green)" stroke="none"/>
                            <circle cx="130" cy="80" r="2" fill="var(--neon-green)" stroke="none"/>
                            <circle cx="190" cy="80" r="2" fill="var(--neon-green)" stroke="none"/>
                        </g>
                    </svg>
                </div>
                <div class="camera-controls">
                    <button class="cam-btn active" onclick="setFilter('normal')">NORMAL</button>
                    <button class="cam-btn" onclick="setFilter('sls')">SLS</button>
                    <button class="cam-btn" onclick="setFilter('relief')">RELIEVE</button>
                </div>
            </div>

            <!-- PANEL 2: DETECTOR -->
            <div class="panel" id="p-detector">
                <div class="panel-header">DETECTOR EMF (ESPÍRITUS)</div>
                <div class="emf-container">
                    <!-- VU Bars -->
                    <div class="vu-section">
                        <div class="vu-box"><div id="vu-l" class="vu-bar-fill"></div></div>
                        <div class="vu-box"><div id="vu-r" class="vu-bar-fill"></div></div>
                    </div>
                    <div class="meter-section">
                        <div id="main-needle"></div>
                    </div>
                    <div class="knobs-section">
                        <!-- Perilla Encendido -->
                        <div style="text-align:center">
                            <div class="knob-circle" id="knob-power" style="transform: rotate(-135deg);"><div class="knob-indicator"></div></div>
                            <div class="knob-label">ENCENDIDO</div>
                        </div>
                        <!-- Perilla Velocidad (Manual) -->
                        <div style="text-align:center">
                            <div class="knob-circle" id="knob-scan" style="transform: rotate(-135deg);"><div class="knob-indicator"></div></div>
                            <div class="knob-label">ESCANEAR</div>
                        </div>
                    </div>
                    <div class="volume-slider-container">
                        <div class="knob-label">VOL</div>
                        <input type="range" min="0" max="100" value="80" id="vol-slider">
                    </div>
                </div>
            </div>

            <!-- PANEL 3: AMBIENTE -->
            <div class="panel" id="p-env">
                <div class="panel-header">SENSOR AMBIENTE</div>
                <div class="env-content">
                    <div class="temp-readout" id="temp-val">--.-°C</div>
                    <div id="energy-label" class="energy-label">ENERGÍA DETECTADA</div>
                    <!-- Gráfico -->
                    <div class="energy-graph-box">
                        <canvas id="energy-canvas"></canvas>
                    </div>
                    <div class="plate-obr">OBR-SIMULATOR</div>
                </div>
            </div>

        </div>
    </div>

    <div id="btn-ver">VER</div>
    <div id="menu-tools">
        <div class="menu-item" onclick="togglePanel('p-camera')">CÁMARA</div>
        <div class="menu-item" onclick="togglePanel('p-detector')">DETECTOR</div>
        <div class="menu-item" onclick="togglePanel('p-env')">SENSOR</div>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const SHEETDB_URL = "https://sheetdb.io/api/v1/9xzfnke69kkej"; 
        let isRunning = false;
        let currentFilter = 'normal';
        let scanSpeed = 0; // 0: Lento, 1: Medio, 2: Rápido
        
        // SLS Variables
        let slsCenter = { x: 160, y: 100 };
        let hasLegs = false;

        // Elementos
        const videoBg = document.getElementById('bg-camera-feed');
        const canvas = document.getElementById('ghosttube-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const skeletonGroup = document.getElementById('skeleton-group');
        const legsGroup = document.getElementById('sk-legs');
        const energyLabel = document.getElementById('energy-label');
        const vuL = document.getElementById('vu-l');
        const vuR = document.getElementById('vu-r');
        
        // Audio
        let audioCtx, masterGain, gainNode, lfo, lfoGain, whiteNoiseNode, radioTuneNode, radioGain;
        let delayNode, delayFeedback, delayWet;
        let isSpeaking = false; 
        
        // Voz
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isRecognizing = false;
        let recognitionWatchdog;

        // Datos
        let programadoData = new Map();
        let automaticoData = [];

        // Energía
        let energyHistory = new Array(50).fill(0);
        const energyCanvas = document.getElementById('energy-canvas');
        const energyCtx = energyCanvas.getContext('2d');
        let currentTemp = 19.8;

        // --- 1. CÁMARA & VISIÓN ---
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: { ideal: "environment" }, width: { ideal: 1280 } },
                    audio: false
                });
                videoBg.srcObject = stream;
                videoBg.onloadedmetadata = () => {
                    canvas.width = 320; canvas.height = 240;
                    drawLoop();
                };
            } catch (e) { console.log("Camara error", e); }
        }

        // --- LOOP VISUAL ---
        let lastData = null;
        function drawLoop() {
            if (videoBg.readyState === videoBg.HAVE_ENOUGH_DATA) {
                ctx.drawImage(videoBg, 0, 0, canvas.width, canvas.height);
                
                let frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
                let data = frame.data;
                let width = canvas.width;
                let height = canvas.height;

                // --- Filtros ---
                if (currentFilter === 'relief') {
                    let copy = new Uint8ClampedArray(data);
                    for (let y = 0; y < height; y++) {
                        for (let x = 0; x < width; x++) {
                            if (x === 0) continue;
                            let i = (y * width + x) * 4;
                            let prev = (y * width + (x-1)) * 4;
                            let diff = Math.abs(copy[i] - copy[prev]) * 2; 
                            data[i] = diff + 50;   // R
                            data[i+1] = diff + 20; // G
                            data[i+2] = diff;      // B
                        }
                    }
                    ctx.putImageData(frame, 0, 0);
                    // DESHABILITAR SLS EN RELIEVE
                    skeletonGroup.style.display = 'none';
                } 
                else if (currentFilter === 'sls') {
                    for (let i = 0; i < data.length; i+=4) {
                        let l = (data[i] + data[i+1] + data[i+2]) / 3;
                        data[i] = 0; data[i+1] = l; data[i+2] = 0; 
                    }
                    ctx.putImageData(frame, 0, 0);
                    
                    // Detección
                    if (lastData) {
                        let minX = width, maxX = 0, minY = height, maxY = 0;
                        let motionPixels = 0;
                        
                        for (let y = 0; y < height; y+=5) {
                            for (let x = 0; x < width; x+=5) {
                                let i = (y * width + x) * 4;
                                let diff = Math.abs(data[i+1] - lastData[i+1]); 
                                if (diff > 30) {
                                    motionPixels++;
                                    if (x < minX) minX = x;
                                    if (x > maxX) maxX = x;
                                    if (y < minY) minY = y;
                                    if (y > maxY) maxY = y;
                                }
                            }
                        }
                        
                        if (motionPixels > 20) {
                            let cx = (minX + maxX) / 2;
                            let cy = (minY + maxY) / 2;
                            let h = maxY - minY;
                            
                            slsCenter.x += (cx - slsCenter.x) * 0.1;
                            slsCenter.y += (cy - slsCenter.y) * 0.1;
                            
                            // Escalado dinámico basado en la altura de detección
                            let scale = Math.min(1.5, Math.max(0.5, h / 100));
                            hasLegs = h > height * 0.4;
                            
                            skeletonGroup.style.display = 'inline';
                            updateSkeleton(slsCenter.x, slsCenter.y, hasLegs, scale);
                            
                            // Alerta de Energía por detección Visual
                            triggerEnergyAlert();
                        } else {
                            slsCenter.x += Math.sin(Date.now()/500);
                            updateSkeleton(slsCenter.x, slsCenter.y, hasLegs, 1);
                        }
                    }
                    lastData = new Uint8ClampedArray(data);
                } else {
                    skeletonGroup.style.display = 'none';
                }
            }
            requestAnimationFrame(drawLoop);
        }

        function updateSkeleton(x, y, legs, scale = 1) {
            // Escalar offsets
            const s = scale; 
            const headLines = document.getElementById('sk-head-lines');
            const spine = document.getElementById('sk-spine');
            const shoulder = document.getElementById('sk-shoulder');
            const armL = document.getElementById('sk-arm-l');
            const armR = document.getElementById('sk-arm-r');
            
            let hx = x - (10*s); let hy = y - (50*s);
            headLines.setAttribute('d', `M${hx},${hy} L${hx+(20*s)},${hy} L${hx+(20*s)},${hy+(20*s)} L${hx},${hy+(20*s)} Z`);

            spine.setAttribute('x1', x); spine.setAttribute('y1', y - (30*s));
            spine.setAttribute('x2', x); spine.setAttribute('y2', y + (40*s));

            shoulder.setAttribute('x1', x - (20*s)); shoulder.setAttribute('y1', y - (20*s));
            shoulder.setAttribute('x2', x + (20*s)); shoulder.setAttribute('y2', y - (20*s));

            let sway = Math.sin(Date.now() / 300) * (10*s);
            armL.setAttribute('x1', x - (20*s)); armL.setAttribute('y1', y - (20*s));
            armL.setAttribute('x2', x - (35*s)); armL.setAttribute('y2', y + (10*s) + sway);
            
            armR.setAttribute('x1', x + (20*s)); armR.setAttribute('y1', y - (20*s));
            armR.setAttribute('x2', x + (35*s)); armR.setAttribute('y2', y + (10*s) - sway);

            if (legs) {
                legsGroup.style.display = 'inline';
                const hip = document.getElementById('sk-hip');
                const legL = document.getElementById('sk-leg-l');
                const legR = document.getElementById('sk-leg-r');
                
                hip.setAttribute('x1', x - (15*s)); hip.setAttribute('y1', y + (40*s));
                hip.setAttribute('x2', x + (15*s)); hip.setAttribute('y2', y + (40*s));

                legL.setAttribute('x1', x - (15*s)); legL.setAttribute('y1', y + (40*s));
                legL.setAttribute('x2', x - (20*s)); legL.setAttribute('y2', y + (100*s));
                
                legR.setAttribute('x1', x + (15*s)); legR.setAttribute('y1', y + (40*s));
                legR.setAttribute('x2', x + (20*s)); legR.setAttribute('y2', y + (100*s));
                
                // Uniones piernas
                legsGroup.querySelectorAll('circle')[0].setAttribute('cx', x-(15*s));
                legsGroup.querySelectorAll('circle')[0].setAttribute('cy', y+(40*s));
                legsGroup.querySelectorAll('circle')[1].setAttribute('cx', x+(15*s));
                legsGroup.querySelectorAll('circle')[1].setAttribute('cy', y+(40*s));
            } else {
                legsGroup.style.display = 'none';
            }
            
            // Uniones superiores
            const circles = skeletonGroup.querySelectorAll(':scope > circle');
            circles[0].setAttribute('cx', x); circles[0].setAttribute('cy', y-(30*s));
            circles[1].setAttribute('cx', x-(20*s)); circles[1].setAttribute('cy', y-(20*s));
            circles[2].setAttribute('cx', x+(20*s)); circles[2].setAttribute('cy', y-(20*s));
        }

        function setFilter(f) {
            currentFilter = f;
            document.querySelectorAll('.cam-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        // --- 2. AUDIO / SPIRIT BOX ---
        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            masterGain = audioCtx.createGain();
            masterGain.connect(audioCtx.destination);

            // Ruido Blanco
            whiteNoiseNode = audioCtx.createBufferSource();
            let bSize = audioCtx.sampleRate * 2;
            let buffer = audioCtx.createBuffer(1, bSize, audioCtx.sampleRate);
            let d = buffer.getChannelData(0);
            for (let i = 0; i < bSize; i++) d[i] = Math.random() * 2 - 1;
            whiteNoiseNode.buffer = buffer;
            whiteNoiseNode.loop = true;

            gainNode = audioCtx.createGain();
            gainNode.gain.value = 0; 

            // Efecto Chop (Escaneo)
            lfo = audioCtx.createOscillator();
            lfo.type = 'square'; 
            lfo.frequency.value = 8; 

            lfoGain = audioCtx.createGain();
            lfoGain.gain.value = 0.05; 

            lfo.connect(lfoGain);
            lfoGain.connect(gainNode.gain);
            whiteNoiseNode.connect(gainNode);
            gainNode.connect(masterGain);

            // Ruido Radio AM (Sintetizado)
            let radioBuf = audioCtx.createBuffer(1, bSize, audioCtx.sampleRate);
            let rd = radioBuf.getChannelData(0);
            for(let i=0; i<bSize; i++) rd[i] = (Math.random() - 0.5) * 0.2; // Ruido suave
            radioTuneNode = audioCtx.createBufferSource();
            radioTuneNode.buffer = radioBuf;
            radioTuneNode.loop = true;
            radioGain = audioCtx.createGain();
            radioGain.gain.value = 0;
            
            // Filtro paso alto para sonido "radio vieja"
            let hpf = audioCtx.createBiquadFilter();
            hpf.type = 'highpass';
            hpf.frequency.value = 500;
            
            radioTuneNode.connect(hpf);
            hpf.connect(radioGain);
            radioGain.connect(masterGain);
            radioTuneNode.start();

            // Eco
            delayNode = audioCtx.createDelay();
            delayFeedback = audioCtx.createGain();
            delayWet = audioCtx.createGain();
            delayNode.delayTime.value = 0.4;
            delayFeedback.gain.value = 0.4;
            delayWet.gain.value = 0.3;

            gainNode.connect(delayWet);
            delayWet.connect(delayNode);
            delayNode.connect(delayFeedback);
            delayFeedback.connect(delayNode);
            delayNode.connect(masterGain);

            whiteNoiseNode.start();
            lfo.start();

            loadSheetData();
            initSpeechRec();
        }

        // --- ALERTAS VISUALES ---
        function triggerEnergyAlert() {
            energyLabel.classList.add('energy-alert');
            setTimeout(() => energyLabel.classList.remove('energy-alert'), 1000);
        }

        function updateVUMeters(active) {
            if (active) {
                // Simular picos de audio
                let valL = Math.random();
                let valR = Math.random();
                vuL.style.transform = `scaleX(${valL})`;
                vuR.style.transform = `scaleX(${valR})`;
            } else {
                vuL.style.transform = `scaleX(0)`;
                vuR.style.transform = `scaleX(0)`;
            }
        }

        // --- RECONOCIMIENTO DE VOZ ---
        function initSpeechRec() {
            if (!SpeechRecognition) return;
            recognition = new SpeechRecognition();
            recognition.lang = 'es-MX';
            recognition.continuous = false; 
            recognition.interimResults = false;

            recognition.onstart = () => { isRecognizing = true; };
            
            recognition.onend = () => { 
                isRecognizing = false;
                if (isRunning) {
                    clearTimeout(recognitionWatchdog);
                    recognitionWatchdog = setTimeout(() => {
                        if(isRunning && !isRecognizing) try { recognition.start(); } catch(e){}
                    }, 500);
                }
            };

            recognition.onresult = (event) => {
                let t = event.results[0][0].transcript.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                if (programadoData.has(t)) {
                    isSpeaking = true; 
                    speak(programadoData.get(t));
                }
            };
        }

        function startListening() {
            if (!recognition || isRecognizing) return;
            try { recognition.start(); } catch(e){}
        }

        function speak(text) {
            if (!text) return;
            isSpeaking = true;
            triggerEnergyAlert(); // Alerta visual
            
            if(lfoGain) lfoGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
            if(radioGain) radioGain.gain.linearRampToValueAtTime(0.02, audioCtx.currentTime + 0.1); // Bajar radio fondo

            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'es-MX';
            u.volume = document.getElementById('vol-slider').value / 100;
            u.rate = 0.9;
            
            // Loop visual de hablar
            let speakInt = setInterval(() => updateVUMeters(true), 100);

            u.onend = () => {
                isSpeaking = false;
                clearInterval(speakInt);
                updateVUMeters(false);
                if(isRunning && lfoGain) {
                    lfoGain.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime + 0.1);
                    radioGain.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime + 0.1);
                }
            };
            window.speechSynthesis.speak(u);
        }

        // --- 3. LÓGICA DE MODOS ---
        async function loadSheetData() {
            try {
                let [resAuto, resProg] = await Promise.all([
                    fetch(`${SHEETDB_URL}?sheet=AUTOMATICO`),
                    fetch(`${SHEETDB_URL}?sheet=PROGRAMADO`)
                ]);
                let jsonAuto = await resAuto.json();
                automaticoData = jsonAuto.map(r => r.TEXTO || r.texto).filter(t => t);
                let jsonProg = await resProg.json();
                jsonProg.forEach(r => {
                    let p = (r.PREGUNTA || r.pregunta || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    let res = r.RESPUESTA || r.respuesta;
                    if(p && res) programadoData.set(p, res);
                });
            } catch(e) { console.error(e); }
        }

        function startAutoMode() {
            if (!isRunning) return;
            let delay = 3000 + Math.random() * 4000;
            setTimeout(() => {
                if (isRunning && !isSpeaking && automaticoData.length > 0 && Math.random() > 0.3) {
                    let word = automaticoData[Math.floor(Math.random() * automaticoData.length)];
                    speak(word);
                }
                startAutoMode();
            }, delay);
        }

        // --- 4. CONTROLES UI ---
        const pwrBtn = document.getElementById('knob-power');
        const scanBtn = document.getElementById('knob-scan'); // Perilla Escanear

        pwrBtn.addEventListener('click', () => {
            if (!audioCtx) initAudio();
            isRunning = !isRunning;
            if (isRunning) {
                pwrBtn.style.transform = 'rotate(0deg)';
                pwrBtn.style.boxShadow = '0 0 15px var(--glow-color)';
                if (audioCtx.state === 'suspended') audioCtx.resume();
                
                if(lfoGain) lfoGain.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime + 0.5);
                if(radioGain) radioGain.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime + 0.5);
                
                startAutoMode();
                startListening();
                
                // Loop aguja
                setInterval(() => {
                    if(isRunning && !isSpeaking) {
                        let v = Math.random();
                        document.getElementById('main-needle').style.transform = `translateX(-50%) rotate(${-45 + v*90}deg)`;
                        updateVUMeters(v > 0.7);
                    }
                }, 150);

            } else {
                pwrBtn.style.transform = 'rotate(-135deg)';
                pwrBtn.style.boxShadow = 'none';
                if(lfoGain) lfoGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
                if(radioGain) radioGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
                if(recognition) recognition.stop();
                isRecognizing = false;
                window.speechSynthesis.cancel();
                updateVUMeters(false);
            }
        });

        // Control Manual de Escaneo (Clic para cambiar velocidad)
        scanBtn.addEventListener('click', () => {
            scanSpeed = (scanSpeed + 1) % 3; // 0 -> 1 -> 2 -> 0
            
            // Rotar visualmente
            let deg = -135 + (scanSpeed * 135); // -135, 0, 135
            scanBtn.style.transform = `rotate(${deg}deg)`;
            
            // Cambiar velocidad LFO
            if(lfo) {
                let freq = (scanSpeed === 0) ? 5 : (scanSpeed === 1) ? 12 : 20;
                lfo.frequency.linearRampToValueAtTime(freq, audioCtx.currentTime + 0.1);
            }
        });

        document.getElementById('vol-slider').addEventListener('input', (e) => {
            if (masterGain) masterGain.gain.value = e.target.value / 100;
        });

        // --- 5. SENSOR AMBIENTE ---
        function updateEnergyGraph() {
            let val = Math.random() * 50;
            energyHistory.push(val);
            energyHistory.shift();
            energyCtx.clearRect(0, 0, energyCanvas.width, energyCanvas.height);
            energyCtx.beginPath();
            energyCtx.strokeStyle = '#00FFFF';
            energyCtx.lineWidth = 2;
            let w = energyCanvas.width;
            let h = energyCanvas.height;
            let step = w / energyHistory.length;
            for(let i=0; i<energyHistory.length; i++) {
                let y = h - (energyHistory[i] / 100 * h);
                if (i===0) energyCtx.moveTo(0, y);
                else energyCtx.lineTo(i * step, y);
            }
            energyCtx.stroke();
            
            // Temp estable (cambia lento)
            currentTemp += (Math.random() * 0.2 - 0.1);
            document.getElementById('temp-val').innerText = currentTemp.toFixed(1) + "°C";
        }
        setInterval(updateEnergyGraph, 3000); // Lento para temp

        // UI Helpers
        const menu = document.getElementById('menu-tools');
        let menuT;
        document.getElementById('btn-ver').addEventListener('click', () => {
            menu.classList.toggle('visible');
            clearTimeout(menuT);
            if(menu.classList.contains('visible')) menuT = setTimeout(()=>menu.classList.remove('visible'), 5000);
        });
        function togglePanel(id) { 
            document.getElementById(id).classList.toggle('hidden');
            menu.classList.remove('visible');
        }

        window.onload = startCamera;

    </script>
</body>
</html>
