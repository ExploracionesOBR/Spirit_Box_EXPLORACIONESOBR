<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>DETECTOR-OBR v20.8 POLTERGEIST STABLE</title> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- TensorFlow JS -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
    
    <!-- PeerJS (v1.5.4 Stable) & QR -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@500;700;900&family=Creepster&family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --hud-bg: #050510; 
            --hud-cyan: #00f3ff; 
            --hud-pink: #ff0055; 
            --hud-green: #00ff41; 
            --hud-red: #ff3333;
            --hud-orange: #ffae00;
            --hud-teal: #6EF8FA;
            --glass-panel: rgba(5, 8, 15, 0.92);
            --left-panel-w: 240px; 
            --bottom-panel-h: 110px;
        }

        /* BLOQUEO TOTAL */
        *, *::before, *::after {
            -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
            -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: #000; color: var(--hud-cyan);
            overflow: hidden; width: 100vw; height: 100vh; margin: 0;
            touch-action: none;
        }

        /* Layout Grid */
        #app-ui { 
            width: 100%; height: 100%; display: grid;
            grid-template-columns: var(--left-panel-w) 1fr; 
            grid-template-rows: 1fr var(--bottom-panel-h);
            grid-template-areas: "left cam" "left bottom";
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; z-index: 10;
        }
        
        #app-ui.full-mode {
            grid-template-columns: 0px 1fr;
            grid-template-rows: 1fr 0px;
        }
        #app-ui.full-mode #left-panel { transform: translateX(-100%); opacity: 0; }
        #app-ui.full-mode #bottom-panel { transform: translateY(100%); opacity: 0; }

        /* Mobile Layout */
        @media (max-width: 768px) {
            #app-ui {
                grid-template-columns: 0px 1fr;
                grid-template-rows: 1fr 140px; 
                grid-template-areas: "left cam" "bottom bottom";
            }
            #left-panel { display: none !important; } 
            .desktop-only { display: none; }
            .mobile-controls { display: flex; }
        }
        @media (min-width: 769px) { .mobile-controls { display: none; } }

        /* Panels */
        #left-panel { 
            grid-area: left; border-right: 2px solid var(--hud-cyan); 
            overflow-y: auto; background: var(--glass-panel);
            display: flex; flex-direction: column; gap: 4px; padding: 8px;
            box-shadow: 5px 0 20px rgba(0,0,0,0.5); backdrop-filter: blur(5px);
            transition: inherit; white-space: nowrap;
        }
        
        #bottom-panel { 
            grid-area: bottom; border-top: 2px solid var(--hud-cyan); 
            background: var(--glass-panel); display: flex; 
            align-items: center; padding: 0;
            backdrop-filter: blur(5px); transition: inherit;
        }

        /* CAMARA AREA */
        #main-view-area { 
            grid-area: cam; position: relative; overflow: hidden; background: #000; width: 100%; height: 100%; 
            transform-origin: center center;
        }
        #zoom-container {
            width: 100%; height: 100%; transform-origin: center center;
            transition: transform 1s cubic-bezier(0.25, 0.46, 0.45, 0.94); will-change: transform;
        }
        #video-feed { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #sls-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; transform: scaleX(-1); }

        /* Touch Zones */
        #touch-layer { position: absolute; inset: 0; z-index: 45; display: flex; pointer-events: none; }
        #zone-zoom { width: 75%; height: 100%; pointer-events: auto; }
        #zone-menu { width: 25%; height: 100%; pointer-events: auto; }

        /* Filters */
        .filter-night-vision #video-feed { filter: grayscale(100%) sepia(100%) hue-rotate(70deg) brightness(1.1) contrast(1.4) saturate(300%); }
        .filter-night-vision #main-view-area::after {
            content: ""; position: absolute; inset: 0; pointer-events: none;
            background: radial-gradient(circle, rgba(0, 255, 50, 0.1) 40%, rgba(0,0,0,0.8) 95%);
            background-image: radial-gradient(circle, rgba(0, 255, 0, 0.05) 40%, rgba(0,0,0,0.9) 100%), repeating-linear-gradient(0deg, rgba(0,255,0,0.05), rgba(0,255,0,0.05) 1px, transparent 1px, transparent 3px);
            z-index: 5; mix-blend-mode: hard-light;
        }
        .filter-negative #video-feed { filter: invert(1) hue-rotate(180deg) contrast(1.5); }
        .filter-bokeh #main-view-area::after {
            content: ""; position: absolute; inset: 0; pointer-events: none; z-index: 5;
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            mask-image: radial-gradient(circle at center, transparent 30%, black 90%); -webkit-mask-image: radial-gradient(circle at center, transparent 30%, black 90%);
        }
        .filter-pareidolia #main-view-area { border: 2px solid var(--hud-red); }

        /* UI Elements */
        .btn-hud {
            background: rgba(0, 243, 255, 0.05); border: 1px solid var(--hud-cyan); color: var(--hud-cyan);
            padding: 6px; font-family: 'Orbitron'; font-size: 0.65rem; cursor: pointer; transition: all 0.2s;
            text-transform: uppercase; width: 100%; margin-bottom: 3px; display: flex; align-items: center; justify-content: center; gap: 5px;
            clip-path: polygon(6px 0, 100% 0, 100% calc(100% - 6px), calc(100% - 6px) 100%, 0 100%, 0 6px);
        }
        .btn-hud.active { background: var(--hud-cyan); color: #000; box-shadow: 0 0 15px var(--hud-cyan); border-color: #fff; }
        #btn-mixer-open.connected { border-color: var(--hud-green); color: var(--hud-green); box-shadow: 0 0 10px var(--hud-green) inset; }
        .sensor-box { border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.4); padding: 4px 6px; margin-bottom: 4px; }
        .sensor-label { font-size: 0.6rem; color: #777; margin-bottom: 0; }
        .sensor-val-big { font-size: 1.1rem; line-height: 1.2; font-weight: bold; }
        .temp-val-text { color: var(--hud-orange); text-shadow: 0 0 5px var(--hud-orange); }

        /* Loading Screen */
        #loading-screen { position: fixed; inset: 0; background: #000; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .loader-container { position: relative; width: 90px; height: 90px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
        .loader { 
            position: absolute; inset: 0; border: 2px solid transparent; 
            border-top: 2px solid var(--hud-cyan); border-right: 2px solid var(--hud-cyan);
            border-radius: 50%; animation: spin 1.5s linear infinite; 
        }
        .loader::after {
            content: ""; position: absolute; inset: 5px; border: 2px solid transparent;
            border-bottom: 2px solid var(--hud-red); border-left: 2px solid var(--hud-red);
            border-radius: 50%; animation: spin 2s linear reverse infinite;
        }
        .logo-center { width: 50px; height: 50px; object-fit: contain; filter: drop-shadow(0 0 10px var(--hud-cyan)); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #btn-enter-system {
            margin-top: 10px; padding: 12px 40px; background: rgba(0, 243, 255, 0.1); border: 1px solid var(--hud-cyan);
            color: var(--hud-cyan); font-family: 'Orbitron'; font-size: 0.9rem; letter-spacing: 2px; cursor: pointer;
            box-shadow: 0 0 10px rgba(0,243,255,0.1); transition: 0.3s; 
        }
        #btn-enter-system:hover { background: var(--hud-cyan); color: #000; box-shadow: 0 0 30px var(--hud-cyan); }

        /* Right Menu */
        #right-menu {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 20px; z-index: 50; padding: 10px;
            transition: opacity 0.5s, transform 0.5s; opacity: 1;
        }
        #right-menu.hidden-menu { opacity: 0; transform: translateY(-50%) translateX(50px); pointer-events: none; }
        .menu-btn-round {
            width: 45px; height: 45px; border-radius: 50%;
            background: rgba(0,0,0,0.6); border: 2px solid var(--hud-cyan); color: var(--hud-cyan);
            display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
            cursor: pointer; transition: 0.3s; backdrop-filter: blur(4px);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
        }
        .menu-btn-round:hover { transform: scale(1.1); box-shadow: 0 0 20px var(--hud-cyan); background: var(--hud-cyan); color: #000; }
        .menu-btn-round.active { background: var(--hud-red); border-color: var(--hud-red); color: white; animation: pulseRed 2s infinite; }

        /* Stats Display */
        #stats-display {
            position: absolute; bottom: 5px; right: 10px; z-index: 40;
            text-align: right; font-family: 'Share Tech Mono'; font-size: 0.75rem; color: var(--hud-teal);
            text-shadow: 0 0 2px var(--hud-teal); pointer-events: none;
            display: flex; gap: 8px; align-items: center;
        }
        .stat-item { border-right: 1px solid rgba(110, 248, 250, 0.5); padding-right: 8px; }
        .stat-item:last-child { border: none; padding-right: 0; }
        #stats-timer-container { display: none; color: var(--hud-red); font-weight: bold; font-family: 'Creepster'; letter-spacing: 1px; text-shadow: 0 0 5px red; }
        #app-ui.full-mode #stats-timer-container { display: block; }

        /* Center Timer */
        #center-timer-container { text-align: center; flex-shrink: 0; width: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #timer-panel { font-family: 'Creepster'; font-size: 1.2rem; color: var(--hud-red); text-shadow: 0 0 5px red; animation: pulseRed 3s infinite; letter-spacing: 1px; line-height: 1; }
        #timer-label { font-size: 0.4rem; color: #555; letter-spacing: 1px; font-family: 'Orbitron'; margin-bottom: 1px; }

        /* Follow Us */
        #follow-sequence { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 30; text-align: center; pointer-events: none; width: 100%; display: flex; justify-content: center; }
        .seq-item { display: none; animation: glitchText 0.2s infinite; filter: drop-shadow(0 0 5px var(--hud-cyan)); }
        #seq-text { font-family: 'Orbitron'; font-size: 1rem; color: white; letter-spacing: 3px; }
        #seq-icons { font-size: 2rem; gap: 20px; color: white; }
        #seq-handle { font-family: 'Share Tech Mono'; font-size: 1.2rem; color: var(--hud-cyan); }
        
        @keyframes pulseRed { 0% { opacity: 0.8; } 50% { opacity: 1; text-shadow: 0 0 15px red; } 100% { opacity: 0.8; } }
        @keyframes glitchText { 0% { transform: translate(0); } 20% { transform: translate(-1px, 1px); } 40% { transform: translate(1px, -1px); } 60% { transform: translate(-1px, -1px); } 80% { transform: translate(1px, 1px); } 100% { transform: translate(0); } }

        /* Banner Video */
        #bottom-banner { position: absolute; bottom: 0; left: 0; width: 100%; height: 150px; z-index: 35; display: none; background: black; border-top: 2px solid var(--hud-red); }
        #banner-vid { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }

        /* LIVE Indicator */
        .live-container { position: absolute; top: 4px; left: 4px; z-index: 20; display: flex; gap: 2px; }
        .live-dot { width: 10px; height: 10px; background: var(--hud-red); border-radius: 50%; box-shadow: 0 0 10px var(--hud-red); animation: livePulse 0.8s infinite; }
        .live-text { color: white; font-family: 'Orbitron'; font-size: 0.7rem; font-weight: bold; text-shadow: 0 0 5px var(--hud-red); margin-left: 5px; }
        @keyframes livePulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } 100% { opacity: 1; transform: scale(1); } }

        /* Intro Button (Fixed Z-Index) */
        #btn-play-intro { 
            position: absolute; bottom: 30px; left: 20px; z-index: 100; pointer-events: auto; 
            font-size: 1.8rem; color: white; cursor: pointer; 
            filter: drop-shadow(0 0 5px black); transition: transform 0.3s, opacity 0.3s; 
        }
        #btn-play-intro:active { transform: scale(0.9); }
        
        /* Logo & Elements Transition */
        #top-right-logo { position: absolute; top: 15px; right: 20px; z-index: 40; width: 80px; opacity: 0.8; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .pop-out { transform: scale(0); opacity: 0; }
        .pop-in { transform: scale(1); opacity: 0.8; }

        /* AI Feedback */
        #ai-feedback-overlay { position: absolute; top: 40px; left: 10px; z-index: 45; pointer-events: none; display: none; text-align: left; max-width: 300px; }
        #ai-feedback-text { 
            font-family: 'Creepster'; font-size: 1.2rem; color: var(--hud-red); 
            text-shadow: 0 0 5px red; letter-spacing: 1px; line-height: 1.1;
            animation: textFlicker 0.1s infinite;
        }
        @keyframes textFlicker { 0% { opacity: 1; } 50% { opacity: 0.8; transform: translateX(1px); } 100% { opacity: 1; } }

        /* Zoom Indicator */
        #zoom-target-indicator { position: absolute; width: 40px; height: 40px; border: 2px solid var(--hud-green); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 25; }

        /* Logs */
        .log-item { font-size: 0.6rem; margin-bottom: 1px; font-family: 'Share Tech Mono'; line-height: 1.1; }
        .log-normal { color: #0f0; } .log-warn { color: var(--hud-orange); } .log-crit { color: var(--hud-red); text-shadow: 0 0 2px red; }

        /* Intro Overlay */
        #intro-player { position: fixed; inset: 0; background: black; z-index: 5000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transform: scale(1.2); transition: opacity 0.8s ease, transform 0.8s ease; }
        #intro-player.active { opacity: 1; pointer-events: auto; transform: scale(1); }
        #intro-vid { width: 100%; height: 100%; object-fit: contain; }
        #intro-fallback-close { position: absolute; bottom: 30px; right: 30px; border: 1px solid #555; padding: 10px; color: #555; cursor: pointer; display: none; font-family: 'Orbitron'; font-size: 0.8rem; }

        /* Mixer */
        #mixer-window { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); width: 95vw; max-width: 800px; height: 80vh; background: rgba(10, 12, 18, 0.65); border: 1px solid var(--hud-cyan); z-index: 2000; display: none; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.8); border-radius: 8px; transition: 0.3s; opacity: 0; pointer-events: none; backdrop-filter: blur(5px); }
        #mixer-window.active { display: flex; opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }
        .mixer-header { padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: center; align-items: center; position: relative; }
        .mixer-close { position: absolute; right: 15px; color: var(--hud-red); font-size: 1.5rem; cursor: pointer; }
        .mixer-controls-left { position: absolute; left: 15px; }
        #mixer-content { flex: 1; overflow-x: auto; padding: 20px; display: flex; gap: 10px; }
        .channel-strip { background: rgba(20,20,25,0.8); border: 1px solid #333; border-radius: 6px; padding: 10px 5px; display: flex; flex-direction: column; align-items: center; width: 90px; min-width: 90px; height: 320px; gap: 10px; }
        .strip-title { cursor: text; border-bottom: 1px dashed #555; padding-bottom: 2px; max-width: 100%; overflow: hidden; text-overflow: ellipsis; }
        .fader-group { flex: 1; width: 100%; display: flex; justify-content: center; gap: 8px; background: rgba(0,0,0,0.3); padding: 10px 0; border-radius: 4px; }
        input[type=range][orient=vertical] { writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 40px; height: 100%; accent-color: var(--hud-cyan); }
        .vu-meter-wrap { width: 12px; height: 100%; background: #111; position: relative; border-radius: 2px; overflow: hidden; }
        .vu-active { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: linear-gradient(to top, #00ff00, #ffff00, #ff0000); transition: height 0.05s; }
        .btn-mute { width: 100%; padding: 5px; background: #333; color: #888; border: 1px solid #555; }
        .btn-mute.muted { background: #500; color: white; border-color: red; }
        .vol-display { background: transparent; color: var(--hud-cyan); text-align: center; width: 100%; border: none; }
        #mixer-qr-modal { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 2050; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #mixer-qrcode img { border: 5px solid white; border-radius: 4px; }
        #remote-audios-hidden { display: none; }

    </style>
</head>
<body>

    <!-- Loading -->
    <div id="loading-screen">
        <div class="loader-container"><div class="loader"></div><img src="obr-logo.png" class="logo-center" onerror="this.style.display='none'"></div>
        <button id="btn-enter-system" onclick="startExperience()">INGRESAR AL SISTEMA</button>
    </div>

    <!-- Video Intro -->
    <div id="intro-player"><video id="intro-vid" playsinline autoplay><source src="INTRO_1.mp4" type="video/mp4"></video><div id="intro-fallback-close" onclick="closeIntro()">CERRAR VIDEO</div></div>

    <!-- UI -->
    <div id="app-ui">
        <!-- Left -->
        <div id="left-panel">
            <div class="mb-2 text-center border-b border-cyan-900 pb-1"><h1 class="hud-title text-sm text-cyan-400">DETECTOR<span class="text-white">-OBR</span></h1></div>
            <!-- Sensors -->
            <div class="sensor-box"><div class="flex justify-between sensor-label">MAGNETOMETRO</div><div class="sensor-val-big text-yellow-400 flex items-end justify-between"><span id="emf-val">0.0</span> <span class="text-xs mb-1">췃T</span></div><div class="h-1 bg-gray-800 mt-1 w-full"><div id="emf-bar" class="h-full bg-yellow-500 transition-all duration-100" style="width: 0%"></div></div></div>
            <div class="sensor-box"><div class="flex justify-between sensor-label">PROXIMIDAD <span id="prox-mode" class="text-[8px]">(CAM)</span></div><div class="sensor-val-big text-blue-400 flex items-end justify-between"><span id="prox-val">--</span> <span class="text-xs mb-1">%</span></div></div>
            <div class="sensor-box"><div class="flex justify-between sensor-label">TEMPERATURA</div><div class="sensor-val-big font-bold flex items-end justify-between temp-val-text"><span id="temp-val">--</span> <span class="text-xs mb-1">춿C</span></div></div>
            <!-- Buttons -->
            <div class="mt-2">
                <button class="btn-hud" id="btn-night" onclick="setFilter('night', this)"><i class="fas fa-moon"></i> NOCTURNA</button>
                <button class="btn-hud" id="btn-thermal" onclick="setFilter('thermal', this)"><i class="fas fa-fire"></i> TERMICO</button>
                <button class="btn-hud" id="btn-bokeh" onclick="setFilter('bokeh', this)"><i class="fas fa-camera"></i> BOKEH</button>
                <button class="btn-hud" id="btn-sls" onclick="setFilter('sls', this)"><i class="fas fa-running"></i> SLS (AI)</button>
            </div>
            <div class="mt-2 border-t border-gray-800 pt-2"><button id="btn-mixer-open" class="btn-hud" style="color: #c084fc; border-color: #c084fc;" onclick="toggleMixerWindow()"><i class="fas fa-sliders-h"></i> MEZCLADOR</button></div>
        </div>

        <!-- Main -->
        <div id="main-view-area">
            <div id="zoom-container"><video id="video-feed" autoplay playsinline muted></video><canvas id="sls-canvas"></canvas></div>
            
            <!-- Touch -->
            <div id="touch-layer"><div id="zone-zoom"></div><div id="zone-menu"></div></div>
            <div id="zoom-target-indicator"></div>
            
            <!-- Floating Elements -->
            <img id="top-right-logo" class="pop-in" src="obr-logo.png" onerror="this.style.display='none'">
            
            <div class="live-container">
                <div class="live-dot"></div><span class="live-text">LIVE</span>
            </div>
            <!-- AI Feedback Below Live -->
            <div id="ai-feedback-overlay"><div id="ai-feedback-text"></div></div>

            <!-- Right Menu -->
            <div id="right-menu">
                <div class="menu-btn-round" onclick="toggleFullscreenMode()"><i class="fas fa-expand-arrows-alt"></i></div>
                <div class="menu-btn-round" onclick="togglePareidolia()" id="btn-pareidolia"><i class="fas fa-eye"></i></div>
                <div class="menu-btn-round" onclick="toggleBanner()" id="btn-banner"><i class="fas fa-bullhorn"></i></div>
                <div class="menu-btn-round" onclick="resetZoom()"><i class="fas fa-search-minus"></i></div>
            </div>

            <!-- Follow -->
            <div id="follow-sequence">
                <div class="seq-item" id="seq-text">SIGUENOS EN</div>
                <div class="seq-item" id="seq-icons"><div class="flex gap-4"><i class="fab fa-tiktok text-pink-500"></i><i class="fab fa-facebook text-blue-500"></i><i class="fab fa-youtube text-red-500"></i></div></div>
                <div class="seq-item" id="seq-handle">@EXPLORACIONES OBR</div>
            </div>

            <div id="bottom-banner"><video id="banner-vid" src="BANNER_1.mp4" loop muted playsinline></video></div>
            <div id="btn-play-intro" class="pop-in" onclick="playIntro()"><i class="fas fa-film"></i></div>

            <!-- Stats -->
            <div id="stats-display">
                <div class="stat-item" id="stats-timer-container"><span id="stats-timer-val">00:00:00</span></div>
                <div class="stat-item"><span id="fps-val">0</span> FPS</div>
                <div class="stat-item text-gray-300"><span id="res-val">--x--</span></div>
            </div>
        </div>

        <!-- Bottom -->
        <div id="bottom-panel">
            <div class="h-full overflow-hidden relative p-2 border-r border-gray-800 flex-grow">
                <div class="text-[8px] text-green-900 absolute top-1 right-1">SYS.LOG</div>
                <div id="log-content" class="h-full overflow-y-auto flex flex-col justify-end pb-2"></div>
            </div>
            <div id="center-timer-container"><div id="timer-label">TIEMPO ACTIVO</div><div id="timer-panel">00:00:00</div></div>
            <div class="h-full flex items-center justify-end" style="width: 5px;"><div class="mobile-controls w-full flex justify-between gap-2 overflow-x-auto md:hidden"></div></div>
        </div>
    </div>

    <!-- Mixer -->
    <div id="mixer-window">
        <div class="mixer-header">
            <div class="mixer-controls-left"><button onclick="showMixerQR()" class="text-xs bg-purple-900 hover:bg-purple-700 text-white px-3 py-1 rounded border border-purple-500"><i class="fas fa-qrcode"></i> QR</button></div>
            <div class="text-center"><h2 class="font-bold text-cyan-400 text-lg font-orbitron">MEZCLADOR OBR</h2><div class="text-[10px] text-gray-400">ID: <span id="host-id-display" class="text-white select-all">---</span></div></div>
            <i class="fas fa-times mixer-close" onclick="toggleMixerWindow()"></i>
        </div>
        <div id="mixer-content">
            <div id="remote-strips-container" class="flex gap-2"></div>
            <div class="channel-strip master-out"><div class="strip-title">游댉 MASTER</div><input type="number" class="vol-display" id="val-master" value="100" onchange="mixerSetVol('master', this.value)"><div class="fader-group"><input type="range" orient="vertical" id="fader-master" min="0" max="200" value="100" oninput="mixerSetVol('master', this.value, true)"><div class="vu-meter-wrap"><div class="vu-active" id="vu-master"></div></div></div><button class="btn-mute" id="mute-master" onclick="mixerToggleMute('master')">MUTE</button></div>
        </div>
        <div id="mixer-qr-modal" onclick="this.style.display='none'"><div class="bg-white p-4 rounded-lg text-center" onclick="event.stopPropagation()"><div id="mixer-qrcode"></div><p class="text-black font-mono text-xs mt-2">ESCANEAR CON DETECTOR</p><p class="text-gray-500 text-[10px] mt-1">Toca fuera para cerrar</p></div></div>
    </div>
    <div id="remote-audios-hidden"></div>

<script>
    // --- CONFIG ---
    const GEMINI_API_KEY = "AIzaSyDbFXVNT5jyZZclbOexvgkB_FK8ijC5qU4";
    
    // --- VARS ---
    let currentFilter='normal', video=document.getElementById('video-feed'), slsCanvas=document.getElementById('sls-canvas');
    let zoomContainer=document.getElementById('zoom-container'), ctxSLS=slsCanvas.getContext('2d');
    let detector, lastFrameTime=0, isBannerActive=false, isPareidoliaActive=false;
    let menuHideTimeout, currentZoomLevel=1, zoomLongPressTimer, isTouching=false;
    let pareidoliaInterval, smoothedProx=0;
    
    // Mixer
    let mixerAudioCtx, mixerPeer, mixerMasterOut, mixerMonitorOut, mixerNodes={}, isMixerInitialized=false, savedMasterVol=1;

    // --- START ---
    async function startExperience() {
        document.getElementById('loading-screen').style.opacity = '0';
        try {
            await initSensors(); await startCamera(); await initMoveNet();
            seedInitialLogs();
            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
                startLoop(); startTimer(); startFakeLogs(); setupZones(); runFollowSequence(); fetchRealTemperature();
            }, 500);
        } catch (e) { document.getElementById('loading-screen').style.opacity = '1'; alert("Error de carga: " + e.message); }
    }

    // --- ZONES ---
    function setupZones() {
        const zZoom = document.getElementById('zone-zoom');
        zZoom.addEventListener('pointerdown', (e) => {
            isTouching=true; const rect=video.getBoundingClientRect();
            const x=e.clientX-rect.left; const y=e.clientY-rect.top;
            zoomLongPressTimer=setTimeout(() => { if(isTouching) executeZoomAt(x,y,rect.width,rect.height); }, 600);
        });
        zZoom.addEventListener('pointerup', () => { isTouching=false; clearTimeout(zoomLongPressTimer); });
        document.getElementById('zone-menu').addEventListener('click', showMenu);
        hideMenu();
    }

    function showMenu() { document.getElementById('right-menu').classList.remove('hidden-menu'); setFloatingElementsVisibility(false); clearTimeout(menuHideTimeout); menuHideTimeout=setTimeout(hideMenu, 3000); }
    function hideMenu() { document.getElementById('right-menu').classList.add('hidden-menu'); setFloatingElementsVisibility(true); }
    function setFloatingElementsVisibility(v) {
        const l = document.getElementById('top-right-logo'); const f = document.getElementById('follow-sequence');
        const introBtn = document.getElementById('btn-play-intro');
        if(v) { l.classList.replace('pop-out','pop-in'); f.style.opacity='1'; if(!isBannerActive) introBtn.classList.replace('pop-out','pop-in'); }
        else { l.classList.replace('pop-in','pop-out'); f.style.opacity='0'; }
    }

    // --- ZOOM ---
    function executeZoomAt(x,y,w,h) {
        const xP = (x/w)*100; const yP = (y/h)*100;
        if(currentZoomLevel===1) currentZoomLevel=3; else if(currentZoomLevel===3) currentZoomLevel=5;
        zoomContainer.style.transformOrigin = `${xP}% ${yP}%`; zoomContainer.style.transform = `scale(${currentZoomLevel})`;
        const ind = document.getElementById('zoom-target-indicator');
        ind.style.left=(video.offsetLeft+x)+'px'; ind.style.top=(video.offsetTop+y)+'px'; ind.style.opacity=1; setTimeout(()=>ind.style.opacity=0,500);
        updateLog(`ZOOM DIGITAL x${currentZoomLevel}`);
    }
    function resetZoom() { currentZoomLevel=1; zoomContainer.style.transform=`scale(1)`; setTimeout(()=>zoomContainer.style.transformOrigin='center center',1000); updateLog("ZOOM RESET"); }

    // --- PAREIDOLIA AI ---
    function togglePareidolia() {
        const btn = document.getElementById('btn-pareidolia'); isPareidoliaActive=!isPareidoliaActive;
        if(isPareidoliaActive) { btn.classList.add('active'); document.body.classList.add('filter-pareidolia'); speakText("Visi칩n activada"); pareidoliaInterval=setInterval(analyzeFrameWithGemini, 15000); }
        else { btn.classList.remove('active'); document.body.classList.remove('filter-pareidolia'); speakText("Visi칩n desactivada"); clearInterval(pareidoliaInterval); document.getElementById('ai-feedback-overlay').style.display='none'; }
    }

    async function analyzeFrameWithGemini() {
        if(!video || video.paused) return;
        updateLog("IA: Escaneando...", 'log-warn');
        const canvas=document.createElement('canvas'); canvas.width=640; canvas.height=360;
        const ctx=canvas.getContext('2d'); ctx.drawImage(video,0,0,640,360);
        const base64=canvas.toDataURL('image/jpeg',0.6).split(',')[1];

        try {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({
                    contents: [{ parts: [{text: "Describe el escenario actual que ves en la imagen brevemente (max 6 palabras) y a침ade un detalle inquietante o paranormal sutil al final. Ejemplo: 'Pasillo vac칤o... sombra al fondo'. Si hay personas, mencionalas."}, {inline_data: {mime_type: "image/jpeg", data: base64}}] }],
                    safetySettings: [{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]
                })
            });
            const d = await r.json();
            let text = d.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
            
            if(!text) {
                const fallback = ["SOMBRA DETECTADA", "PRESENCIA CERCANA", "FIGURA EN EL FONDO", "ANOMALIA VISUAL", "OSCURIDAD DENSA"];
                text = fallback[Math.floor(Math.random()*fallback.length)];
            }

            updateLog("IA: " + text, 'log-crit');
            speakText(text);
            const ov = document.getElementById('ai-feedback-overlay');
            const ot = document.getElementById('ai-feedback-text');
            ot.innerText = text.toUpperCase();
            ov.style.display='block'; setTimeout(()=>ov.style.display='none', 6000);

        } catch(e) { console.error(e); updateLog("Error Neural", 'log-crit'); }
    }

    // --- UTILS ---
    function toggleBanner() {
        const b=document.getElementById('bottom-banner'); const v=document.getElementById('banner-vid'); const btn=document.getElementById('btn-banner'); const iBtn=document.getElementById('btn-play-intro');
        isBannerActive=!isBannerActive;
        if(isBannerActive) { b.style.display='block'; v.play(); btn.classList.add('active'); iBtn.classList.replace('pop-in','pop-out'); }
        else { b.style.display='none'; v.pause(); btn.classList.remove('active'); iBtn.classList.replace('pop-out','pop-in'); }
    }
    function toggleFullscreenMode() { document.getElementById('app-ui').classList.toggle('full-mode'); }
    
    function playIntro() { 
        const p=document.getElementById('intro-player'); const v=document.getElementById('intro-vid'); 
        p.classList.add('active'); 
        v.currentTime=0; 
        if(mixerMasterOut){savedMasterVol=mixerMasterOut.gain.value;mixerMasterOut.gain.value=0;} 
        
        // Monitor de fallo
        const failTimer = setTimeout(() => {
            if(v.currentTime < 0.1) {
                console.warn("Video stuck, forcing close");
                closeIntro();
            }
        }, 3500);

        v.play().then(() => clearTimeout(failTimer)).catch(()=>{
            clearTimeout(failTimer);
            document.getElementById('intro-fallback-close').style.display='block';
        }); 
        v.onended=()=>closeIntro(); 
    }
    function closeIntro() { document.getElementById('intro-player').classList.remove('active'); document.getElementById('intro-vid').pause(); if(mixerMasterOut)mixerMasterOut.gain.value=savedMasterVol; }
    function speakText(t) { if('speechSynthesis' in window){const u=new SpeechSynthesisUtterance(t); u.lang='es-ES'; window.speechSynthesis.speak(u);} }
    
    // --- CORE & MIXER FIX ---
    async function startCamera() { const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}},audio:false}); video.srcObject=s; return new Promise(r=>video.onloadedmetadata=()=>{video.play();resizeCanvas();r();}); }
    function resizeCanvas() { slsCanvas.width=video.videoWidth; slsCanvas.height=video.videoHeight; document.getElementById('res-val').innerText=`${video.videoWidth}x${video.videoHeight}`; }
    window.addEventListener('resize',resizeCanvas);
    async function initMoveNet() { await tf.ready(); detector=await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet,{modelType:poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING}); }
    
    // Mixer Connection Fix (PeerJS 1.5.4 Logic)
    async function toggleMixerWindow() { const w=document.getElementById('mixer-window'); if(!w.classList.contains('active')){w.classList.add('active');if(!isMixerInitialized)await initMixerSystem();}else w.classList.remove('active'); }
    async function initMixerSystem() {
        mixerAudioCtx=new (window.AudioContext||window.webkitAudioContext)(); await mixerAudioCtx.resume();
        mixerMasterOut=mixerAudioCtx.createGain(); mixerMonitorOut=mixerAudioCtx.createGain();
        mixerMasterOut.connect(mixerMonitorOut); mixerMonitorOut.connect(mixerAudioCtx.destination);
        mixerPeer=new Peer();
        mixerPeer.on('open', id=>{ document.getElementById('host-id-display').innerText=id; new QRCode(document.getElementById('mixer-qrcode'),{text:id,width:150,height:150}); document.getElementById('btn-mixer-open').classList.add('connected'); });
        
        // FIX: Answer Immediately
        mixerPeer.on('call', c => { 
            c.answer(); // Handshake
            c.on('stream', s => handleRemoteStream(c.peer, s));
            c.on('close', () => removeCh(c.peer));
            c.on('error', e => console.error("Call Error", e));
        });
        
        setupVuMeter(mixerMasterOut,'vu-master'); isMixerInitialized=true;
    }
    function handleRemoteStream(id,s){ if(document.getElementById('ch-'+id))return; const a=document.createElement('audio');a.srcObject=s;a.autoplay=true;a.muted=true;document.getElementById('remote-audios-hidden').appendChild(a); const g=mixerAudioCtx.createGain();mixerAudioCtx.createMediaStreamSource(s).connect(g).connect(mixerMasterOut); createChUI(id,g); mixerNodes[id]={gain:g,el:a}; updateLog("Dispositivo conectado", "log-warn"); }
    function createChUI(id,g){ const d=document.createElement('div');d.className='channel-strip';d.id='ch-'+id;d.innerHTML=`<div class="strip-title" ondblclick="renameChannel('${id}')">游니 ${id.substring(0,4)}</div><input type="number" class="vol-display" id="v-${id}" value="100"><div class="fader-group"><input type="range" orient="vertical" id="f-${id}" max="200" value="100"><div class="vu-meter-wrap"><div class="vu-active" id="vu-${id}"></div></div></div><button class="btn-mute" id="m-${id}">MUTE</button>`; document.getElementById('remote-strips-container').appendChild(d); d.querySelector(`#f-${id}`).oninput=e=>{g.gain.value=e.target.value/100;d.querySelector(`#v-${id}`).value=e.target.value;}; d.querySelector(`#m-${id}`).onclick=e=>{if(g.gain.value===0){g.gain.value=d.querySelector(`#v-${id}`).value/100;e.target.classList.remove('muted');}else{g.gain.value=0;e.target.classList.add('muted');}}; setupVuMeter(g,`vu-${id}`); }
    function removeCh(id){ document.getElementById('ch-'+id)?.remove(); mixerNodes[id]?.el.remove(); delete mixerNodes[id]; updateLog("Dispositivo desconectado", "log-crit"); }
    window.mixerSetVol=(t,v,f)=>{const n=t==='local'?null:mixerMasterOut;if(n){n.gain.value=v/100;if(f)document.getElementById(`val-${t}`).value=v;else document.getElementById(`fader-${t}`).value=v;}}
    window.mixerToggleMute=(t)=>{const b=document.getElementById(`mute-${t}`);const n=t==='local'?null:mixerMasterOut;if(n){if(n.gain.value===0){n.gain.value=document.getElementById(`val-${t}`).value/100;b.classList.remove('muted');}else{n.gain.value=0;b.classList.add('muted');}}}
    function setupVuMeter(n,id){if(!n)return;const a=mixerAudioCtx.createAnalyser();a.fftSize=256;n.connect(a);const d=new Uint8Array(256);const e=document.getElementById(id);function l(){if(!e)return;requestAnimationFrame(l);a.getByteTimeDomainData(d);let s=0;for(let x of d)s+=(x-128)/128*(x-128)/128;e.style.height=Math.min(100,Math.sqrt(s/256)*400)+"%";}l();}
    window.showMixerQR=()=>document.getElementById('mixer-qr-modal').style.display='flex';
    window.renameChannel=id=>{const n=prompt("Nombre:");if(n)document.querySelector(`#ch-${id} .strip-title`).innerText=n;}

    // Loop & Draw
    async function startLoop(){ async function render(now){ const d=now-lastFrameTime; lastFrameTime=now; if(now%20<1)document.getElementById('fps-val').innerText=Math.round(1000/d)||0; ctxSLS.clearRect(0,0,slsCanvas.width,slsCanvas.height); if(currentFilter==='sls'&&detector&&video.readyState>=2){try{const p=await detector.estimatePoses(video,{maxPoses:3,flipHorizontal:false});if(p.length>0)drawSkeleton(p);}catch(e){}} if(isPareidoliaActive&&Math.random()>0.95){const x=Math.random()*slsCanvas.width,y=Math.random()*slsCanvas.height,s=50+Math.random()*100;ctxSLS.strokeStyle='rgba(255,0,0,0.5)';ctxSLS.lineWidth=2;ctxSLS.strokeRect(x,y,s,s);} if(!hasPhysicalProx){let t=0; if(detector) t = Math.random() * 12; smoothedProx+=(t-smoothedProx)*0.05; document.getElementById('prox-val').innerText=Math.floor(smoothedProx);} requestAnimationFrame(render); } render(); }
    function drawSkeleton(poses){ ctxSLS.lineCap='round';ctxSLS.lineJoin='round';ctxSLS.lineWidth=4;ctxSLS.strokeStyle='#00ff41';ctxSLS.fillStyle='#ff0055';poses.forEach(p=>{if(p.score<0.25)return;const k=p.keypoints;const m={};k.forEach(kp=>m[kp.name]=kp);ctxSLS.beginPath();[['left_shoulder','right_shoulder'],['left_shoulder','left_hip'],['right_shoulder','right_hip'],['left_hip','right_hip'],['left_shoulder','left_elbow'],['left_elbow','left_wrist'],['right_shoulder','right_elbow'],['right_elbow','right_wrist'],['left_hip','left_knee'],['left_knee','left_ankle'],['right_hip','right_knee'],['right_knee','right_ankle'],['nose','left_eye'],['nose','right_eye'],['left_eye','left_ear'],['right_eye','right_ear']].forEach(([a,b])=>{const p1=m[a],p2=m[b];if(p1&&p2&&p1.score>0.3&&p2.score>0.3){ctxSLS.moveTo(p1.x,p1.y);ctxSLS.lineTo(p2.x,p2.y);}});ctxSLS.stroke();k.forEach(kp=>{if(kp.score>0.3){ctxSLS.beginPath();ctxSLS.arc(kp.x,kp.y,6,0,2*Math.PI);ctxSLS.fill();}});}); }

    // Misc
    window.setFilter=(f,b)=>{if(currentFilter===f){f='normal';b=null;} currentFilter=f;document.body.className='';document.querySelectorAll('.btn-hud').forEach(x=>x.classList.remove('active'));if(f!=='normal'&&b)b.classList.add('active'); if(f==='night'){document.body.classList.add('filter-night-vision');toggleTorch(true);}else{toggleTorch(false);} if(f==='thermal')document.body.classList.add('filter-negative');if(f==='sls')document.body.classList.add('filter-sls');if(f==='bokeh')document.body.classList.add('filter-bokeh');if(isPareidoliaActive)document.body.classList.add('filter-pareidolia');}
    async function toggleTorch(e){if(!video.srcObject)return;const t=video.srcObject.getVideoTracks()[0];if(t?.getCapabilities().torch)t.applyConstraints({advanced:[{torch:e}]}).catch(()=>{});}
    function seedInitialLogs(){ ["Iniciando OBR v20.8...", "Sensores OK", "Neural Engine OK", "Esperando se침al..."].forEach(m=>updateLog(m)); }
    function startFakeLogs(){ const m=["Escaneando...", "Red estable", "Temp nominal", "Buscando EVP", "Lectura magn칠tica"]; setInterval(()=>{if(Math.random()>0.6)updateLog(m[Math.floor(Math.random()*m.length)],'log-normal');},2000); }
    function updateLog(m,c='log-normal'){const l=document.getElementById('log-content');l.innerHTML+=`<div class="log-item ${c}">[${new Date().toLocaleTimeString()}] ${m}</div>`;l.scrollTop=l.scrollHeight;}
    function startTimer(){let s=0;setInterval(()=>{s++;const d=new Date(0);d.setSeconds(s);const t=d.toISOString().substr(11,8);document.getElementById('timer-panel').innerText=t;document.getElementById('stats-timer-val').innerText=t;},1000);}
    async function runFollowSequence(){ const t=document.getElementById('seq-text'),i=document.getElementById('seq-icons'),h=document.getElementById('seq-handle'),c=document.getElementById('follow-sequence'); while(true){ if(isBannerActive){c.style.display='none';await wait(5000);continue;}else c.style.display='flex'; t.style.display='block';await wait(2500);t.style.display='none'; i.style.display='block';await wait(2500);i.style.display='none'; h.style.display='block';await wait(3500);h.style.display='none'; await wait(8000); } }
    function wait(ms){return new Promise(r=>setTimeout(r,ms));}
    let hasPhysicalProx=false; async function initSensors(){ if('Magnetometer' in window){try{const m=new Magnetometer({frequency:10});m.addEventListener('reading',()=>{document.getElementById('emf-val').innerText=Math.sqrt(m.x**2+m.y**2+m.z**2).toFixed(1);});m.start();}catch(e){setInterval(()=>{document.getElementById('emf-val').innerText=(Math.random()*100).toFixed(1);},500);}}else{setInterval(()=>{document.getElementById('emf-val').innerText=(Math.random()*100).toFixed(1);},500);} if('ProximitySensor' in window){try{const p=new ProximitySensor({frequency:10});p.addEventListener('reading',()=>{document.getElementById('prox-val').innerText=p.distance;hasPhysicalProx=true;});p.start();}catch(e){}} }
    
    // TEMP FIX: TIMEOUT FOR LOCATION
    function fetchRealTemperature(){ 
        if(!navigator.geolocation) return fallbackTemp();
        
        const timeout = setTimeout(fallbackTemp, 3000); // 3s max wait
        
        navigator.geolocation.getCurrentPosition(async p=>{
            clearTimeout(timeout);
            try{
                const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true`);
                const d=await r.json();
                if(d.current_weather) document.getElementById('temp-val').innerText=d.current_weather.temperature+" 춿C";
            }catch(e){ fallbackTemp(); }
        }, (e)=>{ clearTimeout(timeout); fallbackTemp(); }); 
    }
    function fallbackTemp() { let t = 22; setInterval(() => { t += (Math.random()-0.5)*0.1; document.getElementById('temp-val').innerText = t.toFixed(1) + " 춿C"; }, 2000); }
</script>
</body>
</html>
