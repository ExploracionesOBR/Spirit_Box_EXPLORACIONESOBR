
    <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>DETECTOR-OBR v18.6 STABLE-FIX</title> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@500;700;900&family=Creepster&family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <style>
        :root {
            --hud-bg: #050510; 
            --hud-cyan: #00f3ff; 
            --hud-pink: #ff0055; 
            --hud-green: #00ff41; 
            --hud-orange: #ffae00;
            --hud-red: #ff3333;
            --hud-blue: #0088ff;
            --glass-panel: rgba(5, 8, 15, 0.95);
            --left-panel-w: 280px;
            --bottom-panel-h: 160px;
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: #000; color: var(--hud-cyan);
            overflow: hidden; width: 100vw; height: 100vh; margin: 0;
            touch-action: none; 
            -webkit-user-select: none; user-select: none; -webkit-touch-callout: none;
        }

        #app-ui { 
            width: 100%; height: 100%; 
            display: grid;
            grid-template-columns: var(--left-panel-w) 1fr; 
            grid-template-rows: 1fr var(--bottom-panel-h);
            grid-template-areas: "left cam" "left bottom";
            transition: all 0.5s ease;
            opacity: 0; pointer-events: none;
        }

        body.panels-hidden #app-ui { grid-template-columns: 0px 1fr; grid-template-rows: 1fr 0px; }

        #left-panel { grid-area: left; border-right: 2px solid var(--hud-cyan); overflow: hidden; transition: all 0.5s ease; position: relative; display: flex; flex-direction: column; justify-content: flex-start; z-index: 50; background: var(--glass-panel); }
        #bottom-panel { grid-area: bottom; border-top: 2px solid var(--hud-cyan); overflow: hidden; transition: all 0.5s ease; z-index: 50; background: var(--glass-panel); }
        
        /* CAMARA (Contenedor principal) */
        #main-view-area { 
            grid-area: cam; position: relative; overflow: hidden; background: #000; width: 100%; height: 100%; 
            touch-action: none;
        }

        #touch-layer { position: absolute; inset: 0; z-index: 10; touch-action: none; }

        body.panels-hidden #left-panel, body.panels-hidden #bottom-panel { display: none; }

        .panel-container {
            box-shadow: inset 0 0 20px rgba(0, 243, 255, 0.1);
            padding: 10px;
            background-image: linear-gradient(rgba(0, 243, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 243, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        #matrix-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.2; pointer-events: none; z-index: 0; }
        #zoom-container { width: 100%; height: 100%; transform-origin: center center; transition: transform 0.3s ease-out; will-change: transform; z-index: 1; }
        #bg-camera-feed { width: 100%; height: 100%; object-fit: cover; transition: filter 0.3s ease; }
        #main-filter-canvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; }

        .camera-border { position: absolute; inset: 10px; pointer-events: none; z-index: 20; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1); }
        .camera-border::before, .camera-border::after, .cb-inner::before, .cb-inner::after { content: ''; position: absolute; width: 20px; height: 20px; border-color: var(--hud-cyan); border-style: solid; transition: all 0.5s; }
        .camera-border::before { top: 0; left: 0; border-width: 2px 0 0 2px; }
        .camera-border::after { top: 0; right: 0; border-width: 2px 2px 0 0; }
        .cb-inner { position: absolute; inset: 0; }
        .cb-inner::before { bottom: 0; left: 0; border-width: 0 0 2px 2px; }
        .cb-inner::after { bottom: 0; right: 0; border-width: 0 2px 2px 0; }

        .rec-container { position: absolute; top: 15px; left: 15px; color: var(--hud-red); font-family: 'Orbitron'; font-weight: bold; display: flex; align-items: center; gap: 8px; z-index: 30; text-shadow: 0 0 5px var(--hud-red); font-size: 0.8rem; pointer-events: none; }
        .rec-dot { width: 10px; height: 10px; background: var(--hud-red); border-radius: 50%; animation: blinkRed 1s infinite; }
        @keyframes blinkRed { 50% { opacity: 0.3; } }
        @keyframes pulseGreen { 0% { box-shadow: 0 0 0 0 rgba(0, 255, 65, 0.8); } 100% { box-shadow: 0 0 0 15px rgba(0, 255, 65, 0); } }
        @keyframes pulseOrange { 0% { box-shadow: 0 0 0 0 rgba(255, 174, 0, 0.8); } 100% { box-shadow: 0 0 0 15px rgba(255, 174, 0, 0); } }
        .rec-connected .rec-dot { background: var(--hud-green); animation: pulseGreen 1.5s infinite; }
        .rec-error .rec-dot { background: var(--hud-orange); animation: pulseOrange 1s infinite; }

        .stats-container { position: absolute; bottom: 15px; right: 20px; font-family: 'Share Tech Mono'; font-size: 0.65rem; color: rgba(0, 243, 255, 0.7); text-shadow: 0 0 2px #000; z-index: 30; text-align: right; pointer-events: none; display: flex; gap: 10px; }
        .stats-val { color: #fff; font-weight: bold; }

        body.filter-night-vision #bg-camera-feed { filter: grayscale(100%) sepia(100%) hue-rotate(90deg) brightness(0.9) contrast(1.2) saturate(150%); }
        body.filter-night-vision #main-view-area::after { content: ""; position: absolute; inset: 0; pointer-events: none; z-index: 4; background: radial-gradient(circle, transparent 60%, #000 95%); }
        body.filter-negative #bg-camera-feed { filter: invert(1) hue-rotate(180deg); }
        body.filter-focus #main-view-area::after { content: ""; position: absolute; inset: 0; pointer-events: none; z-index: 4; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); mask-image: radial-gradient(circle, transparent 30%, black 90%); -webkit-mask-image: radial-gradient(circle, transparent 30%, black 90%); background: transparent; }
        body.filter-focus #bg-camera-feed { filter: contrast(1.2) saturate(0.9) brightness(1.1); }
        body.filter-sls #main-filter-canvas { display: block; }

        #logo-container { position: absolute; top: 15px; right: 15px; z-index: 50; pointer-events: none; }
        #logo-image { width: 60px; height: 60px; filter: drop-shadow(0 0 5px var(--hud-cyan)); animation: horrorPulse 4s infinite; }
        @keyframes horrorPulse { 
            0%, 85% { clip-path: inset(0 0 0 0); transform: translate(0, 0); opacity: 1; }
            86% { clip-path: inset(20% 0 50% 0); transform: translate(-2px, 1px); filter: hue-rotate(90deg) contrast(2); }
            90% { clip-path: inset(0 0 0 0); transform: translate(0, 0); }
            100% { clip-path: inset(0 0 0 0); transform: translate(0, 0); filter: drop-shadow(0 0 5px var(--hud-cyan)); } 
        }
        
        #follow-banner { position: absolute; bottom: 20px; left: 0; right: 0; display: flex; justify-content: center; pointer-events: none; opacity: 0; transition: opacity 1s; z-index: 30; }
        #follow-banner.active { opacity: 1; }
        .banner-content { background: transparent; padding: 0; border: none; display: flex; flex-direction: column; align-items: center; gap: 5px; text-shadow: 0 0 5px #000; }
        .seq-step { display: none; animation: fadeIn 0.5s; text-align: center; }
        .seq-step.active { display: block; }
        #step-1 { font-family: 'Orbitron'; color: #fff; letter-spacing: 2px; font-weight: bold; text-shadow: 0 0 10px var(--hud-cyan); }
        #step-2 { gap: 20px; display: none; filter: drop-shadow(0 0 5px #000); } 
        #step-3 { font-family: 'Creepster'; color: var(--hud-red); letter-spacing: 2px; font-size: 1.5rem; text-shadow: 2px 2px 0 #000; }
        .social-icon { font-size: 2rem; color: #fff; transition: transform 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .section-title { font-family: 'Orbitron'; font-size: 0.65rem; font-weight: 800; color: var(--hud-cyan); margin-bottom: 5px; border-bottom: 1px solid rgba(0, 243, 255, 0.3); display: flex; justify-content: space-between; align-items: center; padding-bottom: 2px; z-index: 2; position: relative; }
        #spirit-box-section { border: 1px solid var(--hud-green); background: rgba(0, 15, 5, 0.5); padding: 8px; border-radius: 4px; margin-bottom: 10px; display: flex; flex-direction: column; z-index: 2; position: relative; }
        .voice-led { width: 12px; height: 12px; border-radius: 50%; background: #222; border: 1px solid #555; transition: 0.2s; box-shadow: 0 0 2px #000; }
        .voice-led.active { background: var(--hud-blue); box-shadow: 0 0 10px var(--hud-blue); }
        .voice-led.listening { background: var(--hud-green); box-shadow: 0 0 15px var(--hud-green); animation: pulseLed 1s infinite; }
        @keyframes pulseLed { 50% { opacity: 0.5; } }
        .sb-display-area { background: #000; border: 1px inset #333; padding: 10px; margin: 8px 0; font-family: 'Share Tech Mono'; color: var(--hud-green); text-align: center; font-size: 0.9rem; text-transform: uppercase; border-radius: 4px; }
        .btn-control { background: #111; border: 1px solid #444; color: #aaa; font-family: 'Orbitron'; font-size: 0.8rem; padding: 10px; width: 100%; cursor: pointer; font-weight: bold; }
        .btn-control.pwr-on { border-color: var(--hud-green); color: var(--hud-green); background: rgba(0,50,0,0.3); box-shadow: 0 0 10px var(--hud-green) inset; }

        /* PANEL SENSORES (2 COLUMNAS) */
        .panel-section { flex-grow: 0; overflow: hidden; position: relative; padding: 8px; background: rgba(0,0,0,0.4); border-radius: 4px; margin-bottom: 5px; } 
        .sensor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; position: relative; z-index: 2; }
        .sensor-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.6rem; padding: 3px 5px; background: rgba(20,20,30,0.6); border-radius: 3px; border-left: 2px solid #333; backdrop-filter: blur(2px); }
        .status-green { border-left-color: var(--hud-green); color: var(--hud-green); }
        .status-red { border-left-color: var(--hud-red); color: #777; }

        if(currentFilter==='sls' && vid.readyState >= 2){ 
            ctxSLS.clearRect(0,0,canvasSLS.width,canvasSLS.height); 
            if (latestPoses.length > 0) drawSLS(latestPoses); 
        }
        
        drawMatrix();
        
        if(analyser){
            const data = new Uint8Array(analyser.frequencyBinCount); analyser.getByteFrequencyData(data);
            let sum=0; for(let i=0; i<data.length; i++) sum+=data[i]; let avg=sum/data.length; 
            if(isRxOn) {
               if(isMixerConnected && avg > 10) document.getElementById('btn-rx').classList.add('rx-pulse-green'); 
               else document.getElementById('btn-rx').classList.remove('rx-pulse-green');
            }
            if(isRecognizing && !isProcessingResponse) { if(avg > micMaxVol) micMaxVol=avg; }
            for(let i=0; i<NUM_BARS; i++){ let val=(data[i*2] + (data[i*2+1]||0))/2; let bar=energyBars[i]; bar.className='energy-bar-seg'; if(val>50)bar.classList.add('active'); if(val>150)bar.classList.add('mid'); if(val>220)bar.classList.add('high'); bar.style.height=Math.max(5,(val/255)*100)+"%"; }
        }

        // SENSOR SIMULATION
        if(proxSensor) {
            if(currentFilter==='sls' && latestPoses.length > 0) targetProx = Math.min(99, (latestPoses[0].score * 100));
            else targetProx = Math.random() * 3;
        } else {
            if(currentFilter==='sls' && latestPoses.length > 0) targetProx = Math.random() * 90;
            else targetProx = Math.random() * 3;
        }
        
        if(Math.abs(currentProx - targetProx) > 1) currentProx += (targetProx - currentProx) * 0.1;
        document.getElementById('prox-val').innerText = Math.floor(currentProx).toString();

        const now = performance.now();
        if(now - lastTempTime > 3000) { let drop = 2 + Math.random() * 6; targetTemp = baseTemp - drop; lastTempTime = now; }
        if(Math.abs(currentTemp - targetTemp) > 0.1) currentTemp += (targetTemp - currentTemp) * 0.02; 
        document.getElementById('temp-display').innerText = currentTemp.toFixed(1);

        requestAnimationFrame(loop);
    }

    async function loadData(){ try { const r=await fetch(SCRIPT_URL); if(!r.ok)throw new Error("Red"); const d=await r.json(); if(d.automatico)autoData=d.automatico.map(x=>x.TEXTO); if(d.programado)d.programado.forEach(i=>{if(i.PREGUNTA)progData.set(i.PREGUNTA.toLowerCase().trim(), i.RESPUESTA)}); dataLoaded=true; dataStats.prog=d.programado?d.programado.length:0; dataStats.auto=d.automatico?d.automatico.length:0; } catch(e){ dataLoaded=false; } }

    let latestPoses = [];
    async function initMoveNet() { 
        await tf.ready(); 
        detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet, { modelType: poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING }); 
        setInterval(async () => { 
            // RESTORED v13.9 Logic: Threshold 0.15
            if(currentFilter==='sls' && vid.readyState>=2) { 
                try { latestPoses = await detector.estimatePoses(vid, {maxPoses: 5, scoreThreshold: 0.15}); } catch(e) { latestPoses = []; } 
            } else { latestPoses = []; } 
        }, 100); 
    }
    
    const conns = [['left_shoulder','right_shoulder'],['left_shoulder','left_hip'],['right_shoulder','right_hip'],['left_hip','right_hip'],['left_shoulder','left_elbow'],['left_elbow','left_wrist'],['right_shoulder','right_elbow'],['right_elbow','right_wrist'],['left_hip','left_knee'],['left_knee','left_ankle'],['right_hip','right_knee'],['right_knee','right_ankle']];
    function drawSLS(poses) {
        const s = Math.max(canvasSLS.width/vid.videoWidth, canvasSLS.height/vid.videoHeight); 
        const xo = (canvasSLS.width - vid.videoWidth*s)/2;
        const yo = (canvasSLS.height - vid.videoHeight*s)/2;
        ctxSLS.lineWidth = 3; ctxSLS.lineCap = 'round'; ctxSLS.strokeStyle = '#00ff41'; ctxSLS.shadowBlur = 10; ctxSLS.shadowColor = '#00ff41';
        poses.forEach(p => { 
            if(p.score < 0.15) return; 
            const kp = p.keypoints; const m = {}; kp.forEach(k => m[k.name] = k); 
            ctxSLS.beginPath(); 
            conns.forEach(([a,b]) => { 
                const p1 = m[a]; const p2 = m[b]; 
                if(p1 && p2 && p1.score > 0.20 && p2.score > 0.20) { ctxSLS.moveTo(p1.x*s + xo, p1.y*s + yo); ctxSLS.lineTo(p2.x*s + xo, p2.y*s + yo); } 
            }); 
            ctxSLS.stroke(); 
            ctxSLS.fillStyle = '#ff0055'; 
            kp.forEach(k => { if(k.score > 0.20) { ctxSLS.beginPath(); ctxSLS.arc(k.x*s + xo, k.y*s + yo, 4, 0, 2*Math.PI); ctxSLS.fill(); } }); 
        });
    }
</script>
</body>
</html>    
         
