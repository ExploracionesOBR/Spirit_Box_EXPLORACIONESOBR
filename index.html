<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzOf3crQxBdPylwMTAd34W-nBShN31MkIUtaMdKsZHMZVVniI2HjMesD6DpOlO363T1/exec";
    const FALLBACK_AUTO = ["¬øHay alguien?", "Te escucho", "Ac√©rcate", "Detr√°s", "Fr√≠o", "Ayuda", "Vete", "S√≥tano", "Miedo", "Luz", "Oscuridad", "Aqu√≠"];
    const MIXER_ID = "obr-mezclador-central"; 
    
    let audioCtx, masterGain, micSource, analyser;
    let streamerGainNode = null; // IMPORTANTE: Variable global para el modo streamer
    let bgBuffer, bgNode, bgGain;
    let noiseNode, noiseGain;
    let recognition, isSpiritOn = false;
    let autoData = [...FALLBACK_AUTO], progData = new Map();
    let videoTrack, currentFilter = 'none', 
    uiVisible = false, hideTimeout;
    let proxSensor, energyBars = [];
    let isRecognizing = false; 
    let scanSpeed = 1.0;
    let interferenceInterval;
    let micMaxVol = 0;
    let restoreAudioTimer;
    let isProcessingResponse = false; 

    let peer, dataConn;
    let isRxOn = false;
    let isMixerConnected = false;
    let incomingAudioEl = document.getElementById('incoming-feed');
    let rxStreamSource = null;
    let micStreamSource = null;
    let isIntroPlaying = false;
    let localStream = null;
    let commandReceived = false;
    
    let zoomLevel = 1;
    let longPressTimer;
    let isLongPressing = false;
    let initialPinchDist = 0;
    const zoomContainer = document.getElementById('zoom-container');
    const touchLayer = document.getElementById('touch-layer');
    const mainView = document.getElementById('main-view-area');
    const vid = document.getElementById('bg-camera-feed');
    const canvasSLS = document.getElementById('main-filter-canvas'); const ctxSLS = canvasSLS.getContext('2d');
    const matrixCanvas = document.getElementById('matrix-canvas');
    const mCtx = matrixCanvas.getContext('2d');
    let matrixDrops = [];

    let loadProgress = 0; let loadInterval; let dataLoaded = false;
    let dataStats = { prog: 0, auto: 0 };
    const NUM_BARS = 10; 
    let baseTemp = 0;
    let targetTemp = 22.0;
    let currentTemp = 22.0;
    let lastTempTime = 0;
    let currentProx = 0;
    let targetProx = 0;
    let detector = null; 

    window.onload = () => {
        const eContainer = document.getElementById('energy-container');
        for(let i=0; i<NUM_BARS; i++){ let d = document.createElement('div'); d.className = 'energy-bar-seg'; eContainer.appendChild(d); energyBars.push(d);
        }
        setupZoomEvents();
        startLoadingSequence();
        loadData();
    };

    function forceResetUI() {
        const btn = document.getElementById('btn-reset-ui');
        btn.innerHTML = "‚úî";
        btn.classList.add('reset-success');
        
        document.body.classList.remove('panels-hidden');
        document.getElementById('app-ui').style.opacity = '1';
        document.getElementById('app-ui').style.pointerEvents = 'auto';
        document.getElementById('loading-overlay').style.display = 'none';
        uiVisible = true;
        showControls();
        if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        setTimeout(() => {
             btn.innerHTML = "‚ö†";
             btn.classList.remove('reset-success');
        }, 2000);
    }

    function startBannerLoop() {
        const banner = document.getElementById('follow-banner');
        const s1=document.getElementById('step-1'), s2=document.getElementById('step-2'), s3=document.getElementById('step-3');
        const run = () => {
            banner.classList.add('active');
            s1.classList.add('active');
            setTimeout(() => { s1.classList.remove('active'); s2.style.display='flex'; s2.classList.add('active'); }, 2000);
            setTimeout(() => { s2.classList.remove('active'); s2.style.display='none'; s3.classList.add('active'); }, 5000);
            setTimeout(() => { s3.classList.remove('active'); banner.classList.remove('active'); setTimeout(run, 15000); }, 8000);
        }; run();
    }

    async function fetchWeather(lat, lon) {
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
            const data = await res.json();
            return data.current_weather.temperature;
        } catch(e) { return 18.0;
        } 
    }
    
    function initTemp() {
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async pos => {
                const realTemp = await fetchWeather(pos.coords.latitude, pos.coords.longitude);
                baseTemp = realTemp; currentTemp = realTemp; targetTemp = realTemp;
            }, () => { 
                baseTemp = 18.0; });
        } else { baseTemp = 18.0;
        }
    }

    // INTRO VIDEO
    function playIntro() {
        isIntroPlaying = true;
        const overlay = document.getElementById('video-overlay');
        const video = document.getElementById('intro-video');
        if(incomingAudioEl) incomingAudioEl.muted = true;
        if(audioCtx && audioCtx.state === 'running') audioCtx.suspend();
        if(window.speechSynthesis) window.speechSynthesis.cancel();
        if(recognition) try { recognition.stop(); } catch(e){}
        overlay.style.display = 'flex';
        setTimeout(() => overlay.style.opacity = 1, 10);
        video.src = 'INTRO_1.mp4'; video.load();
        video.play().catch(e => { console.log("Error video", e); alert("Error: INTRO_1.mp4 no encontrado"); stopIntro(); });
        video.onended = stopIntro;
    }
    function stopIntro() {
        isIntroPlaying = false;
        const overlay = document.getElementById('video-overlay');
        const video = document.getElementById('intro-video');
        overlay.style.opacity = 0;
        setTimeout(() => {
            video.pause(); video.currentTime = 0;
            overlay.style.display = 'none';
            if(isRxOn && incomingAudioEl) incomingAudioEl.muted = false;
            if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            if(isSpiritOn) startListeningCycle();
        }, 1500);
    }

    function updateAudioRouting() {
        if (!audioCtx || !analyser) return;
        try { if(micStreamSource) micStreamSource.disconnect(analyser); if(rxStreamSource) rxStreamSource.disconnect(analyser); } catch(e){}
        if (isRxOn) {
            if (incomingAudioEl.srcObject) {
                if (!rxStreamSource) rxStreamSource = audioCtx.createMediaStreamSource(incomingAudioEl.srcObject);
                rxStreamSource.connect(analyser);
                rxStreamSource.connect(audioCtx.destination);
            }
        } else {
            if (micStreamSource) micStreamSource.connect(analyser);
        }
    }

    function initPeer() {
        peer = new Peer();
        peer.on('open', id => { connectData(); connectAudioToMixer(); });
        peer.on('call', call => {
            call.answer(localStream);
            call.on('stream', remoteStream => {
                incomingAudioEl.srcObject = remoteStream;
                incomingAudioEl.muted = !isRxOn; 
                if(isRxOn) updateAudioRouting();
           });
        });
    }

    function connectAudioToMixer() {
        if(localStream && peer) {
            const call = peer.call(MIXER_ID, localStream);
            call.on('stream', remoteStream => {
                incomingAudioEl.srcObject = remoteStream;
                incomingAudioEl.muted = !isRxOn;
                if(isRxOn) updateAudioRouting();
            });
        }
    }

    function connectData() {
        dataConn = peer.connect(MIXER_ID);
        dataConn.on('open', () => { 
            isMixerConnected = true; 
            sendCmd('RX_OFF'); 
            updateRXVisuals();
        });
        dataConn.on('close', () => { 
            isMixerConnected = false; 
            updateRXVisuals();
            setTimeout(connectData, 3000); 
        });
        dataConn.on('error', () => { isMixerConnected = false; updateRXVisuals(); });
    }
    function sendCmd(cmd) { if(dataConn && dataConn.open) dataConn.send({ cmd: cmd });
    }
    
    function updateConnectionStatus(connected) {
        const rec = document.getElementById('rec-indicator');
        if(connected) { rec.classList.add('rec-connected'); rec.classList.remove('rec-error'); } 
        else { rec.classList.add('rec-error'); rec.classList.remove('rec-connected');
        }
    }

    function updateRXVisuals() {
        const btn = document.getElementById('btn-rx');
        const rec = document.getElementById('rec-indicator');
        btn.className = "btn-rx"; btn.classList.remove('rx-pulse-green', 'rx-pulse-orange');
        rec.classList.remove('rec-connected', 'rec-error');
        if (!isRxOn) {
            btn.classList.add('rx-off');
            btn.innerHTML = "üî¥ RX OFF<br><span style='font-size:0.6rem; font-weight:normal;'>(AUDIO EN MEZCLADOR)</span>";
        } else {
            if (isMixerConnected) {
                btn.classList.add('rx-on-ok', 'rx-pulse-green');
                btn.innerHTML = "üü¢ RX ON<br><span style='font-size:0.6rem; font-weight:normal;'>(AUDIO AQU√ç)</span>";
                rec.classList.add('rec-connected');
            } else {
                btn.classList.add('rx-on-warn', 'rx-pulse-orange');
                btn.innerHTML = "üü† BUSCANDO...<br><span style='font-size:0.6rem; font-weight:normal;'>(SIN ENLACE)</span>";
                rec.classList.add('rec-error');
            }
        }
        updateAudioRouting();
    }

    function toggleRX() {
        isRxOn = !isRxOn;
        if(isRxOn) {
            if(incomingAudioEl) {
                incomingAudioEl.muted = false;
                incomingAudioEl.play().catch(e=>{});
            }
            sendCmd('RX_ON');
        } else {
            if(incomingAudioEl) incomingAudioEl.muted = true;
            sendCmd('RX_OFF');
        }
        updateRXVisuals();
    }

    function startLoadingSequence() {
        const txtMain = document.getElementById('loading-text-main');
        const txtSub = document.getElementById('loading-text-sub');
        const bar = document.getElementById('loading-bar');
        const perc = document.getElementById('loading-percent');
        const btn = document.getElementById('enter-btn');
        loadInterval = setInterval(() => {
            loadProgress += Math.random() * 2; if(loadProgress > 100) loadProgress = 100;
            if(loadProgress > 30 && loadProgress < 60) { txtMain.innerText = "ACTIVANDO SENSORES..."; txtSub.innerText = "CALIBRANDO GIROSCOPIO..."; }
            else if(loadProgress > 60 && loadProgress < 90) { txtMain.innerText = "SINTONIZANDO..."; txtSub.innerText = dataLoaded ? `SINCRONIZADO PROG:${dataStats.prog} | AUTO:${dataStats.auto}` : "ESPERANDO RED..."; }
           
             else if(loadProgress >= 99) {
                if(!dataLoaded) dataLoaded = true;
                clearInterval(loadInterval); loadProgress = 100;
                txtMain.innerText = "LISTO..."; txtSub.innerText = "SISTEMA ONLINE";
                btn.style.display = "block"; btn.classList.add('btn-glitch');
            }
    
            bar.style.width = loadProgress + "%"; perc.innerText = Math.floor(loadProgress) + "%";
        }, 5);
    }
    function initMatrix() { const pSection = matrixCanvas.parentElement; if(!pSection) return; matrixCanvas.width = pSection.clientWidth; matrixCanvas.height = pSection.clientHeight;
        const columns = Math.floor(matrixCanvas.width / 15); matrixDrops = Array(columns).fill(1); }
    function drawMatrix() {
        mCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
        mCtx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);
        mCtx.fillStyle = '#00f3ff'; mCtx.font = '10px Share Tech Mono';
        for(let i = 0; i < matrixDrops.length; i++) {
            let text = String.fromCharCode(65 + Math.floor(Math.random() * 26));
            if (Math.random() > 0.99 && autoData.length > 0) { text = autoData[Math.floor(Math.random() * autoData.length)].toUpperCase(); mCtx.fillStyle = '#ff0055';
            } else { mCtx.fillStyle = '#00f3ff'; }
            mCtx.fillText(text, i * 15, matrixCanvas.height - (matrixDrops[i] * 15));
            if(matrixCanvas.height - (matrixDrops[i] * 15) < 0 && Math.random() > 0.975) matrixDrops[i] = 0;
            matrixDrops[i]++;
        }
    }

    function setupZoomEvents() { touchLayer.addEventListener('touchstart', handleTouchStart, {passive: false}); touchLayer.addEventListener('touchmove', handleTouchMove, {passive: false});
        touchLayer.addEventListener('touchend', handleTouchEnd); touchLayer.addEventListener('mousedown', handleMouseDown); touchLayer.addEventListener('mouseup', handleMouseUp); }
    function handleTouchStart(e) { if (e.touches.length === 1) { isLongPressing = false;
        const t = e.touches[0]; longPressTimer = setTimeout(() => { triggerLongPressZoom(t.clientX, t.clientY); }, 600);
        } else if (e.touches.length === 2) { clearTimeout(longPressTimer); initialPinchDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        } }
    function handleTouchMove(e) { if (e.touches.length === 1) { clearTimeout(longPressTimer);
        } else if (e.touches.length === 2) { e.preventDefault(); clearTimeout(longPressTimer); const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        if (initialPinchDist > 0) { const delta = dist - initialPinchDist; zoomLevel += delta * 0.005;
        zoomLevel = Math.min(Math.max(1, zoomLevel), 5); applyZoom(); initialPinchDist = dist; } } }
    function handleTouchEnd(e) { if (longPressTimer) { clearTimeout(longPressTimer);
        if (!isLongPressing && e.touches.length === 0) { toggleUIOverlay(); } } isLongPressing = false;
    }
    function handleMouseDown(e) { isLongPressing = false; longPressTimer = setTimeout(() => { triggerLongPressZoom(e.clientX, e.clientY); }, 600);
    }
    function handleMouseUp(e) { clearTimeout(longPressTimer); if (!isLongPressing) toggleUIOverlay(); isLongPressing = false;
    }
    function triggerLongPressZoom(x, y) { isLongPressing = true; const rect = mainView.getBoundingClientRect();
        const relX = x - rect.left; const relY = y - rect.top; if (zoomLevel < 2.5) { zoomLevel = 3.0;
        } else { zoomLevel = 5.0; } zoomContainer.style.transformOrigin = `${relX}px ${relY}px`; applyZoom();
    }
    function resetZoomManual() { zoomLevel = 1.0; zoomContainer.style.transformOrigin = "center center"; applyZoom();
    }
    function applyZoom() { zoomContainer.style.transform = `scale(${zoomLevel})`; }
    function toggleUIOverlay() { if (uiVisible) hideControls();
        else showControls(); }
    function showControls() { uiVisible = true; document.getElementById('filter-controls-container').style.opacity = '1'; document.getElementById('filter-controls-container').style.pointerEvents = 'auto'; document.getElementById('logo-container').classList.add('ui-hiding'); document.getElementById('follow-banner').classList.add('ui-hiding');
        clearTimeout(hideTimeout); hideTimeout = setTimeout(hideControls, 5000); }
    function hideControls() { uiVisible = false; document.getElementById('filter-controls-container').style.opacity = '0';
        document.getElementById('filter-controls-container').style.pointerEvents = 'none'; document.getElementById('logo-container').classList.remove('ui-hiding'); document.getElementById('follow-banner').classList.remove('ui-hiding'); }

    async function enterApp(){
        document.getElementById('loading-overlay').style.display='none';
        document.getElementById('app-ui').style.opacity = 1;
        document.getElementById('app-ui').style.pointerEvents = 'auto';
        document.body.classList.add('panels-hidden');
        
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        masterGain = audioCtx.createGain(); masterGain.connect(audioCtx.destination);
        bgBuffer = await loadAudio('FONDO_1.mp3');
        
        initMic();
        await startCam(); await initMoveNet(); initSensors();
        initMatrix(); startBannerLoop();
        initPeer(); initTemp();
        loop();
    }

    async function startCam(){
        try{
            try { const s = await navigator.mediaDevices.getUserMedia({ audio: false, video: { facingMode: { exact: "environment" }, width: { ideal: 3840 }, height: { ideal: 2160 } } });
            handleStream(s); } 
            catch (e) { const s = await navigator.mediaDevices.getUserMedia({ audio: false, video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } });
            handleStream(s); }
        }catch(e){}
    }
    function handleStream(stream) { vid.srcObject = stream;
        videoTrack = stream.getVideoTracks()[0]; vid.onloadedmetadata = ()=> { resize(); document.getElementById('cam-res').innerText = `${vid.videoWidth}x${vid.videoHeight}`; }; window.onresize = resize;
    }
    function resize(){ const area = document.getElementById('main-view-area'); canvasSLS.width = area.clientWidth; canvasSLS.height = area.clientHeight; const ps=document.querySelector('.panel-section'); if(ps){matrixCanvas.width=ps.clientWidth;
        matrixCanvas.height=ps.clientHeight;} }

    async function toggleFilter(f){
        if(currentFilter===f) f='none';
        document.body.classList.remove('filter-night-vision', 'filter-negative', 'filter-sls', 'filter-focus');
        document.querySelectorAll('.filter-btn').forEach(b=> { if(b.id !== 'btn-hud') b.classList.remove('active'); });
        if(f!=='none') { document.body.classList.add('filter-'+f); document.querySelector(`button[onclick="toggleFilter('${f}')"]`).classList.add('active');
        }
        document.getElementById('main-filter-canvas').style.display = f==='sls'?'block':'none';
        if(videoTrack) try{ await videoTrack.applyConstraints({advanced:[{torch: f==='night-vision'}]});
        }catch(e){}
        currentFilter = f;
    }
    function toggleHUD(){ const body = document.body; const btn = document.getElementById('btn-hud'); body.classList.toggle('panels-hidden'); if(body.classList.contains('panels-hidden')) btn.classList.remove('active'); else btn.classList.add('active');
        setTimeout(resize, 550); }
    function setSensorStatus(id, s) { const el=document.getElementById(id); if(!el)return; el.className='sensor-item'; if(s==='main')el.classList.add('status-green'); else if(s==='backup')el.classList.add('status-blue'); else if(s==='sim')el.classList.add('status-orange');
        else el.classList.add('status-red'); }

    function initSensors(){
        let magActive=false, motionActive=false;
        const req = async () => {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') { try { const p=await DeviceOrientationEvent.requestPermission();
            if(p==='granted') window.addEventListener('deviceorientation', hOr); } catch(e){} } else window.addEventListener('deviceorientation', hOr);
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') { try { const p=await DeviceMotionEvent.requestPermission();
            if(p==='granted') window.addEventListener('devicemotion', hMot); } catch(e){} } else window.addEventListener('devicemotion', hMot);
        };
        const hOr = (e) => { if(e.alpha!==null){ document.getElementById('mag-val').innerText=Math.round(e.alpha).toString().padStart(3,'0'); setSensorStatus('sens-mag','main'); magActive=true;
        } };
        const hMot = (e) => { const a=e.accelerationIncludingGravity, r=e.rotationRate; if(a){ let t=Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z); document.getElementById('emf-val').innerText=(t*2.5).toFixed(1); setSensorStatus('sens-acc','main'); setSensorStatus('sens-lidar','sim'); motionActive=true;
        } if(r&&(r.alpha||r.beta||r.gamma)) setSensorStatus('sens-gyro','main'); };
        req(); initProximity();
        setInterval(()=>{ 
            if(!magActive) { setSensorStatus('sens-mag','sim'); document.getElementById('mag-val').innerText=Math.floor(Math.random()*360).toString().padStart(3,'0'); } 
            if(!motionActive) { setSensorStatus('sens-acc','sim'); setSensorStatus('sens-gyro','sim'); setSensorStatus('sens-lidar','status-red'); document.getElementById('emf-val').innerText=(0.3+Math.random()*0.9).toFixed(1); } 
        }, 500);
    }
    function initProximity(){ if('ProximitySensor' in window){ try { proxSensor=new ProximitySensor({frequency:10}); proxSensor.addEventListener('reading', ()=>{ document.getElementById('prox-val').innerText=proxSensor.value?proxSensor.value.toFixed(0):"0"; setSensorStatus('sens-prox','main'); }); proxSensor.start();
        } catch(e){ setSensorStatus('sens-prox','status-red'); } } else { setSensorStatus('sens-prox','sim'); setInterval(()=>{ if(Math.random()>0.95){ document.getElementById('prox-val').innerText=Math.floor(Math.random()*5); setTimeout(()=>document.getElementById('prox-val').innerText="0",800); } },1000);
        } }

    async function loadAudio(u){ try{const r=await fetch(u);const b=await r.arrayBuffer();return await audioCtx.decodeAudioData(b);}catch(e){return null;} }
    
    // FUNCION INITMIC CORREGIDA Y VINCULADA AL STREAMER MODE
    async function initMic(){ 
        try{ 
            const s=await navigator.mediaDevices.getUserMedia({audio:true});
            localStream=s; 
            micSource=audioCtx.createMediaStreamSource(s); 
            analyser=audioCtx.createAnalyser(); 
            analyser.fftSize=64; 
            micSource.connect(analyser); 
            
            // CONFIGURACION STREAMER MODE
            streamerGainNode = audioCtx.createGain();
            streamerGainNode.gain.value = 0; // Empieza muteado para evitar feedback
            micSource.connect(streamerGainNode);
            streamerGainNode.connect(audioCtx.destination);

            setSensorStatus('sens-mic','main'); 
            connectAudioToMixer(); 
        }catch(e){ 
            setSensorStatus('sens-mic','status-red'); 
        } 
    }
    
    function toggleSpirit(){
        isSpiritOn = !isSpiritOn;
        const btn = document.getElementById('btn-pwr');
        if(isSpiritOn){
            btn.innerText="APAGAR"; btn.classList.add('pwr-on'); document.getElementById('sb-status').innerText="INICIANDO...";
            if(audioCtx.state==='suspended') audioCtx.resume();
            if(bgBuffer){ bgNode=audioCtx.createBufferSource(); bgNode.buffer=bgBuffer; bgNode.loop=true; bgNode.playbackRate.value=scanSpeed; bgGain=audioCtx.createGain(); bgGain.gain.value=0.3; bgNode.connect(bgGain); bgGain.connect(masterGain); bgNode.start(0);
            }
            else startFallbackNoise();
            startListeningCycle();
        }else{
            btn.innerText="ENCENDER"; btn.classList.remove('pwr-on'); document.getElementById('sb-status').innerText="APAGADO";
            if(bgNode){bgNode.stop(); bgNode=null;} if(noiseNode){noiseNode.stop();
            noiseNode=null;}
            if(interferenceInterval) clearInterval(interferenceInterval);
            if(window.speechSynthesis) window.speechSynthesis.cancel();
            document.getElementById('voice-led').classList.remove('listening'); if(recognition) recognition.stop();
        }
    }

    function startFallbackNoise(){ if(noiseNode)return; const bSize=audioCtx.sampleRate*2, b=audioCtx.createBuffer(1,bSize,audioCtx.sampleRate), d=b.getChannelData(0); for(let i=0;i<bSize;i++)d[i]=Math.random()*2-1; noiseNode=audioCtx.createBufferSource(); noiseNode.buffer=b; noiseNode.loop=true;
        const f=audioCtx.createBiquadFilter(); f.type="bandpass"; f.frequency.value=1000; noiseGain=audioCtx.createGain(); noiseGain.gain.value=0.05; noiseNode.connect(f); f.connect(noiseGain); noiseGain.connect(masterGain); noiseNode.start(0); }
    document.getElementById('speed-slider').addEventListener('input', e=>{ scanSpeed=parseFloat(e.target.value); document.getElementById('spd-txt').innerText=scanSpeed; if(bgNode)bgNode.playbackRate.value=scanSpeed===1?0.8:scanSpeed===2?1.0:1.5; });
    function startListeningCycle(){
        if(isProcessingResponse || !isSpiritOn || isIntroPlaying) return;
        if(isRecognizing) return;
        document.getElementById('sb-status').innerText = "SINTONIZANDO...";
        if(!recognition) {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(SR) {
                recognition = new SR();
                recognition.lang='es-MX'; recognition.continuous=false;
                recognition.onstart = () => { isRecognizing=true; document.getElementById('voice-led').classList.add('listening'); };
                recognition.onend = () => { isRecognizing=false; document.getElementById('voice-led').classList.remove('listening');
                    if(!isProcessingResponse && isSpiritOn) {
                        if(micMaxVol > 15) { isProcessingResponse = true;
                        processVoiceCommand("NOISE_TRIGGER"); } 
                        else { setTimeout(startListeningCycle, 500);
                        }
                    }
                };
                recognition.onresult = (e) => { processVoiceCommand(e.results[0][0].transcript.toLowerCase().trim()); };
                recognition.onerror = () => { isRecognizing=false; if(isSpiritOn) setTimeout(startListeningCycle, 1000); };
            }
        }
        try{ recognition.start();
        }catch(e){}
    }
    
    function processVoiceCommand(txt){
        document.getElementById('voice-led').classList.remove('listening');
        document.getElementById('sb-status').innerText = "PROCESANDO...";
        let response = null;
        if(txt!=="NOISE_TRIGGER"){ for(let [k,v] of progData){ if(txt.includes(k)){ response=v; break;
        } } }
        if(!response) response = autoData[Math.floor(Math.random()*autoData.length)];
        speak(response);
    }
    
    function restoreAudioLevels() {
        const now = audioCtx.currentTime;
        if(bgGain) { bgGain.gain.cancelScheduledValues(now); bgGain.gain.setValueAtTime(bgGain.gain.value, now); bgGain.gain.linearRampToValueAtTime(0.3, now + 0.5); }
        if(noiseGain) { noiseGain.gain.cancelScheduledValues(now);
        noiseGain.gain.linearRampToValueAtTime(0.05, now + 0.5); }
    }

    function speak(txt){
        if(!window.speechSynthesis) { isProcessingResponse = false;
        return; }
        window.speechSynthesis.cancel();
        document.getElementById('sb-status').innerText = "DESCODIFICANDO...";
        const now = audioCtx.currentTime;
        if(bgGain) { bgGain.gain.cancelScheduledValues(now);
        bgGain.gain.setValueAtTime(bgGain.gain.value, now); bgGain.gain.linearRampToValueAtTime(0.0, now + 0.1); }
        clearTimeout(restoreAudioTimer);
        restoreAudioTimer = setTimeout(restoreAudioLevels, (txt.length * 100) + 2000); 
        const u = new SpeechSynthesisUtterance(txt); u.lang='es-MX'; u.rate = 1.0; u.pitch = 1.0;
        u.volume = 1.0; 
        u.onend = () => { isProcessingResponse = false; clearTimeout(restoreAudioTimer); restoreAudioLevels(); if(isSpiritOn) setTimeout(startListeningCycle, 1500); };
        u.onerror = () => { isProcessingResponse = false; restoreAudioLevels(); };
        window.speechSynthesis.speak(u);
    }

    document.getElementById('vol-slider').addEventListener('input', e=>{ if(masterGain) masterGain.gain.value = e.target.value/100; document.getElementById('vol-txt').innerText=e.target.value+"%"; });

    let lastFps=0, frames=0;
    function loop(){
        frames++;
        if(performance.now()-lastFps>=1000){ document.getElementById('cam-fps').innerText = frames; frames=0; lastFps=performance.now();
        }
        
        // SLS V16.6 LOGIC
        if(currentFilter==='sls' && vid.readyState >= 2){ 
            ctxSLS.clearRect(0,0,canvasSLS.width,canvasSLS.height);
            if (latestPoses.length > 0) drawSLS(latestPoses); 
        }
        
        drawMatrix();
        if(analyser){
            const data = new Uint8Array(analyser.frequencyBinCount); analyser.getByteFrequencyData(data);
            let sum=0;
            for(let i=0; i<data.length; i++) sum+=data[i]; let avg=sum/data.length; 
            if(isRxOn) {
               if(isMixerConnected && avg > 10) document.getElementById('btn-rx').classList.add('rx-pulse-green');
                else document.getElementById('btn-rx').classList.remove('rx-pulse-green');
            }
            if(isRecognizing && !isProcessingResponse) { if(avg > micMaxVol) micMaxVol=avg;
            }
            for(let i=0; i<NUM_BARS; i++){ let val=(data[i*2] + (data[i*2+1]||0))/2;
            let bar=energyBars[i]; bar.className='energy-bar-seg'; if(val>50)bar.classList.add('active'); if(val>150)bar.classList.add('mid'); if(val>220)bar.classList.add('high'); bar.style.height=Math.max(5,(val/255)*100)+"%"; }
        }

        // SENSOR SIMULATION
        if(proxSensor) {
            if(currentFilter==='sls' && latestPoses.length > 0) targetProx = Math.min(99, (latestPoses[0].score * 100));
            else targetProx = Math.random() * 3;
        } else {
            if(currentFilter==='sls' && latestPoses.length > 0) targetProx = Math.random() * 90;
            else targetProx = Math.random() * 3;
        }
        
        if(Math.abs(currentProx - targetProx) > 1) currentProx += (targetProx - currentProx) * 0.1;
        document.getElementById('prox-val').innerText = Math.floor(currentProx).toString();

        const now = performance.now();
        if(now - lastTempTime > 3000) { let drop = 2 + Math.random() * 6;
        targetTemp = baseTemp - drop; lastTempTime = now; }
        if(Math.abs(currentTemp - targetTemp) > 0.1) currentTemp += (targetTemp - currentTemp) * 0.02;
        document.getElementById('temp-display').innerText = currentTemp.toFixed(1);

        requestAnimationFrame(loop);
    }

    async function loadData(){ try { const r=await fetch(SCRIPT_URL); if(!r.ok)throw new Error("Red");
        const d=await r.json(); if(d.automatico)autoData=d.automatico.map(x=>x.TEXTO); if(d.programado)d.programado.forEach(i=>{if(i.PREGUNTA)progData.set(i.PREGUNTA.toLowerCase().trim(), i.RESPUESTA)}); dataLoaded=true; dataStats.prog=d.programado?d.programado.length:0; dataStats.auto=d.automatico?d.automatico.length:0; } catch(e){ dataLoaded=false;
        } }

    let latestPoses = [];
    async function initMoveNet() { 
        await tf.ready();
        detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet, { modelType: poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING }); 
        setInterval(async () => { 
            // RESTORED v13.9 Logic: Threshold 0.15
            if(currentFilter==='sls' && vid.readyState>=2) { 
                try { latestPoses = await detector.estimatePoses(vid, {maxPoses: 5, scoreThreshold: 0.15}); } catch(e) { latestPoses = []; } 
            } else { latestPoses = []; } 
   
            }, 100); 
    }
    
    const conns = [['left_shoulder','right_shoulder'],['left_shoulder','left_hip'],['right_shoulder','right_hip'],['left_hip','right_hip'],['left_shoulder','left_elbow'],['left_elbow','left_wrist'],['right_shoulder','right_elbow'],['right_elbow','right_wrist'],['left_hip','left_knee'],['left_knee','left_ankle'],['right_hip','right_knee'],['right_knee','right_ankle']];
    function drawSLS(poses) {
        const s = Math.max(canvasSLS.width/vid.videoWidth, canvasSLS.height/vid.videoHeight);
        const xo = (canvasSLS.width - vid.videoWidth*s)/2;
        const yo = (canvasSLS.height - vid.videoHeight*s)/2;
        ctxSLS.lineWidth = 3; ctxSLS.lineCap = 'round';
        ctxSLS.strokeStyle = '#00ff41'; ctxSLS.shadowBlur = 10; ctxSLS.shadowColor = '#00ff41';
        poses.forEach(p => { 
            if(p.score < 0.15) return; 
            const kp = p.keypoints; const m = {}; kp.forEach(k => m[k.name] = k); 
            ctxSLS.beginPath(); 
            conns.forEach(([a,b]) => { 
                const p1 = 
                m[a]; const p2 = m[b]; 
                if(p1 && p2 && p1.score > 0.20 && p2.score > 0.20) { ctxSLS.moveTo(p1.x*s + xo, p1.y*s + yo); ctxSLS.lineTo(p2.x*s + xo, p2.y*s + yo); } 
            }); 
            ctxSLS.stroke(); 
            ctxSLS.fillStyle = '#ff0055'; 
            kp.forEach(k 
            => { if(k.score > 0.20) { ctxSLS.beginPath(); ctxSLS.arc(k.x*s + xo, k.y*s + yo, 4, 0, 2*Math.PI); ctxSLS.fill(); } }); 
        });
    }

    // FUNCION TOGGLE STREAMER (NUEVA)
    function toggleStreamerMode() {
        if(!streamerGainNode) return;
        
        const btn = document.getElementById('btn-streamer');
        const isMuted = streamerGainNode.gain.value === 0;

        if (isMuted) {
            // ACTIVAR
            streamerGainNode.gain.value = 1.0; // Audio pasa a altavoces
            btn.innerHTML = '<i class="fas fa-broadcast-tower"></i> EN VIVO (ON)';
            btn.style.borderColor = '#bd00ff'; // Color Violeta TikTok
            btn.style.color = '#bd00ff';
            btn.style.background = 'rgba(50, 0, 50, 0.5)';
            btn.style.boxShadow = '0 0 15px #bd00ff inset';
        } else {
            // DESACTIVAR
            streamerGainNode.gain.value = 0; // Silenciar ruta a altavoces
            btn.innerHTML = '<i class="fas fa-headset"></i> ACTIVAR MONITOR';
            // Restaurar estilos por defecto
            btn.style.borderColor = ''; 
            btn.style.color = '';
            btn.style.background = '';
            btn.style.boxShadow = '';
        }
    }
</script>
</body>
</html>
