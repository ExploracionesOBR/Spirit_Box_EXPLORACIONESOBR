<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DETECTOR-OBR + MEZCLADOR INTEGRADO</title> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@500;700;900&family=Creepster&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILOS DEL DETECTOR (BASE) --- */
        :root {
            --hud-bg: #050510; 
            --hud-cyan: #00f3ff; 
            --hud-pink: #ff0055; 
            --hud-green: #00ff41; 
            --hud-orange: #ffae00;
            --hud-red: #ff3333;
            --hud-blue: #0088ff;
            --glass-panel: rgba(5, 8, 15, 0.95);
            --left-panel-w: 260px; /* Ajustado para m√≥viles */
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: #000; color: var(--hud-cyan);
            overflow: hidden; width: 100vw; height: 100vh; margin: 0;
            touch-action: none; user-select: none;
        }

        /* Layout Principal */
        #app-ui { 
            width: 100%; height: 100%; display: grid;
            grid-template-columns: var(--left-panel-w) 1fr; 
            grid-template-rows: 1fr;
            grid-template-areas: "left cam";
            transition: all 0.5s ease;
        }

        /* Panel Izquierdo (HUD) */
        #left-panel { 
            grid-area: left; border-right: 2px solid var(--hud-cyan); 
            background: var(--glass-panel); z-index: 50; padding: 10px;
            display: flex; flex-direction: column; gap: 10px;
            overflow-y: auto;
        }

        /* Area de Camara */
        #main-view-area { 
            grid-area: cam; position: relative; overflow: hidden; background: #000;
        }
        #bg-camera-feed { width: 100%; height: 100%; object-fit: cover; }
        #main-filter-canvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; }
        #matrix-canvas { position: absolute; inset: 0; opacity: 0.2; pointer-events: none; }

        /* Elementos HUD Overlay */
        .rec-container { position: absolute; top: 20px; left: 20px; color: var(--hud-red); font-family: 'Orbitron'; font-weight: bold; display: flex; align-items: center; gap: 8px; z-index: 30; }
        .rec-dot { width: 12px; height: 12px; background: var(--hud-red); border-radius: 50%; animation: blinkRed 1s infinite; }
        @keyframes blinkRed { 50% { opacity: 0.3; } }

        .stats-container { position: absolute; bottom: 20px; right: 20px; font-size: 0.8rem; text-align: right; z-index: 30; text-shadow: 0 0 2px #000; }

        /* Botones del Detector */
        .btn-control { 
            background: rgba(0,20,30,0.6); border: 1px solid var(--hud-cyan); color: var(--hud-cyan);
            font-family: 'Orbitron'; padding: 12px; width: 100%; cursor: pointer; 
            text-align: center; margin-bottom: 5px; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            transition: 0.2s;
        }
        .btn-control:active { background: var(--hud-cyan); color: #000; }
        
        /* EL BOTON RX (Ahora abre el Mezclador) */
        #btn-rx {
            border-color: var(--hud-orange); color: var(--hud-orange);
            font-weight: bold; animation: pulseBorder 2s infinite;
        }
        @keyframes pulseBorder { 0% { box-shadow: 0 0 0 var(--hud-orange); } 50% { box-shadow: 0 0 10px var(--hud-orange); } }

        /* --- ESTILOS DEL MEZCLADOR (OVERLAY) --- */
        #mixer-overlay {
            position: fixed; inset: 0; z-index: 1000;
            background: rgba(5, 5, 8, 0.95);
            backdrop-filter: blur(10px);
            display: none; /* Oculto por defecto */
            flex-direction: column;
            padding: 10px;
            animation: slideUp 0.3s ease-out;
        }
        #mixer-overlay.active { display: flex; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .mixer-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--hud-cyan); padding-bottom: 10px; margin-bottom: 10px;
        }
        .close-mixer-btn {
            background: var(--hud-red); color: #fff; border: none; 
            width: 40px; height: 40px; border-radius: 5px; font-weight: bold; font-size: 1.2rem;
        }

        /* Estilos especificos de la consola del Mezclador (Adaptados) */
        #console-container { 
            display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; height: 100%; align-items: flex-start;
        }
        .channel-strip { 
            background: rgba(20,20,30,0.8); border: 1px solid #444; border-radius: 6px; 
            padding: 10px; width: 100px; min-width: 100px; display: flex; flex-direction: column; gap: 5px; align-items: center;
        }
        .fader-group {
            height: 150px; display: flex; gap: 5px; width: 100%; justify-content: center;
            background: rgba(0,0,0,0.3); padding: 5px; border-radius: 4px;
        }
        input[type=range][orient=vertical] {
            writing-mode: bt-lr; -webkit-appearance: slider-vertical;
            width: 40px; height: 100%; accent-color: var(--hud-cyan);
        }
        .vu-meter-wrap {
            width: 12px; height: 100%; background: #111; position: relative; border-radius: 2px;
        }
        .vu-active {
            position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, #0f0, #ff0, #f00);
            height: 0%; transition: height 0.05s;
        }
        .btn-mute {
            width: 100%; background: #333; color: #fff; border: 1px solid #555; padding: 5px; font-size: 0.7rem; cursor: pointer;
        }
        .btn-mute.muted { background: var(--hud-red); border-color: red; }
        
        .strip-title { color: #aaa; font-size: 0.7rem; font-weight: bold; overflow: hidden; white-space: nowrap;}
        .vol-display { background: transparent; border: none; color: var(--hud-cyan); font-family: 'Orbitron'; text-align: center; width: 100%; font-size: 0.9rem;}

    </style>
</head>
<body>

    <div id="app-ui">
        
        <div id="left-panel">
            <div style="color:var(--hud-cyan); font-family:'Orbitron'; border-bottom:1px solid var(--hud-cyan); padding-bottom:5px; margin-bottom:10px;">
                <i class="fas fa-ghost"></i> EXPLORACIONES OBR
            </div>

            <div class="panel-section">
                <div class="section-title">SENSORES</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; font-size:0.7rem;">
                    <div class="btn-control" style="font-size:0.7rem;">TEMP: <span id="temp-display">22.4</span>¬∞C</div>
                    <div class="btn-control" style="font-size:0.7rem;">PROX: <span id="prox-val">0</span>%</div>
                </div>
            </div>

            <div class="panel-section">
                <div class="section-title">VISI√ìN</div>
                <button class="btn-control" onclick="setFilter('normal')">NORMAL</button>
                <button class="btn-control" onclick="setFilter('night')">NOCTURNA</button>
                <button class="btn-control" onclick="setFilter('thermal')">T√âRMICA</button>
                <button class="btn-control" onclick="setFilter('sls')" style="border-color:var(--hud-green); color:var(--hud-green);">SLS KINECT</button>
            </div>

            <div style="margin-top:auto;">
                <div style="font-size:0.6rem; color:#666; text-align:center;">SISTEMA DE AUDIO</div>
                <button id="btn-rx" class="btn-control" onclick="toggleMixer()">
                    <i class="fas fa-sliders-h"></i> RX : MIXER
                </button>
            </div>
        </div>

        <div id="main-view-area">
            <video id="bg-camera-feed" autoplay playsinline muted></video>
            <canvas id="matrix-canvas"></canvas>
            <canvas id="main-filter-canvas"></canvas> <div class="rec-container">
                <div class="rec-dot"></div> REC ‚óè 00:00:00
            </div>

            <div class="stats-container">
                <div>FPS: <span style="color:#fff;">60</span></div>
                <div>BAT: <span style="color:var(--hud-green);">98%</span></div>
            </div>
            
            <div id="logo-container" style="position:absolute; top:15px; right:15px;">
                <div style="color:var(--hud-cyan); font-family:'Creepster'; font-size:1.5rem;">OBR</div>
            </div>
        </div>
    </div>


    <div id="mixer-overlay">
        <div class="mixer-header">
            <div style="font-family:'Orbitron'; color:var(--hud-cyan); font-size:1.2rem;">
                <i class="fas fa-broadcast-tower"></i> MEZCLADOR OBR
            </div>
            <button class="close-mixer-btn" onclick="toggleMixer()">√ó</button>
        </div>

        <div style="display:flex; justify-content:center; gap:10px; margin-bottom:10px;">
             <button class="btn-control" style="width:auto; padding:5px 15px;" onclick="startAudioSystem()">
                <i class="fas fa-power-off"></i> INICIAR AUDIO
             </button>
             <button class="btn-control" style="width:auto; padding:5px 15px;" onclick="showQR()">
                <i class="fas fa-qrcode"></i> VER ID
             </button>
        </div>

        <div id="console-container">
            <div class="channel-strip">
                <div class="strip-title">üé§ LOCAL</div>
                <input type="number" class="vol-display" id="val-mic" value="100">
                <div class="fader-group">
                    <input type="range" orient="vertical" id="fader-mic" min="0" max="200" value="100" oninput="syncVol('mic', this.value)">
                    <div class="vu-meter-wrap"><div class="vu-active" id="meter-mic"></div></div>
                </div>
                <button class="btn-mute" onclick="toggleMute('mic')">MUTE</button>
            </div>

            <div class="channel-strip" style="border-color:var(--hud-cyan);">
                <div class="strip-title">üîä MASTER</div>
                <input type="number" class="vol-display" id="val-out" value="100">
                <div class="fader-group">
                    <input type="range" orient="vertical" id="fader-out" min="0" max="200" value="100" oninput="syncVol('out', this.value)">
                    <div class="vu-meter-wrap"><div class="vu-active" id="meter-out"></div></div>
                </div>
                <button class="btn-mute" onclick="toggleMute('out')">MUTE</button>
            </div>
            
            </div>

        <div id="qr-area" style="display:none; position:absolute; inset:0; background:rgba(0,0,0,0.9); z-index:2000; flex-direction:column; align-items:center; justify-content:center;">
            <div id="qrcode" style="background:#fff; padding:10px;"></div>
            <br>
            <button class="btn-control" style="width:auto;" onclick="document.getElementById('qr-area').style.display='none'">CERRAR</button>
        </div>
    </div>
    
    <audio id="silence-hack" loop src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"></audio>

    <script>
        // === LOGICA DEL DETECTOR (Camara, Filtros, SLS) ===
        const vid = document.getElementById('bg-camera-feed');
        const canvasSLS = document.getElementById('main-filter-canvas');
        const ctxSLS = canvasSLS.getContext('2d');
        let currentFilter = 'normal';
        let detector;

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                vid.srcObject = stream;
                vid.onloadedmetadata = () => {
                    canvasSLS.width = vid.videoWidth;
                    canvasSLS.height = vid.videoHeight;
                    loopDetector();
                };
            } catch (e) { alert("Error Camara: " + e); }
        }

        async function initMoveNet() {
            await tf.ready();
            detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet, { modelType: poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING });
        }

        function setFilter(type) {
            currentFilter = type;
            document.body.className = ''; // Reset clases
            if(type === 'night') document.body.classList.add('filter-night-vision'); // Necesita CSS especifico
            if(type === 'sls') { 
                canvasSLS.style.display = 'block'; 
            } else {
                canvasSLS.style.display = 'none';
            }
        }

        async function loopDetector() {
            // Simulacion de deteccion SLS (simplificado para ejemplo)
            if(currentFilter === 'sls' && detector) {
                const poses = await detector.estimatePoses(vid);
                ctxSLS.clearRect(0, 0, canvasSLS.width, canvasSLS.height);
                if(poses.length > 0) drawSkeleton(poses);
            }
            
            // Simular datos sensores
            document.getElementById('temp-display').innerText = (20 + Math.random()).toFixed(1);
            document.getElementById('prox-val').innerText = Math.floor(Math.random() * 5);
            
            requestAnimationFrame(loopDetector);
        }

        function drawSkeleton(poses) {
            poses.forEach(pose => {
                pose.keypoints.forEach(keypoint => {
                    if(keypoint.score > 0.3) {
                        ctxSLS.beginPath();
                        ctxSLS.arc(keypoint.x, keypoint.y, 5, 0, 2*Math.PI);
                        ctxSLS.fillStyle = '#00ff41';
                        ctxSLS.fill();
                    }
                });
            });
        }

        // === LOGICA DEL MEZCLADOR (Audio & PeerJS) ===
        let audioCtx, micNode, outNode, micAnal, outAnal;
        let peer;
        const FIXED_ID = "obr-explorer-" + Math.floor(Math.random()*1000);

        function toggleMixer() {
            const overlay = document.getElementById('mixer-overlay');
            if(overlay.style.display === 'flex') {
                overlay.style.display = 'none';
            } else {
                overlay.style.display = 'flex';
            }
        }

        async function startAudioSystem() {
            document.getElementById('silence-hack').play();
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            await audioCtx.resume();

            // Setup Mic Local
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const source = audioCtx.createMediaStreamSource(stream);
            micNode = audioCtx.createGain();
            micAnal = audioCtx.createAnalyser();
            
            source.connect(micNode);
            micNode.connect(micAnal); // Para VU Meter
            micNode.connect(audioCtx.destination); // Salida local (monitor)

            animateVU(micAnal, 'meter-mic');

            // Setup Salida (Simulada para monitor)
            outNode = audioCtx.createGain();
            outAnal = audioCtx.createAnalyser();
            micNode.connect(outNode);
            outNode.connect(outAnal);
            animateVU(outAnal, 'meter-out');

            initPeer();
        }

        function initPeer() {
            if(peer) return;
            peer = new Peer(FIXED_ID);
            peer.on('open', id => {
                new QRCode(document.getElementById("qrcode"), id);
                alert("Sistema Audio ONLINE. ID: " + id);
            });
            peer.on('call', call => {
                call.answer(); // Responder automaticamente
                // Aqui iria logica para crear canal nuevo en UI
                alert("Conexi√≥n Audio Entrante...");
            });
        }

        function syncVol(type, val) {
            const gain = val / 100;
            if(type === 'mic' && micNode) micNode.gain.value = gain;
            if(type === 'out' && outNode) outNode.gain.value = gain;
            
            // Sync numeros
            if(type==='mic') document.getElementById('val-mic').value = val;
            if(type==='out') document.getElementById('val-out').value = val;
        }

        function animateVU(analyser, elemId) {
            const arr = new Uint8Array(analyser.frequencyBinCount);
            const el = document.getElementById(elemId);
            function draw() {
                analyser.getByteFrequencyData(arr);
                let sum = 0; for(let i=0; i<arr.length; i++) sum += arr[i];
                let avg = sum / arr.length;
                el.style.height = (avg * 1.5) + "%";
                requestAnimationFrame(draw);
            }
            draw();
        }

        function showQR() {
            document.getElementById('qr-area').style.display = 'flex';
        }

        // INICIO AUTOMATICO
        initCamera();
        initMoveNet();

    </script>
</body>
</html>
