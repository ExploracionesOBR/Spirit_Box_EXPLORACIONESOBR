<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>DETECTOR-OBR v6.5 ULTIMATE</title> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@500;700;900&family=Creepster&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <style>
        :root {
            --hud-bg: #050510; 
            --hud-cyan: #00f3ff; 
            --hud-pink: #ff0055; 
            --hud-green: #00ff41; 
            --hud-orange: #ffae00;
            --hud-red: #ff3333;
            --glass-panel: rgba(5, 8, 15, 0.98); /* M√°s opaco para contraste */
            --panel-w: 340px; /* Ancho Panel Izquierdo */
            --panel-h: 130px; /* Alto Panel Inferior */
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: var(--hud-bg); color: var(--hud-cyan);
            overflow: hidden; width: 100vw; height: 100vh; margin: 0;
            background-image: radial-gradient(circle at center, #0a0a15 0%, #000 100%);
        }

        #app-ui { width: 100%; height: 100%; position: relative; touch-action: none; }

        /* --- LAYOUT DE C√ÅMARA (AJUSTE PERFECTO) --- */
        #main-view-area {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: 5; background: #000; 
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        #bg-camera-feed {
            position: absolute; top: 50%; left: 50%;
            min-width: 100%; min-height: 100%; width: auto; height: auto;
            object-fit: cover; transform: translate(-50%, -50%); z-index: 1; opacity: 0.9;
        }
        
        /* --- FILTROS MEJORADOS --- */
        /* NVG: M√°s oscuro, m√°s contraste, menos brillo lavado */
        body.filter-night-vision #bg-camera-feed { 
            filter: grayscale(100%) sepia(100%) hue-rotate(90deg) brightness(0.9) contrast(1.4) saturate(400%); 
        }
        /* Pseudo-elemento para ruido en NVG */
        body.filter-night-vision #main-view-area::after {
            content: ""; position: absolute; inset: 0; z-index: 2;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.15'/%3E%3C/svg%3E");
            pointer-events: none; opacity: 0.3; mix-blend-mode: overlay;
        }

        body.filter-negative #bg-camera-feed { filter: invert(1) hue-rotate(180deg); }
        
        #main-filter-canvas, #gl-bluewave { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
        body.filter-sls #main-filter-canvas { display: block; z-index: 3; }
        body.filter-spectral #gl-bluewave { display: block; z-index: 4; mix-blend-mode: screen; } /* Nuevo Filtro Espectro */

        /* --- PANELES UNIFICADOS --- */
        #left-panel, #bottom-panel {
            position: fixed; display: flex; flex-direction: column;
            z-index: 20; pointer-events: none; 
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            background-color: var(--glass-panel); 
            border: 1px solid rgba(0, 243, 255, 0.2);
            box-shadow: 0 0 0 1px #000; /* Borde negro para separar visualmente */
        }

        body.panels-active #left-panel, body.panels-active #bottom-panel { transform: translate(0, 0); pointer-events: auto; }

        .panel { padding: 8px; display: flex; flex-direction: column; gap: 6px; height: 100%; box-sizing: border-box; position: relative; }
        .panel-section { background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(255,255,255,0.08); padding: 6px; margin-bottom: 2px; }
        .section-title { 
            font-family: 'Orbitron'; font-size: 0.65rem; font-weight: 800; 
            color: var(--hud-cyan); text-transform: uppercase; letter-spacing: 1px; 
            margin-bottom: 4px; border-bottom: 1px solid rgba(0, 243, 255, 0.3); 
        }

        /* SENSORES */
        .sensor-row { display: flex; align-items: center; justify-content: space-between; font-size: 0.6rem; margin-bottom: 3px; padding: 2px; }
        .sensor-led { width: 6px; height: 6px; border-radius: 50%; margin-right: 6px; background: #333; transition: 0.3s; }
        .led-green { background: var(--hud-green); box-shadow: 0 0 6px var(--hud-green); }
        .led-blue { background: var(--hud-blue); box-shadow: 0 0 6px var(--hud-blue); }
        .led-orange { background: var(--hud-orange); box-shadow: 0 0 6px var(--hud-orange); }
        .led-red { background: var(--hud-red); }

        /* SPIRIT BOX & RADAR */
        .spirit-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        
        /* LED COMANDO (VERDE) */
        .voice-led { width: 10px; height: 10px; border-radius: 50%; background: #111; border: 1px solid #444; transition: 0.1s; }
        .voice-led.listening { background: var(--hud-green); box-shadow: 0 0 15px var(--hud-green), inset 0 0 5px #fff; animation: pulseGreen 0.5s infinite; }
        @keyframes pulseGreen { 0%{opacity:0.5;} 50%{opacity:1;} 100%{opacity:0.5;} }

        .control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin: 5px 0; }
        .btn-control {
            background: #111; border: 1px solid #444; color: #888;
            font-family: 'Orbitron'; font-size: 0.6rem; padding: 8px;
            cursor: pointer; transition: all 0.2s; text-align: center;
        }
        .btn-control:active { transform: scale(0.95); }
        .pwr-on { background: rgba(0,50,0,0.5); border-color: var(--hud-green); color: var(--hud-green); }
        .pwr-off { background: rgba(50,0,0,0.5); border-color: var(--hud-red); color: var(--hud-red); }
        .spd-1 { border-color: var(--hud-blue); color: var(--hud-blue); }
        .spd-2 { border-color: var(--hud-orange); color: var(--hud-orange); }
        .spd-3 { border-color: var(--hud-red); color: var(--hud-red); }

        /* RADAR PROXIMIDAD (ESPACIO AMARILLO) */
        #radar-container {
            width: 100%; height: 70px; background: #000; border: 1px solid #333;
            position: relative; overflow: hidden; margin-top: 5px;
            background-image: radial-gradient(rgba(0, 243, 255, 0.1) 1px, transparent 1px);
            background-size: 10px 10px;
            display: flex; justify-content: center; align-items: center;
        }
        #radar-scan {
            position: absolute; top: 50%; left: 50%; width: 120%; height: 120%;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(0, 255, 65, 0.1) 60deg, rgba(0, 255, 65, 0.8) 90deg, transparent 91deg);
            transform-origin: top left;
            animation: radarSpin 2s linear infinite;
            border-radius: 50%;
            margin-top: -60%; margin-left: -60%; /* Centrar pivote */
        }
        #radar-text {
            position: absolute; bottom: 2px; right: 4px; font-size: 0.5rem; color: var(--hud-green);
            font-family: 'Orbitron';
        }
        @keyframes radarSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* PANEL INFERIOR */
        .dials-grid { 
            display: grid; 
            grid-template-columns: 60px 60px 60px 1fr 70px; /* Ajuste fino */
            gap: 8px; align-items: center; height: 100%;
        }
        .dial-wrapper { text-align: center; position: relative; }
        .dial-container { width: 50px; height: 50px; border-radius: 50%; margin: 0 auto; background: #0b0c15; box-shadow: inset 0 0 5px #000; position: relative; border: 1px solid #222; }
        .dial-needle { position: absolute; width: 2px; height: 20px; background: #fff; bottom: 50%; left: 50%; transform-origin: bottom center; transform: translateX(-50%) rotate(-45deg); z-index: 2; transition: transform 0.3s ease; }
        .knob-label { font-size: 0.5rem; color: var(--hud-cyan); margin-top: 2px; font-weight: bold; }

        /* GRAPH */
        #energy-display { height: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: flex-end; padding: 2px; gap: 2px; }
        .energy-bar { flex: 1; height: 5%; background: linear-gradient(to top, var(--hud-green), var(--hud-orange), var(--hud-red)); opacity: 0.8; transition: height 0.05s; }
        
        /* STATS */
        #panel-sys-stats { font-size: 0.6rem; color: var(--hud-green); line-height: 1.4; border-left: 1px dashed #333; padding-left: 5px; }

        /* ELEMENTOS FLOTANTES */
        .persistent-ui { position: fixed; z-index: 50; pointer-events: none; transition: opacity 0.3s; }
        .ui-hiding { opacity: 0 !important; }

        /* BANNER TERROR */
        #follow-banner {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; align-items: center; z-index: 20;
            opacity: 0; transition: opacity 1s; pointer-events: none;
        }
        #follow-banner.show { opacity: 1; }
        .follow-text { font-family: 'Creepster'; font-size: 1.2rem; color: #ff0000; text-shadow: 2px 2px 0 #000; animation: glitch 2s infinite; }
        .social-icons svg { width: 18px; fill: #fff; margin: 0 5px; filter: drop-shadow(0 0 3px red); }
        @keyframes glitch { 0%{transform:skew(0);} 20%{transform:skew(-5deg);} 22%{transform:skew(5deg);} 100%{transform:skew(0);} }

        /* LOGO */
        #logo-image { position: fixed; top: 20px; right: 20px; width: 70px; filter: drop-shadow(0 0 5px var(--hud-cyan)); z-index: 50; pointer-events: none; animation: float 4s infinite; }
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-5px);} }

        /* CONTROLES */
        #filter-controls-container { position: fixed; top: 50%; right: 15px; transform: translateY(-50%); display: flex; flex-direction: column; gap: 8px; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .filter-btn { width: 45px; height: 40px; background: rgba(0, 10, 20, 0.9); color: var(--hud-cyan); font-family: 'Orbitron'; font-size: 0.6rem; border: 1px solid var(--hud-cyan); clip-path: polygon(15% 0, 100% 0, 100% 85%, 85% 100%, 0 100%, 0 15%); cursor: pointer; }
        .filter-btn.active { background: var(--hud-cyan); color: #000; }

        /* INPUT RANGE LARGO */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin-top: 5px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #333; border: 1px solid #555; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 20px; background: var(--hud-cyan); margin-top: -4px; cursor: pointer; }

        /* LOADING */
        #loading-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; background: radial-gradient(#111, #000); }
        .loader-logo { width: 90px; margin-bottom: 15px; animation: pulseG 2s infinite; }
        @keyframes pulseG { 0%{filter:drop-shadow(0 0 2px cyan);} 50%{filter:drop-shadow(0 0 10px cyan);} 100%{filter:drop-shadow(0 0 2px cyan);} }
        #enter-btn { display: none; padding: 10px 30px; border: 2px solid var(--hud-green); color: var(--hud-green); background: transparent; font-family: 'Orbitron'; font-size: 1.1rem; cursor: pointer; margin-top: 20px; }

        /* RESPONSIVE - UNIFICACI√ìN DE PANELES */
        @media (min-aspect-ratio: 1/1) { /* LANDSCAPE */
            #left-panel { top: 0; left: 0; width: var(--panel-w); height: 100vh; transform: translateX(-100%); border-right: 1px solid var(--hud-cyan); }
            /* Panel Inferior empieza donde termina el Izquierdo */
            #bottom-panel { bottom: 0; left: var(--panel-w); width: calc(100% - var(--panel-w)); height: var(--panel-h); transform: translateY(100%); border-top: 1px solid var(--hud-cyan); }
            
            /* C√°mara ocupa el espacio RESTANTE exacto */
            body.panels-active #main-view-area { 
                left: var(--panel-w); 
                top: 0;
                width: calc(100% - var(--panel-w)); 
                height: calc(100% - var(--panel-h)); 
            }
        }
        @media (max-aspect-ratio: 1/1) { /* PORTRAIT */
            #left-panel { top: 0; left: 0; width: 100vw; height: auto; transform: translateY(-100%); border-bottom: 1px solid var(--hud-cyan); padding-bottom: 5px; }
            #bottom-panel { bottom: 0; left: 0; width: 100vw; height: 110px; transform: translateY(100%); border-top: 1px solid var(--hud-pink); }
            body.panels-active #main-view-area { opacity: 0.2; }
        }
    </style>
</head>
<body>

<div id="loading-overlay">
    <img src="obr-logo.png" class="loader-logo">
    <div style="color: var(--hud-cyan); font-family: 'Orbitron'; letter-spacing: 2px;">CARGANDO <span id="load-percent">0%</span></div>
    <div style="width: 200px; background: #222; height: 4px; margin-top: 10px;"><div id="loading-bar" style="width:0%; height:100%; background:var(--hud-cyan);"></div></div>
    <button id="enter-btn" onclick="enterApp()">INGRESAR</button>
</div>

<div id="app-ui" onclick="handleUITap(event)">

    <div id="main-view-area">
        <video id="bg-camera-feed" playsinline autoplay muted></video>
        <canvas id="main-filter-canvas"></canvas>
        <canvas id="gl-bluewave"></canvas>
        
        <div id="follow-banner">
            <div class="social-icons">
                <svg viewBox="0 0 448 512"><path d="M448 209.9a210.1 210.1 0 0 1 -122.8-39.3V349.4A162.6 162.6 0 1 1 185 188.3V277.2a74.6 74.6 0 1 0 52.2 71.2V0l88 0a121.2 121.2 0 0 0 122.8 122.1v87.8z"/></svg>
                <svg viewBox="0 0 576 512"><path d="M549.7 124.1c-6.3-23.7-24.8-42.3-48.3-48.6C458.8 64 288 64 288 64S117.2 64 74.6 75.5c-23.5 6.3-42 24.9-48.3 48.6-11.4 42.9-11.4 132.3-11.4 132.3s0 89.4 11.4 132.3c6.3 23.7 24.8 42.3 48.3 48.6C117.2 448 288 448 288 448s170.8 0 213.4-11.5c23.5-6.3 42-24.9 48.3-48.6 11.4-42.9 11.4-132.3 11.4-132.3s0-89.4-11.4-132.3zM232 341.5V170.5l145.2 85.5-145.2 85.5z"/></svg>
                <svg viewBox="0 0 512 512"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.8 90.7 226.4 209.3 245V327.7h-63V256h63v-54.6c0-62.2 37-96.5 93.7-96.5 27.1 0 55.5 4.8 55.5 4.8v61h-31.3c-30.8 0-40.4 19.1-40.4 38.7V256h68.8l-11 71.7h-57.8V501C413.3 482.4 504 379.8 504 256z"/></svg>
            </div>
            <div class="follow-text">@EXPLORACIONESOBR</div>
        </div>
    </div>

    <img id="logo-image" src="obr-logo.png">
    
    <div id="left-panel">
        <div class="panel">
            <div class="panel-section">
                <div class="section-title">SENSORES</div>
                <div class="sensor-row">
                    <div style="display:flex;align-items:center"><div id="led-mag" class="sensor-led led-red"></div><span>üß≠ MAG/GIRO</span></div><span id="val-mag" style="color:#888">OFF</span>
                </div>
                <div class="sensor-row">
                    <div style="display:flex;align-items:center"><div id="led-acc" class="sensor-led led-red"></div><span>üì° ACELER√ìMETRO</span></div><span id="val-acc" style="color:#888">OFF</span>
                </div>
                <div class="sensor-row">
                    <div style="display:flex;align-items:center"><div id="led-mic" class="sensor-led led-red"></div><span>üéôÔ∏è MICR√ìFONO</span></div><span id="val-mic" style="color:#888">OFF</span>
                </div>
            </div>
            
            <div class="panel-section" style="flex-grow:1; display:flex; flex-direction:column;">
                <div class="section-title" style="color:var(--hud-orange);">RADAR PROXIMIDAD</div>
                <div id="radar-container">
                    <div id="radar-scan"></div>
                    <div id="radar-text">SCANNING...</div>
                </div>
            </div>

            <div class="panel-section">
                <div class="spirit-header">
                    <div class="section-title" style="color:var(--hud-green); margin:0;">SPIRIT BOX</div>
                    <div id="voice-led" class="voice-led" title="Verde: Esperando Comando"></div>
                </div>
                <div class="control-grid">
                    <button id="btn-pwr" class="btn-control pwr-off" onclick="toggleSpirit()">OFF</button>
                    <button id="btn-spd" class="btn-control spd-1" onclick="cycleSpeed()">SPD 1</button>
                </div>
                <div style="margin-top:5px;">
                    <div style="display:flex;justify-content:space-between;font-size:0.5rem;color:#aaa;"><span>VOL</span><span id="vol-txt">100%</span></div>
                    <input type="range" id="vol-slider" min="0" max="100" value="100">
                </div>
            </div>
        </div>
    </div>

    <div id="bottom-panel">
        <div class="panel">
            <div class="dials-grid">
                <div class="dial-wrapper"><div class="dial-container"><div class="dial-needle" id="compass-needle"></div></div><div class="knob-label">MAG</div></div>
                <div class="dial-wrapper"><div class="dial-container"><div class="dial-needle" id="emf-needle"></div></div><div class="knob-label">EMF</div></div>
                <div class="dial-wrapper"><div class="dial-container"><div class="dial-needle" id="temp-needle"></div></div><div class="knob-label">TEMP <span id="temp-val">--</span></div></div>
                
                <div id="energy-display">
                    </div>

                <div id="panel-sys-stats">
                    <div>SYS: REC üî¥</div>
                    <div>FPS: <span id="p-fps">--</span></div>
                    <div>RES: <span id="p-res">HD</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="filter-controls-container">
        <button class="filter-btn" onclick="toggleFilter('night-vision')">NVG</button>
        <button class="filter-btn" onclick="toggleFilter('sls')">SLS</button>
        <button class="filter-btn" onclick="toggleFilter('negative')">NEG</button>
        <button class="filter-btn" onclick="toggleFilter('spectral')">SPEC</button> <button class="filter-btn" id="btn-panel" onclick="togglePanels()">HUD</button>
    </div>

</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzOf3crQxBdPylwMTAd34W-nBShN31MkIUtaMdKsZHMZVVniI2HjMesD6DpOlO363T1/exec";
    
    // Variables globales
    let audioCtx, masterGain, micSource, analyser;
    let bgBuffer, bgNode, bgGain;
    let recognition, isSpiritOn = false, speed = 1;
    let autoData = [], progData = new Map();
    let videoTrack;
    let currentFilter = 'none';
    let uiVisible = false;
    let hideTimeout;

    // Elementos DOM
    const vid = document.getElementById('bg-camera-feed');
    const canvasSLS = document.getElementById('main-filter-canvas'); const ctxSLS = canvasSLS.getContext('2d');
    const energyDiv = document.getElementById('energy-display');
    const bars = [];
    
    // Init Barras Grafico
    for(let i=0; i<15; i++){
        let b = document.createElement('div');
        b.className = 'energy-bar';
        energyDiv.appendChild(b);
        bars.push(b);
    }

    // --- 1. SISTEMA CARGA ---
    window.onload = () => {
        let p=0;
        let t = setInterval(()=>{
            p+=2;
            if(p>100) p=100;
            document.getElementById('loading-bar').style.width=p+'%';
            document.getElementById('load-percent').innerText=p+'%';
            if(p===100){
                clearInterval(t);
                setTimeout(async ()=>{
                    try{ await loadData(); await initMoveNet(); }catch(e){}
                    document.getElementById('enter-btn').style.display='block';
                    document.getElementById('load-text').innerText="LISTO";
                },500);
            }
        }, 50);
    };

    async function enterApp(){
        document.getElementById('loading-overlay').style.display='none';
        // Audio Ctx obligatorio en click
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        masterGain = audioCtx.createGain(); masterGain.connect(audioCtx.destination);
        bgBuffer = await loadAudio('FONDO_1.mp3');
        
        initMic(); // Micr√≥fono independiente para gr√°fico
        initFollowBanner();
        await startCam();
        initSensors();
        loop();
    }

    // --- 2. CAMARA & FILTROS ---
    async function startCam(){
        try{
            const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment", width:{ideal:1920}, height:{ideal:1080}}, audio:false});
            vid.srcObject = s; videoTrack = s.getVideoTracks()[0];
            vid.onloadedmetadata = ()=> resize();
            window.onresize = resize;
        }catch(e){ console.log(e); }
    }
    function resize(){
        canvasSLS.width = window.innerWidth; canvasSLS.height = window.innerHeight;
        if(window.BlueWave) window.BlueWave.resize();
    }

    async function toggleFilter(f){
        if(currentFilter===f) f='none';
        document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
        document.body.className = f!=='none' ? 'filter-'+f : '';
        if(f!=='none') document.querySelector(`button[onclick="toggleFilter('${f}')"]`).classList.add('active');
        
        canvasSLS.style.display = f==='sls'?'block':'none';
        if(f==='spectral' && window.BlueWave) window.BlueWave.start(); else if(window.BlueWave) window.BlueWave.stop();
        
        // NVG Flash
        if(videoTrack) try{ await videoTrack.applyConstraints({advanced:[{torch: f==='night-vision'}]}); }catch(e){}
        currentFilter = f;
    }

    function togglePanels(){
        document.body.classList.toggle('panels-active');
        document.getElementById('btn-panel').classList.toggle('active');
        setTimeout(resize, 450); // Reajustar canvas al terminar transicion
    }

    // --- 3. SENSORES & RADAR ---
    function initSensors(){
        let active=false;
        if(window.DeviceOrientationEvent) window.addEventListener('deviceorientation', e=>{
            if(e.alpha){
                document.getElementById('compass-needle').style.transform = `translateX(-50%) rotate(${-e.alpha}deg)`;
                updSens('mag', Math.round(e.alpha)+"¬∞", 'green'); active=true;
            }
        });
        if(window.DeviceMotionEvent) window.addEventListener('devicemotion', e=>{
            let a = e.accelerationIncludingGravity;
            if(a){
                let t = Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z);
                updSens('acc', t.toFixed(1), 'blue');
                let rot = ((t*10)%180)-90;
                document.getElementById('emf-needle').style.transform = `translateX(-50%) rotate(${rot}deg)`;
                active=true;
            }
        });
        // Simulaci√≥n si no hay sensores
        if(!active){
            setInterval(()=>{
                let r = Math.random()*360;
                document.getElementById('compass-needle').style.transform = `translateX(-50%) rotate(${r}deg)`;
                updSens('mag', 'SIM', 'orange'); updSens('acc', 'SIM', 'orange');
                document.getElementById('emf-needle').style.transform = `translateX(-50%) rotate(${(Math.random()*100)-50}deg)`;
            }, 800);
        }
    }
    function updSens(id, txt, col){
        document.getElementById('val-'+id).innerText=txt;
        document.getElementById('led-'+id).className=`sensor-led led-${col}`;
    }

    // --- 4. SPIRIT BOX PRO ---
    async function loadAudio(u){ try{const r=await fetch(u);const b=await r.arrayBuffer();return await audioCtx.decodeAudioData(b);}catch(e){return null;} }
    
    async function initMic(){
        try{
            const s = await navigator.mediaDevices.getUserMedia({audio:true});
            micSource = audioCtx.createMediaStreamSource(s);
            analyser = audioCtx.createAnalyser(); analyser.fftSize=64;
            micSource.connect(analyser);
            updSens('mic', 'ON', 'green');
            initRec(); // Inicializar reconocimiento (dormido)
        }catch(e){ updSens('mic', 'ERR', 'red'); }
    }

    function toggleSpirit(){
        isSpiritOn = !isSpiritOn;
        const btn = document.getElementById('btn-pwr');
        if(isSpiritOn){
            btn.innerText="ON"; btn.className="btn-control pwr-on";
            if(audioCtx.state==='suspended') audioCtx.resume();
            if(bgBuffer){
                bgNode = audioCtx.createBufferSource(); bgNode.buffer=bgBuffer; bgNode.loop=true;
                bgGain = audioCtx.createGain(); bgGain.gain.value=0.6; // 60% Fondo
                bgNode.connect(bgGain); bgGain.connect(masterGain); bgNode.start(0);
            }
            loopSpirit();
        }else{
            btn.innerText="OFF"; btn.className="btn-control pwr-off";
            if(bgNode) bgNode.stop();
            if(window.speechSynthesis) window.speechSynthesis.cancel();
            document.getElementById('voice-led').classList.remove('listening');
        }
    }

    function cycleSpeed(){
        speed++; if(speed>3) speed=1;
        const btn = document.getElementById('btn-spd');
        btn.innerText = "SPD "+speed;
        btn.className = "btn-control spd-"+speed;
    }

    function loopSpirit(){
        if(!isSpiritOn) return;
        let delay = 4000 + Math.random()*5000;
        if(speed===2) delay = 2500 + Math.random()*3000;
        if(speed===3) delay = 1000 + Math.random()*2000; // Muy rapido
        
        setTimeout(()=>{
            if(isSpiritOn && autoData.length>0 && !window.speechSynthesis.speaking){
                speak(autoData[Math.floor(Math.random()*autoData.length)]);
            }
            loopSpirit();
        }, delay);
    }

    // RECONOCIMIENTO & DUCKING
    function initRec(){
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition; if(!SR) return;
        recognition = new SR(); recognition.lang='es-MX'; recognition.continuous=true;
        recognition.onstart = () => {
            // LED VERDE: ESCUCHANDO COMANDO
            if(isSpiritOn) document.getElementById('voice-led').classList.add('listening');
        };
        recognition.onend = () => {
            document.getElementById('voice-led').classList.remove('listening');
            if(isSpiritOn) recognition.start();
        };
        recognition.onresult = e => {
            const t = e.results[e.results.length-1][0].transcript.toLowerCase().trim();
            if(progData.has(t)) speak(progData.get(t));
        };
        recognition.start();
    }

    function speak(txt){
        if(!window.speechSynthesis) return;
        
        // DUCKING: Bajar fondo mientras habla
        if(bgGain) bgGain.gain.setTargetAtTime(0.2, audioCtx.currentTime, 0.1);
        // LED APAGADO MIENTRAS HABLA (Solo enciende al escuchar)
        document.getElementById('voice-led').classList.remove('listening');
        // <-- TIEMPO DE ESPERA PARA COMANDO (2000ms aprox por el ducking)
        
        const u = new SpeechSynthesisUtterance(txt); u.lang='es-MX'; 
        u.rate = 0.8 + (speed*0.1); 
        u.volume = 1.0;

        u.onend = () => {
            // Subir fondo tras hablar
            if(bgGain) bgGain.gain.setTargetAtTime(0.6, audioCtx.currentTime, 0.5);
            // LED ENCENDIDO (ESCUCHANDO)
            if(isSpiritOn) document.getElementById('voice-led').classList.add('listening');
        };
        window.speechSynthesis.speak(u);
    }

    document.getElementById('vol-slider').addEventListener('input', e=>{
        if(masterGain) masterGain.gain.value = e.target.value/100;
        document.getElementById('vol-txt').innerText=e.target.value+"%";
    });

    // --- 5. UI LOGIC ---
    function handleUITap(e){
        if(e.target.closest('.panel') || e.target.closest('button') || e.target.closest('input')) return;
        if(uiVisible) hideUI(); else showUI();
    }
    function showUI(){
        uiVisible=true;
        document.getElementById('filter-controls-container').style.opacity=1;
        document.getElementById('filter-controls-container').style.pointerEvents='auto';
        document.getElementById('logo-image').classList.add('ui-hiding');
        document.getElementById('follow-banner').classList.add('ui-hiding');
        clearTimeout(hideTimeout); hideTimeout=setTimeout(hideUI, 5000);
    }
    function hideUI(){
        uiVisible=false;
        document.getElementById('filter-controls-container').style.opacity=0;
        document.getElementById('filter-controls-container').style.pointerEvents='none';
        document.getElementById('logo-image').classList.remove('ui-hiding');
        document.getElementById('follow-banner').classList.remove('ui-hiding');
    }

    function initFollowBanner(){
        const b = document.getElementById('follow-banner');
        setInterval(()=>{
            b.classList.add('show');
            setTimeout(()=>b.classList.remove('show'), 6000);
        }, 30000); // Cada 30s
        setTimeout(()=>b.classList.add('show'), 1000); // Inicio
        setTimeout(()=>b.classList.remove('show'), 7000);
    }

    // --- 6. LOOPS ---
    function loop(){
        // Stats
        document.getElementById('p-fps').innerText = Math.round(1000/(performance.now()-lastFpsTime)) || 60;
        lastFpsTime = performance.now();
        let t = 18 + Math.random();
        document.getElementById('temp-val').innerText = t.toFixed(1)+"¬∞";
        document.getElementById('temp-needle').style.transform = `translateX(-50%) rotate(${((t-10)*6)-45}deg)`;

        // SLS
        if(currentFilter==='sls' && latestPoses.length>0){
            ctxSLS.clearRect(0,0,canvasSLS.width,canvasSLS.height);
            drawSLS(latestPoses);
        }

        // Energy
        if(analyser){
            const d = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(d);
            for(let i=0;i<15;i++) bars[i].style.height = Math.max(5, (d[i]*100/255)) + '%';
        }
        requestAnimationFrame(loop);
    }

    // Data & ML
    async function loadData(){
        const r=await fetch(GOOGLE_SCRIPT_URL); const d=await r.json();
        autoData=d.automatico.map(x=>x.TEXTO);
        d.programado.forEach(i=>{if(i.PREGUNTA) progData.set(i.PREGUNTA.toLowerCase().trim(), i.RESPUESTA)});
    }
    async function initMoveNet(){
        const m = poseDetection.SupportedModels.MoveNet;
        poseDetector = await poseDetection.createDetector(m, {modelType: poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING});
        setInterval(async()=>{if(currentFilter==='sls') latestPoses=await poseDetector.estimatePoses(vid)},100);
    }
    // Draw SLS
    const conns = [['left_shoulder','right_shoulder'],['left_shoulder','left_hip'],['right_shoulder','right_hip'],['left_hip','right_hip'],['left_shoulder','left_elbow'],['left_elbow','left_wrist'],['right_shoulder','right_elbow'],['right_elbow','right_wrist'],['left_hip','left_knee'],['left_knee','left_ankle'],['right_hip','right_knee'],['right_knee','right_ankle']];
    function drawSLS(ps){
        const s = Math.max(canvasSLS.width/vid.videoWidth, canvasSLS.height/vid.videoHeight);
        const xo=(canvasSLS.width-vid.videoWidth*s)/2, yo=(canvasSLS.height-vid.videoHeight*s)/2;
        ctxSLS.lineWidth=4; ctxSLS.strokeStyle='#0f0'; ctxSLS.fillStyle='#f00';
        ps.forEach(p=>{
            if(p.score<0.25)return; const m={}; p.keypoints.forEach(k=>m[k.name]=k);
            ctxSLS.beginPath(); conns.forEach(([a,b])=>{const p1=m[a],p2=m[b]; if(p1&&p2&&p1.score>0.3&&p2.score>0.3){ctxSLS.moveTo(p1.x*s+xo,p1.y*s+yo);ctxSLS.lineTo(p2.x*s+xo,p2.y*s+yo)}}); ctxSLS.stroke();
            p.keypoints.forEach(k=>{if(k.score>0.3){ctxSLS.beginPath();ctxSLS.arc(k.x*s+xo,k.y*s+yo,4,0,7);ctxSLS.fill()}});
        });
    }

</script>

<script>
/* FILTRO ESPECTRO (EDGE DETECTION) */
(function(){
    let gl,p,pl,tl,t,active=false;const c=document.getElementById("gl-bluewave"),v=document.getElementById("bg-camera-feed");
    function i(){
        gl=c.getContext("webgl");if(!gl)return;
        const vs=`attribute vec2 p;attribute vec2 t;varying vec2 vt;void main(){gl_Position=vec4(p,0,1);vt=t;}`;
        // Sobel Edge Detection Shader
        const fs=`precision mediump float;uniform sampler2D u;uniform vec2 r;varying vec2 vt;
        void main(){
            vec2 o=1.0/r;
            vec4 n=texture2D(u,vt+vec2(0,-o.y)); vec4 s=texture2D(u,vt+vec2(0,o.y));
            vec4 e=texture2D(u,vt+vec2(o.x,0)); vec4 w=texture2D(u,vt+vec2(-o.x,0));
            float gx=length(e-w); float gy=length(n-s); float g=sqrt(gx*gx+gy*gy);
            // Cian si hay borde, oscuro si no
            if(g>0.1) gl_FragColor=vec4(0.0, g*2.0, g*2.0, 1.0); else gl_FragColor=vec4(0,0,0,0.5);
        }`;
        p=cp(gl,vs,fs);pl=gl.getAttribLocation(p,"p");tl=gl.getAttribLocation(p,"t");
        gl.bindBuffer(34962,gl.createBuffer());gl.bufferData(34962,new Float32Array([-1,-1,-1,1,1,-1,1,-1,-1,1,1,1]),35044);
        gl.bindBuffer(34962,gl.createBuffer());gl.bufferData(34962,new Float32Array([0,1,0,0,1,1,1,1,0,0,1,0]),35044);
        t=gl.createTexture();gl.bindTexture(3553,t);gl.texParameteri(3553,10242,33071);gl.texParameteri(3553,10243,33071);gl.texParameteri(3553,10241,9729);
    }
    function r(){
        if(!active)return;if(!gl)i();
        c.width=window.innerWidth;c.height=window.innerHeight;gl.viewport(0,0,c.width,c.height);
        gl.useProgram(p);
        gl.enableVertexAttribArray(pl);gl.bindBuffer(34962,gl.createBuffer());gl.bufferData(34962,new Float32Array([-1,-1,-1,1,1,-1,1,-1,-1,1,1,1]),35044);gl.vertexAttribPointer(pl,2,5126,false,0,0);
        gl.enableVertexAttribArray(tl);gl.bindBuffer(34962,gl.createBuffer());gl.bufferData(34962,new Float32Array([0,1,0,0,1,1,1,1,0,0,1,0]),35044);gl.vertexAttribPointer(tl,2,5126,false,0,0);
        gl.uniform2f(gl.getUniformLocation(p,"r"),c.width,c.height);
        gl.bindTexture(3553,t);if(v.readyState>=2)gl.texImage2D(3553,0,6408,6408,5121,v);
        gl.drawArrays(4,0,6);requestAnimationFrame(r);
    }
    function cp(g,v,f){const x=g.createProgram();let s=g.createShader(35633);g.shaderSource(s,v);g.compileShader(s);g.attachShader(x,s);s=g.createShader(35632);g.shaderSource(s,f);g.compileShader(s);g.attachShader(x,s);g.linkProgram(x);return x;}
    window.BlueWave={start:()=>{active=true;r()},stop:()=>{active=false},resize:()=>{if(c){c.width=window.innerWidth;c.height=window.innerHeight}}};
})();
</script>

</body>
</html>
