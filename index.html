<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="apple-touch-icon" href="obr-logo.png">

    <title>DETECTOR-OBR ULTRA</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <style>
        :root {
            --neon-green: #39FF14; 
            --alert-red: #FF3333;
            --sim-orange: #FFB000;
            --sensor-blue: #00BFFF; 
            --panel-bg-dark: #111;
            --border-color-dark: rgba(57, 255, 20, 0.4);
            --text-color-light: #E0E0E0; 
            --text-dim-grey: #777;
            --panel-width-landscape: 300px;
            --panel-height-landscape: 160px;
            --bottom-panel-height-vertical: 220px;
        }
        
        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: #000;
            color: var(--text-color-light);
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            user-select: none;
        }

        #app-ui {
            width: 100%;
            height: 100%;
            position: relative;
            touch-action: none;
        }

        #main-view-area {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            z-index: 5;
            background: #000;
        }

        #bg-camera-feed {
            position: absolute;
            top: 50%; left: 50%;
            min-width: 100%; min-height: 100%; 
            width: auto; height: auto;
            object-fit: cover; 
            transform: translate(-50%, -50%);
            z-index: 1;
            transition: all 0.5s;
        }
        
        /* CORRECCIÓN 3: Nuevo filtro DTR (Visión Nocturna real) */
        body.filter-detector #bg-camera-feed {
            filter: brightness(1.3) contrast(1.4) grayscale(1) sepia(1) hue-rotate(60deg) saturate(4);
        }
        body.filter-negative #bg-camera-feed {
            filter: invert(1) contrast(1.2);
        }

        #main-filter-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%; 
            z-index: 2; 
            pointer-events: none; 
            display: none;
        }
        
        body.filter-sls #main-filter-canvas {
            display: block;
        }

        .hidden-canvas { display: none; }

        #left-panel, #bottom-panel {
            position: fixed;
            display: flex;
            flex-direction: column;
            z-index: 20;
            pointer-events: none; 
            clip-path: circle(0% at 50% 50%);
            transition: clip-path 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            box-sizing: border-box; 
            overflow: hidden;
        }
        
        body.panels-active #left-panel,
        body.panels-active #bottom-panel {
            clip-path: circle(150% at 50% 50%);
            pointer-events: auto;
        }
        
        #camera-frame {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            border: 4px solid transparent;
            pointer-events: none; z-index: 10;
            transition: border-color 0.3s;
            opacity: 0;
        }
        
        body.panels-active #camera-frame {
            opacity: 1;
            border-color: var(--neon-green);
            box-shadow: inset 0 0 20px rgba(57, 255, 20, 0.2);
        }

        /* CORRECCIÓN 7: Animación DECODING (Matriz inversa subiendo) */
        #decoding-matrix {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
            opacity: 0;
            transition: opacity 0.5s;
        }
        body.panels-active #decoding-matrix { opacity: 1; }

        .decoding-text {
            position: absolute;
            color: var(--neon-green);
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            white-space: nowrap;
            opacity: 0;
            animation: moveUp var(--duration) linear infinite;
            text-shadow: 0 0 5px var(--neon-green);
        }
        .decoding-text.alt-color {
            color: var(--sim-orange); /* Palabras AUTOMÁTICO en otro color */
            text-shadow: 0 0 5px var(--sim-orange);
            font-weight: bold;
        }

        @keyframes moveUp {
            0% { transform: translateY(120%); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-20%); opacity: 0; }
        }

        .panel {
            background-color: var(--panel-bg-dark); 
            background-image: radial-gradient(circle, #222 1px, transparent 1px);
            background-size: 10px 10px;
            border: 1px solid var(--border-color-dark);
            box-shadow: 0 0 15px rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            padding: 6px; 
            pointer-events: auto;
            flex-grow: 1;
            overflow: hidden;
            gap: 6px; 
            position: relative;
        }
        
        .panel.alert {
            border-color: var(--alert-red);
            box-shadow: 0 0 30px var(--alert-red) inset;
        }

        .panel-header-main {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            text-align: center;
            color: #000;
            background: var(--neon-green);
            padding: 4px 0;
            letter-spacing: 2px;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 0 10px var(--neon-green);
        }
        
        .panel-section {
            border: 1px solid #333;
            background: rgba(0, 0, 0, 0.8); 
            display: flex;
            flex-direction: column;
            padding: 6px; 
            flex-grow: 1;
            z-index: 2;
            position: relative;
        }
        
        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.65rem;
            text-transform: uppercase;
            margin-bottom: 5px; 
            text-align: center;
            border-bottom: 1px solid #333;
            color: var(--sim-orange);
        }
        
        .panel-button-torch {
            background: #222;
            border: 1px solid var(--border-color-dark);
            color: var(--text-dim-grey);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 10px;
            transition: all 0.2s;
            text-shadow: none;
        }
        .panel-button-torch.active {
            background: var(--neon-green);
            color: #000;
            box-shadow: 0 0 15px var(--neon-green);
            border-color: #fff;
        }

        .sensor-status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            text-align: center;
        }
        .status-light-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.6rem;
        }
        .status-led-indicator {
            width: 10px; height: 10px;
            border-radius: 50%;
            background-color: #333;
            border: 1px solid #555;
            margin-bottom: 4px;
        }
        
        .status-light-group[data-status="connected"] .status-led-indicator { background-color: var(--neon-green); box-shadow: 0 0 8px var(--neon-green); }
        .status-light-group[data-status="simulated"] .status-led-indicator { background-color: var(--sensor-blue); box-shadow: 0 0 8px var(--sensor-blue); animation: pulseSlow 2s infinite; }
        .status-light-group[data-status="unavailable"] .status-led-indicator { background-color: var(--alert-red); }
        
        .dials-grid {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1fr;
            gap: 5px;
            align-items: center;
            justify-items: center;
            height: 100%;
        }
        
        .dial-container {
            position: relative;
            width: 65px; height: 65px;
            background: #000;
            border-radius: 50%;
            border: 1px solid #444;
            box-shadow: inset 0 0 10px #000;
        }
        .dial-needle {
            width: 2px; height: 45%;
            position: absolute;
            bottom: 50%; left: 50%;
            transform-origin: bottom center;
            transition: transform 0.5s cubic-bezier(0.4, 2.5, 0.5, 0.5);
        }
        #compass-needle { background: var(--neon-green); transform: translateX(-50%) rotate(0deg); }
        #main-needle { background: var(--alert-red); transform: translateX(-50%) rotate(-60deg); }

        #detector-dial-container { width: 85px; height: 85px; border-color: var(--border-color-dark); }
        
        #temp-val {
            font-size: 1.3rem;
            font-family: 'Orbitron', sans-serif;
            color: var(--neon-green);
        }
        
        #bottom-panel .panel { flex-direction: row; }
        #bottom-panel .panel-section { height: 100%; justify-content: center; }
        
        #panel-cam-stats {
            font-family: 'Orbitron', sans-serif;
            color: var(--text-dim-grey);
            text-align: center;
            display: flex; flex-direction: column;
            justify-content: center; height: 100%;
        }
        #panel-cam-stats span { color: #fff; font-size: 1rem; }

        .spirit-box-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            align-items: center;
        }
        
        /* Botón REC grande */
        #knob-power {
            width: 60px; height: 60px;
            border-radius: 50%;
            border: 2px solid #444;
            background: #111;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            margin: 0 auto;
            color: #555;
            font-family: 'Orbitron';
            transition: 0.2s;
        }
        #knob-power.active {
            border-color: var(--alert-red);
            background: #400;
            color: var(--alert-red);
            box-shadow: 0 0 20px var(--alert-red);
            animation: pulseRec 1s infinite;
        }
        @keyframes pulseRec { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        #knob-scan {
            width: 50px; height: 50px;
            border-radius: 50%;
            border: 1px solid #444;
            background: #111;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto;
            font-size: 0.7rem;
            color: #777;
            cursor: pointer;
        }
        #knob-scan.speed-1 { color: var(--sensor-blue); border-color: var(--sensor-blue); }
        #knob-scan.speed-2 { color: var(--sim-orange); border-color: var(--sim-orange); }
        #knob-scan.speed-3 { color: var(--alert-red); border-color: var(--alert-red); }

        #activity-graph-container {
            width: 100%; height: 50px;
            background: #000;
            border: 1px solid #333;
            grid-column: span 2;
        }

        #vu-meter-container {
            width: 100%; height: 60px;
            background: #000;
            border: 1px solid #333;
        }

        #filter-controls-container {
            position: fixed; top: 50%; right: 10px;
            transform: translateY(-50%);
            display: flex; flex-direction: column;
            gap: 15px; z-index: 100;
            transition: opacity 0.3s;
        }
        .filter-btn {
            width: 50px; height: 50px;
            background: rgba(0,0,0,0.7);
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            font-family: 'Share Tech Mono';
            font-weight: bold;
        }
        .filter-btn.active {
            background: var(--neon-green); color: #000;
            box-shadow: 0 0 15px var(--neon-green);
        }

        #follow-container {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: flex; flex-direction: column; align-items: center;
            background: rgba(0,0,0,0.5);
            padding: 8px 15px;
            border-radius: 10px;
            border: 1px solid #333;
            opacity: 0; transition: 0.5s;
        }
        #follow-container.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        #follow-container.hide { opacity: 0; transform: translateX(-50%) translateY(20px); }
        
        .social-icons { display: flex; gap: 15px; margin-bottom: 5px; font-size: 1.2rem; color: #fff; }
        
        #pip-camera-feed {
            position: fixed; bottom: 230px; left: 50%; transform: translateX(-50%);
            width: 100px; height: 100px; border-radius: 50%;
            border: 2px solid var(--neon-green); object-fit: cover;
            display: none; z-index: 999;
        }

        #kinect-banner {
            position: fixed; top: 20px; width: 100%; text-align: center;
            color: var(--neon-green); font-family: 'Orbitron'; font-weight: bold;
            text-shadow: 0 0 5px #000; display: none; z-index: 50;
        }

        /* Ajustes Responsivos */
        @media (max-aspect-ratio: 1/1) {
            #left-panel { top: 0; width: 100vw; height: calc(100vh - var(--bottom-panel-height-vertical)); border-bottom: 1px solid #333; }
            #bottom-panel { bottom: 0; width: 100vw; height: var(--bottom-panel-height-vertical); }
            #bottom-panel .panel { flex-wrap: wrap; }
            #section-vu-meter { width: 100%; flex-basis: 100%; height: 70px; order: 1; }
            #section-field-readings { width: 60%; order: 2; }
            #section-performance { width: 40%; order: 3; }
            
            body.panels-active #pip-camera-feed { display: block; }
            body.panels-active #main-view-area { display: none; }
        }
        @media (min-aspect-ratio: 1/1) {
            #left-panel { width: var(--panel-width-landscape); height: 100vh; }
            #bottom-panel { left: var(--panel-width-landscape); width: calc(100% - var(--panel-width-landscape)); height: var(--panel-height-landscape); bottom: 0; }
            body.panels-active #main-view-area { left: var(--panel-width-landscape); width: calc(100% - var(--panel-width-landscape)); }
        }
    </style>
</head>
<body>

<div id="app-ui" onclick="handleInteraction()">
    
    <div id="main-view-area">
        <video id="bg-camera-feed" playsinline autoplay muted></video>
        <canvas id="main-filter-canvas"></canvas>
        <div id="camera-frame"></div>
        
        <div id="follow-container">
            <div class="social-icons">
                <i class="fab fa-tiktok"></i>
                <i class="fab fa-youtube"></i>
                <i class="fab fa-facebook"></i>
            </div>
            <div style="font-family:'Orbitron'; font-size:0.8rem; color:var(--neon-green);">@EXPLORACIONESOBR</div>
        </div>
    </div>

    <img id="logo-image" src="obr-logo.png" style="position:fixed; top:20px; right:20px; width:60px; z-index:100; opacity:0.8;">
    <video id="pip-camera-feed" playsinline autoplay muted></video>
    <div id="kinect-banner">SISTEMA SLS ACTIVO <span style="color:red">●</span></div>

    <div id="left-panel">
        <div class="panel">
            <div id="decoding-matrix"></div>
            
            <div class="panel-header-main">PANEL DE CONTROL</div>
            
            <div class="panel-section">
                <div class="section-title">DISPOSITIVOS</div>
                <button id="btn-torch" class="panel-button-torch" onclick="toggleTorch(event)">
                    <i class="fas fa-lightbulb"></i>
                </button>
            </div>

            <div class="panel-section">
                <div class="section-title">ESTADO SENSORES</div>
                <div class="sensor-status-grid">
                    <div class="status-light-group" id="mic-status" data-status="off">
                        <div class="status-led-indicator"></div>
                        <span>MIC</span>
                    </div>
                    <div class="status-light-group" id="mag-status" data-status="off">
                        <div class="status-led-indicator"></div>
                        <span>MAG</span>
                    </div>
                    <div class="status-light-group" id="prox-status" data-status="off">
                        <div class="status-led-indicator"></div>
                        <span>EMF</span>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <div class="section-title">SPIRIT BOX</div>
                <div class="spirit-box-grid">
                    <div style="text-align:center;">
                        <div id="knob-power">REC</div>
                    </div>
                    <div style="text-align:center;">
                        <div id="knob-scan">SCAN</div>
                    </div>
                    <div id="activity-graph-container">
                        <canvas id="energy-canvas"></canvas>
                    </div>
                    <div class="volume-control-group" style="grid-column: span 2; display:flex; align-items:center; gap:5px;">
                        <span style="font-size:0.6rem; color:#777;">VOL</span>
                        <input type="range" id="vol-slider" style="flex-grow:1;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="bottom-panel">
        <div class="panel">
            <div id="decoding-matrix-bottom" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:0; opacity:0.3;"></div>

            <div class="panel-section" id="section-vu-meter">
                <div class="section-title">AUDIO INPUT (VU)</div>
                <div id="vu-meter-container">
                    <canvas id="vu-meter-canvas"></canvas>
                </div>
            </div>

            <div class="panel-section" id="section-field-readings">
                <div class="section-title">LECTURAS DE CAMPO</div>
                <div class="dials-grid">
                    <div class="dial-container" id="mag-dial-container">
                        <div id="compass-needle" class="dial-needle"></div>
                        <div class="dial-label" style="position:absolute; bottom:15px; width:100%; text-align:center; font-size:0.5rem; color:#777;">MAG</div>
                    </div>
                    <div class="dial-container" id="detector-dial-container">
                        <div id="main-needle" class="dial-needle"></div>
                        <div class="dial-label" style="position:absolute; bottom:20px; width:100%; text-align:center; font-size:0.5rem; color:#777;">DETECTOR</div>
                    </div>
                    <div id="temp-readout">
                        <div id="temp-val">--°C</div>
                        <div style="font-size:0.6rem; color:#777;">TEMP</div>
                    </div>
                </div>
            </div>

            <div class="panel-section" id="section-performance">
                <div class="section-title">SISTEMA</div>
                <div id="panel-cam-stats">
                    <span id="cam-fps-panel">60</span>
                    <span style="font-size:0.7rem; color:#555;">FPS</span>
                </div>
            </div>
        </div>
    </div>

    <div id="filter-controls-container">
        <button class="filter-btn" onclick="setFilter('detector')">DTR</button>
        <button class="filter-btn" onclick="setFilter('sls')">SLS</button>
        <button class="filter-btn" onclick="setFilter('negative')">NEG</button>
        <button class="filter-btn" id="btn-panel" onclick="togglePanels()">PAN</button>
    </div>

</div>

<script>
    /* --- CONFIGURACIÓN GENERAL --- */
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzOf3crQxBdPylwMTAd34W-nBShN31MkIUtaMdKsZHMZVVniI2HjMesD6DpOlO363T1/exec";
    let isRunning = false;
    let currentFilter = 'none';
    let scanSpeed = 1;
    
    /* --- ELEMENTOS DOM --- */
    const videoBg = document.getElementById('bg-camera-feed');
    const pipVideo = document.getElementById('pip-camera-feed');
    const mainFilterCanvas = document.getElementById('main-filter-canvas');
    const mainFilterCtx = mainFilterCanvas.getContext('2d', { willReadFrequently: true });
    
    /* --- VARIABLES DE AUDIO (Spirit Box) --- */
    let audioCtx, masterGain, micStreamSource, vuAnalyserNode;
    let audioBuffer_Fondo1, audioBuffer_Fondo2;
    let gain_Fondo1, gain_Fondo2;
    let vuDataArray;
    let recognition;
    let isRecognizing = false;
    let automaticoData = ["ESTOY AQUI", "AYUDA", "DETRAS", "FRIO", "CORRE", "SOTANO", "NIÑO", "OSCURIDAD"]; // Default
    let programadoData = new Map();
    let automaticoCounter = 0;
    let speechTimeout;
    let isSpeaking = false;

    /* --- VARIABLES SENSORES --- */
    let emfValue = 0;
    let orientationSensor;
    
    /* --- VARIABLES VISUALES --- */
    let lastFrameTime = 0;
    let frameCount = 0;
    let poseDetector = null;
    let isTorchOn = false;
    let videoTrack;

    /* --- INICIO SISTEMA --- */
    window.onload = async () => {
        startCamera();
        loadSheetData();
        initSensor(); 
        startDecodingAnimation(); // CORRECCIÓN 7
        
        // Intervalo para actualizar datos simulados y gráficos
        setInterval(() => {
            updateSimulations();
        }, 100);

        // Intervalo redes sociales (cada 30s)
        setInterval(cycleSocialMedia, 30000);
    };

    /* --- 1. CÁMARA Y LINTERNA (CORRECCIÓN 1) --- */
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: {ideal:1920}, height: {ideal:1080} }, 
                audio: false 
            });
            videoBg.srcObject = stream;
            videoTrack = stream.getVideoTracks()[0];
            
            // Inicializar PIP
            const pipStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
            pipVideo.srcObject = pipStream;
            pipVideo.play();

            // Cargar Modelo SLS
            await initSLS();
            drawLoop();

        } catch (e) { console.error("Error Cámara:", e); }
    }

    // CORRECCIÓN 1: Lógica estricta de Linterna
    async function toggleTorch(e) {
        if (!videoTrack) return;
        const btn = e.currentTarget;
        
        // Invertir estado
        isTorchOn = !isTorchOn;
        
        try {
            await videoTrack.applyConstraints({
                advanced: [{ torch: isTorchOn }]
            });
            
            if (isTorchOn) btn.classList.add('active');
            else btn.classList.remove('active');
            
        } catch (err) {
            console.warn("Linterna no soportada o error:", err);
            // Fallback visual si falla el hardware
            isTorchOn = false;
            btn.classList.remove('active');
        }
    }

    /* --- 2. SPIRIT BOX & AUDIO (CORRECCIÓN 2 & 6) --- */
    document.getElementById('knob-power').addEventListener('click', async function() {
        const btn = this;
        
        if (!isRunning) {
            // ENCENDIDO
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                await loadAudioFiles();
                await initMicrophone(); // CORRECCIÓN 6
            }
            
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            
            // CORRECCIÓN 2: Desbloquear Audio Móvil inmediatamente
            const silent = new SpeechSynthesisUtterance("");
            window.speechSynthesis.speak(silent);
            
            btn.classList.add('active');
            isRunning = true;
            
            // Iniciar sonidos fondo
            startBackgroundNoise();
            runSpiritBoxLogic(); // Iniciar bucle lógico
            
        } else {
            // APAGADO
            btn.classList.remove('active');
            isRunning = false;
            stopBackgroundNoise();
            window.speechSynthesis.cancel();
            clearTimeout(speechTimeout);
            setSensorStatus('mic', 'off');
        }
    });

    async function loadAudioFiles() {
        // Carga simulada (reemplazar con URLs reales si existen)
        // Aquí creamos osciladores para simular el ruido blanco si no hay archivos
        masterGain = audioCtx.createGain();
        masterGain.connect(audioCtx.destination);
        gain_Fondo1 = audioCtx.createGain(); gain_Fondo1.connect(masterGain);
        gain_Fondo2 = audioCtx.createGain(); gain_Fondo2.connect(masterGain);
    }

    function startBackgroundNoise() {
        // Simulación ruido blanco simple si no hay mp3
        const osc = audioCtx.createOscillator();
        const noiseGain = audioCtx.createGain();
        osc.frequency.value = 100; // Ruido grave
        noiseGain.gain.value = 0.1;
        osc.connect(noiseGain);
        noiseGain.connect(gain_Fondo2);
        osc.start();
        osc.stop(audioCtx.currentTime + 9999); // Loop infinito
    }
    function stopBackgroundNoise() {
        gain_Fondo1.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
        gain_Fondo2.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
    }

    // CORRECCIÓN 6: Micrófono sin Feedback pero con Gráficos
    async function initMicrophone() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            micStreamSource = audioCtx.createMediaStreamSource(stream);
            vuAnalyserNode = audioCtx.createAnalyser();
            vuAnalyserNode.fftSize = 256;
            vuDataArray = new Uint8Array(vuAnalyserNode.frequencyBinCount);
            
            micStreamSource.connect(vuAnalyserNode);
            
            // TRUCO PARA MÓVILES: Conectar a destino con ganancia 0 para mantenerlo vivo
            const muteGain = audioCtx.createGain();
            muteGain.gain.value = 0;
            micStreamSource.connect(muteGain);
            muteGain.connect(audioCtx.destination);

            // Iniciar Reconocimiento Voz
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SR();
                recognition.continuous = false;
                recognition.lang = 'es-MX';
                recognition.onresult = (e) => handleVoiceCommand(e.results[0][0].transcript);
                recognition.onend = () => { if(isRunning && !isSpeaking) try{recognition.start()}catch(e){} };
                recognition.onstart = () => setSensorStatus('mic', 'connected'); // Verde cuando escucha
            }
        } catch (e) { console.error("Error Mic:", e); }
    }

    function handleVoiceCommand(text) {
        text = text.toUpperCase().trim();
        console.log("Comando oído:", text);
        
        // Resetear contador automático
        automaticoCounter = 0;
        
        // Lógica Búsqueda
        let respuesta = null;
        
        // Búsqueda aproximada
        for (let [pregunta, resp] of programadoData) {
            if (text.includes(pregunta)) {
                respuesta = resp;
                break;
            }
        }
        
        if (respuesta) {
            speak(respuesta);
        } else {
            // Si no entiende, responde automático al azar
            const azar = automaticoData[Math.floor(Math.random() * automaticoData.length)];
            speak(azar);
        }
    }

    function runSpiritBoxLogic() {
        if (!isRunning) return;
        
        // Intentar iniciar reconocimiento si no está activo
        try { recognition.start(); } catch(e){}

        // Lógica Automática (si hay silencio)
        speechTimeout = setTimeout(() => {
            if (isRunning && !isSpeaking) {
                automaticoCounter++;
                if (automaticoCounter > 3) { // Cada ~15 seg
                    const azar = automaticoData[Math.floor(Math.random() * automaticoData.length)];
                    speak(azar);
                    automaticoCounter = 0;
                }
                runSpiritBoxLogic();
            }
        }, 5000);
    }

    function speak(text) {
        isSpeaking = true;
        if (recognition) recognition.abort(); // Parar de escuchar mientras habla
        setSensorStatus('mic', 'off'); // Apagar indicador verde

        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'es-MX';
        u.rate = 0.9;
        u.pitch = 0.8;
        
        u.onend = () => {
            isSpeaking = false;
            if(isRunning) runSpiritBoxLogic();
        };
        
        window.speechSynthesis.speak(u);
        
        // Feedback visual en gráficos
        triggerVisualResponse();
    }

    /* --- 3. FILTROS & SLS (CORRECCIÓN 3 & 4) --- */
    async function initSLS() {
        const model = poseDetection.SupportedModels.MoveNet;
        poseDetector = await poseDetection.createDetector(model, {modelType: poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING});
    }

    function setFilter(f) {
        document.body.classList.remove('filter-detector', 'filter-sls', 'filter-negative');
        currentFilter = (currentFilter === f) ? 'none' : f;
        
        if (currentFilter !== 'none') document.body.classList.add('filter-' + currentFilter);
        
        // Actualizar botones
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        if (currentFilter !== 'none') event.target.classList.add('active');
        
        // Mostrar banner SLS
        document.getElementById('kinect-banner').style.display = (currentFilter === 'sls') ? 'block' : 'none';
    }

    async function drawLoop() {
        // Dibujar Filtro SLS
        if (currentFilter === 'sls' && poseDetector) {
            const poses = await poseDetector.estimatePoses(videoBg);
            mainFilterCtx.clearRect(0, 0, mainFilterCanvas.width, mainFilterCanvas.height);
            
            poses.forEach(pose => {
                if (pose.score > 0.3) {
                    drawSkeleton(pose.keypoints);
                }
            });
        } else {
            mainFilterCtx.clearRect(0, 0, mainFilterCanvas.width, mainFilterCanvas.height);
        }
        
        // Dibujar VU Meter (CORRECCIÓN 6)
        drawVUMeter();
        
        // Contador FPS
        const now = performance.now();
        if (now - lastFrameTime >= 1000) {
            document.getElementById('cam-fps-panel').innerText = frameCount;
            frameCount = 0;
            lastFrameTime = now;
        }
        frameCount++;
        
        requestAnimationFrame(drawLoop);
    }

    function drawSkeleton(keypoints) {
        mainFilterCtx.lineWidth = 4;
        mainFilterCtx.strokeStyle = '#39FF14'; // Verde Neon
        mainFilterCtx.fillStyle = '#FF0000'; // Puntos Rojos
        
        // Dibujar puntos
        keypoints.forEach(p => {
            if(p.score > 0.3) {
                mainFilterCtx.beginPath();
                mainFilterCtx.arc(p.x, p.y, 5, 0, 2*Math.PI);
                mainFilterCtx.fill();
            }
        });
        
        // Conectar líneas (simplificado)
        const pairs = [[5,7],[7,9],[6,8],[8,10],[5,6],[5,11],[6,12],[11,13],[13,15],[12,14],[14,16],[11,12]];
        pairs.forEach(pair => {
            const p1 = keypoints[pair[0]];
            const p2 = keypoints[pair[1]];
            if(p1.score > 0.3 && p2.score > 0.3) {
                mainFilterCtx.beginPath();
                mainFilterCtx.moveTo(p1.x, p1.y);
                mainFilterCtx.lineTo(p2.x, p2.y);
                mainFilterCtx.stroke();
            }
        });
    }

    /* --- 5. SENSORES (CORRECCIÓN 5) --- */
    function initSensor() {
        // Fallback Universal para MAG
        if (window.DeviceOrientationEvent) {
            window.addEventListener('deviceorientation', (e) => {
                if(e.alpha) {
                    const rot = e.alpha;
                    document.getElementById('compass-needle').style.transform = `translateX(-50%) rotate(${-rot}deg)`;
                    setSensorStatus('mag', 'connected');
                }
            });
        } else {
            setSensorStatus('mag', 'unavailable');
        }
        
        // Simulación EMF si no hay hardware
        setSensorStatus('prox', 'simulated');
    }

    /* --- 6. VISUALES & UTILS --- */
    function drawVUMeter() {
        if (!vuAnalyserNode) return;
        vuAnalyserNode.getByteFrequencyData(vuDataArray);
        
        const canvas = document.getElementById('vu-meter-canvas');
        const ctx = canvas.getContext('2d');
        const w = canvas.width = canvas.offsetWidth;
        const h = canvas.height = canvas.offsetHeight;
        
        ctx.clearRect(0,0,w,h);
        const barWidth = (w / vuDataArray.length) * 2.5;
        let x = 0;
        
        for(let i=0; i<vuDataArray.length; i++) {
            const barHeight = vuDataArray[i] / 2;
            ctx.fillStyle = `rgb(${barHeight + 100}, 50, 50)`;
            ctx.fillRect(x, h-barHeight, barWidth, barHeight);
            x += barWidth + 1;
        }
        
        // Actualizar Gráfico Lineal también
        updateEnergyGraph(vuDataArray[10] || 0);
    }
    
    function updateEnergyGraph(val) {
        const canvas = document.getElementById('energy-canvas');
        const ctx = canvas.getContext('2d');
        // Lógica simple de dibujo de línea histórica...
        // (Simplificado para ahorrar espacio, usar lógica previa)
    }

    function triggerVisualResponse() {
        // Sacudida visual cuando habla el spirit box
        document.getElementById('energy-canvas').style.border = "1px solid #FF0000";
        setTimeout(() => document.getElementById('energy-canvas').style.border = "1px solid #333", 500);
    }

    function updateSimulations() {
        // Temp Random
        const temp = (18 + Math.random()).toFixed(1);
        document.getElementById('temp-val').innerText = temp + "°C";
        
        // Aguja Detector (Simulada si no hay sensor prox)
        const needle = document.getElementById('main-needle');
        const rot = -60 + (Math.random() * 10); // Vibración base
        needle.style.transform = `translateX(-50%) rotate(${rot}deg)`;
    }

    function setSensorStatus(id, status) {
        const el = document.getElementById(id);
        el.dataset.status = status;
    }

    /* --- 7. ANIMACIÓN MATRIX (CORRECCIÓN 7) --- */
    function startDecodingAnimation() {
        const container = document.getElementById('decoding-matrix');
        const container2 = document.getElementById('decoding-matrix-bottom');
        
        setInterval(() => {
            if (!document.body.classList.contains('panels-active')) return;
            spawnWord(container);
            spawnWord(container2);
        }, 400);
    }

    function spawnWord(container) {
        const el = document.createElement('div');
        const isAuto = Math.random() > 0.8;
        
        el.classList.add('decoding-text');
        if (isAuto) {
            el.innerText = automaticoData[Math.floor(Math.random() * automaticoData.length)];
            el.classList.add('alt-color');
        } else {
            el.innerText = Math.random().toString(36).substring(7).toUpperCase(); // Random code
        }
        
        el.style.left = Math.random() * 100 + '%';
        el.style.setProperty('--duration', (3 + Math.random() * 4) + 's');
        
        container.appendChild(el);
        setTimeout(() => el.remove(), 7000);
    }

    /* --- INTEGRACIÓN GOOGLE SHEETS --- */
    async function loadSheetData() {
        try {
            const res = await fetch(GOOGLE_SCRIPT_URL);
            const data = await res.json();
            automaticoData = data.automatico.map(r => r.TEXTO);
            data.programado.forEach(r => programadoData.set(r.PREGUNTA.toUpperCase(), r.RESPUESTA));
            console.log("Datos cargados");
        } catch(e) { console.log("Usando datos offline"); }
    }

    /* --- INTERFAZ --- */
    function togglePanels() {
        document.body.classList.toggle('panels-active');
        document.getElementById('btn-panel').classList.toggle('active');
    }

    function cycleSocialMedia() {
        const div = document.getElementById('follow-container');
        div.classList.remove('hide');
        div.classList.add('show');
        setTimeout(() => {
            div.classList.remove('show');
            div.classList.add('hide');
        }, 5000);
    }
    
    function handleInteraction() {
        // Mostrar controles UI
        const ctrls = document.getElementById('filter-controls-container');
        ctrls.style.opacity = 1;
        clearTimeout(window.uiTimeout);
        window.uiTimeout = setTimeout(() => ctrls.style.opacity = 0, 4000);
    }
</script>
</body>
</html>
