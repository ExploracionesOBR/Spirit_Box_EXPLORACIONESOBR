<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>DETECTOR-OBR v11.9 FINAL</title> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@500;700;900&family=Creepster&family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <style>
        :root {
            --hud-bg: #050510; 
            --hud-cyan: #00f3ff; 
            --hud-pink: #ff0055; 
            --hud-green: #00ff41; 
            --hud-orange: #ffae00;
            --hud-red: #ff3333;
            --hud-blue: #0088ff;
            --glass-panel: rgba(5, 8, 15, 0.95);
            
            /* Dimensiones Base */
            --left-panel-w: 280px;
            --bottom-panel-h: 160px;
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: #000; color: var(--hud-cyan);
            overflow: hidden; width: 100vw; height: 100vh; margin: 0;
            touch-action: none; /* CRUCIAL PARA EVITAR GESTOS DEL NAVEGADOR */
            -webkit-user-select: none; /* Safari */
            user-select: none; /* Standard */
            -webkit-touch-callout: none; /* iOS Safari callout */
        }

        /* --- LAYOUT PRINCIPAL (GRID EN FORMA DE L) --- */
        #app-ui { 
            width: 100%; height: 100%; 
            display: grid;
            grid-template-columns: var(--left-panel-w) 1fr; 
            grid-template-rows: 1fr var(--bottom-panel-h);
            grid-template-areas: 
                "left cam"
                "left bottom";
            transition: all 0.5s ease;
            opacity: 0; /* Oculto al inicio para la carga */
            pointer-events: none;
        }

        /* ESTADO SIN HUD (PANTALLA COMPLETA V1) - ESTADO INICIAL */
        body.panels-hidden #app-ui {
            grid-template-columns: 0px 1fr;
            grid-template-rows: 1fr 0px;
        }

        /* √ÅREAS DE LA REJILLA */
        #left-panel { 
            grid-area: left; border-right: 2px solid var(--hud-cyan); 
            overflow: hidden; transition: all 0.5s ease;
        }
        #bottom-panel { 
            grid-area: bottom; border-top: 2px solid var(--hud-cyan); 
            overflow: hidden; transition: all 0.5s ease;
        }
        #main-view-area { 
            grid-area: cam; 
            position: relative; overflow: hidden; background: #000;
            width: 100%; height: 100%; 
            /* Asegurar que no se pueda seleccionar nada aqui */
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        /* Cuando se ocultan, usamos display:none para liberar recursos y asegurar reflujo */
        body.panels-hidden #left-panel, body.panels-hidden #bottom-panel {
            display: none; 
        }

        /* ESTILOS COMUNES DE PANELES */
        .panel-container {
            background-color: var(--glass-panel);
            box-shadow: inset 0 0 20px rgba(0, 243, 255, 0.1);
            padding: 10px;
            display: flex; flex-direction: column;
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            z-index: 20;
        }

        /* CANVAS MATRIX EN PANEL */
        #matrix-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0.2; pointer-events: none; z-index: 0;
        }

        /* ZOOM CONTAINER */
        #zoom-container {
            width: 100%; height: 100%;
            transform-origin: center center;
            transition: transform 0.2s ease-out; /* Suavizado para los saltos */
            will-change: transform;
        }

        /* --- C√ÅMARA --- */
        #bg-camera-feed {
            width: 100%; height: 100%; object-fit: cover;
            transition: filter 0.3s ease;
        }
        #main-filter-canvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; }

        /* MARCO DE C√ÅMARA */
        .camera-border {
            position: absolute; inset: 10px; pointer-events: none; z-index: 5;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
        }
        .camera-border::before, .camera-border::after, .cb-inner::before, .cb-inner::after {
            content: ''; position: absolute; width: 20px; height: 20px; border-color: var(--hud-cyan); border-style: solid; transition: all 0.5s;
        }
        .camera-border::before { top: 0; left: 0; border-width: 2px 0 0 2px; }
        .camera-border::after { top: 0; right: 0; border-width: 2px 2px 0 0; }
        .cb-inner { position: absolute; inset: 0; }
        .cb-inner::before { bottom: 0; left: 0; border-width: 0 0 2px 2px; }
        .cb-inner::after { bottom: 0; right: 0; border-width: 0 2px 2px 0; }

        /* REC INDICATOR */
        .rec-container {
            position: absolute; top: 15px; left: 15px; 
            color: var(--hud-red); font-family: 'Orbitron'; font-weight: bold; 
            display: flex; align-items: center; gap: 8px; z-index: 10;
            text-shadow: 0 0 5px var(--hud-red); font-size: 0.8rem; pointer-events: none;
        }
        .rec-dot { width: 10px; height: 10px; background: var(--hud-red); border-radius: 50%; animation: blinkRed 1s infinite; }
        @keyframes blinkRed { 50% { opacity: 0.3; } }

        /* STATS INDICATOR */
        .stats-container {
            position: absolute; bottom: 15px; right: 20px;
            font-family: 'Share Tech Mono'; font-size: 0.65rem; 
            color: rgba(0, 243, 255, 0.7);
            text-shadow: 0 0 2px #000; z-index: 10;
            text-align: right; pointer-events: none;
            display: flex; gap: 10px;
        }
        .stats-val { color: #fff; font-weight: bold; }

        /* FILTROS CSS */
        body.filter-night-vision #bg-camera-feed { filter: grayscale(100%) sepia(100%) hue-rotate(90deg) brightness(0.9) contrast(1.2) saturate(150%); }
        body.filter-night-vision #main-view-area::after {
            content: ""; position: absolute; inset: 0; pointer-events: none; z-index: 4;
            background: radial-gradient(circle, transparent 60%, #000 95%);
        }
        body.filter-negative #bg-camera-feed { filter: invert(1) hue-rotate(180deg); }
        body.filter-sls #main-filter-canvas { display: block; }

        /* LOGO CON EFECTOS */
        #logo-container { position: absolute; top: 15px; right: 15px; z-index: 50; pointer-events: none; }
        #logo-image { 
            width: 60px; height: 60px; 
            filter: drop-shadow(0 0 5px var(--hud-cyan));
            animation: logoGlitch 5s infinite alternate;
        }
        @keyframes logoGlitch {
            0% { transform: scale(1) rotate(0deg); filter: drop-shadow(0 0 5px var(--hud-cyan)) hue-rotate(0deg); }
            90% { transform: scale(1.02) rotate(2deg); filter: drop-shadow(0 0 8px var(--hud-cyan)) hue-rotate(0deg); }
            92% { transform: scale(1.1) skew(10deg); filter: drop-shadow(0 0 10px var(--hud-pink)) hue-rotate(90deg); }
            94% { transform: scale(0.9) skew(-10deg); filter: drop-shadow(0 0 10px var(--hud-red)) hue-rotate(180deg); }
            96% { transform: scale(1.02) rotate(-2deg); }
            100% { transform: scale(1) rotate(0deg); filter: drop-shadow(0 0 5px var(--hud-cyan)); }
        }
        
        @keyframes horrorGlitch {
            0% { clip-path: inset(20% 0 80% 0); transform: translate(-2px, 1px); filter: hue-rotate(0deg) contrast(1.2); }
            20% { clip-path: inset(60% 0 10% 0); transform: translate(2px, -1px); filter: hue-rotate(90deg) contrast(2); }
            40% { clip-path: inset(40% 0 50% 0); transform: translate(-2px, 2px); filter: hue-rotate(180deg) invert(0.1); }
            60% { clip-path: inset(80% 0 5% 0); transform: translate(2px, -2px); filter: hue-rotate(270deg); }
            80% { clip-path: inset(10% 0 60% 0); transform: translate(-1px, 1px); }
            100% { clip-path: inset(30% 0 30% 0); transform: translate(1px, -1px); filter: hue-rotate(360deg); }
        }

        /* BANNER S√çGUENOS */
        #follow-banner {
            position: absolute; bottom: 20px; left: 0; right: 0;
            display: flex; justify-content: center; pointer-events: none;
            opacity: 0; transition: opacity 1s; z-index: 30;
        }
        #follow-banner.active { opacity: 1; }
        
        .banner-content {
            background: transparent; padding: 0; border: none;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            text-shadow: 0 0 5px #000; 
        }
        
        .seq-step { display: none; animation: fadeIn 0.5s; text-align: center; }
        .seq-step.active { display: block; }
        
        #step-1 { font-family: 'Orbitron'; color: #fff; letter-spacing: 2px; font-weight: bold; text-shadow: 0 0 10px var(--hud-cyan); }
        #step-2 { gap: 20px; display: none; filter: drop-shadow(0 0 5px #000); } 
        #step-3 { font-family: 'Creepster'; color: var(--hud-red); letter-spacing: 2px; font-size: 1.5rem; text-shadow: 2px 2px 0 #000; }
        
        .social-icon { font-size: 2rem; color: #fff; transition: transform 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CONTENIDO PANELES --- */
        .section-title { 
            font-family: 'Orbitron'; font-size: 0.65rem; font-weight: 800; 
            color: var(--hud-cyan); text-transform: uppercase; letter-spacing: 1px; 
            margin-bottom: 5px; border-bottom: 1px solid rgba(0, 243, 255, 0.3); 
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 2px; z-index: 2; position: relative;
        }

        /* SPIRIT BOX */
        #spirit-box-section {
            border: 1px solid var(--hud-green); background: rgba(0, 15, 5, 0.5); padding: 8px; border-radius: 4px; margin-bottom: 10px; display: flex; flex-direction: column; z-index: 2; position: relative;
        }
        /* ESTILOS DEL LED */
        .voice-led { width: 12px; height: 12px; border-radius: 50%; background: #222; border: 1px solid #555; transition: 0.3s; box-shadow: 0 0 2px #000; }
        /* APAGADO POR DEFECTO */
        .voice-led.listening { background: var(--hud-green); box-shadow: 0 0 15px var(--hud-green); } /* Verde: Escuchando */
        
        .sb-display-area {
            background: #000; border: 1px inset #333; padding: 10px; margin: 8px 0;
            font-family: 'Share Tech Mono'; color: var(--hud-green); text-align: center;
            font-size: 0.9rem; text-transform: uppercase; border-radius: 4px;
        }

        .btn-control { 
            background: #111; border: 1px solid #444; color: #aaa; 
            font-family: 'Orbitron'; font-size: 0.8rem; padding: 10px; width: 100%;
            cursor: pointer; font-weight: bold;
        }
        .btn-control.pwr-on { border-color: var(--hud-green); color: var(--hud-green); background: rgba(0,50,0,0.3); box-shadow: 0 0 10px var(--hud-green) inset; }

        /* SENSORES LIST */
        .panel-section { flex-grow: 1; overflow: hidden; position: relative; padding: 8px; background: rgba(0,0,0,0.4); border-radius: 4px; } 
        .sensor-grid { display: flex; flex-direction: column; gap: 4px; position: relative; z-index: 2; }
        .sensor-item { 
            display: flex; justify-content: space-between; align-items: center; 
            font-size: 0.65rem; padding: 4px 6px; 
            background: rgba(20,20,30,0.6); border-radius: 3px; border-left: 2px solid #333; backdrop-filter: blur(2px);
        }
        .sensor-icon { width: 15px; text-align: center; margin-right: 5px; display: inline-block; }
        
        .status-green { border-left-color: var(--hud-green); color: var(--hud-green); text-shadow: 0 0 5px rgba(0,255,65,0.3); }
        .status-blue { border-left-color: var(--hud-blue); color: var(--hud-blue); text-shadow: 0 0 5px rgba(0,136,255,0.3); }
        .status-orange { border-left-color: var(--hud-orange); color: var(--hud-orange); text-shadow: 0 0 5px rgba(255,174,0,0.3); }
        .status-red { border-left-color: var(--hud-red); color: #777; }

        /* PANEL INFERIOR */
        .dials-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; height: 100%; align-items: center; }
        .instrument-wrapper { 
            background: rgba(0,0,0,0.5); border: 1px solid #333; border-radius: 4px; height: 100%; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative;
        }
        .digital-display { font-family: 'VT323', monospace; font-size: 2.2rem; line-height: 1; text-shadow: 0 0 5px currentColor; }
        .digi-cyan { color: var(--hud-cyan); } .digi-green { color: var(--hud-green); } .digi-orange { color: var(--hud-orange); } .digi-red { color: var(--hud-red); }
        .knob-label { font-size: 0.6rem; color: #777; font-weight: bold; margin-top: 2px; }
        #energy-container { height: 20px; display: flex; gap: 1px; align-items: flex-end; margin-top: 5px; background: #000; border: 1px solid #333; padding: 1px; }
        .energy-bar-seg { flex: 1; background: #111; height: 100%; transition: height 0.05s; }
        .energy-bar-seg.active { background: var(--hud-green); }
        .energy-bar-seg.mid { background: var(--hud-orange); }
        .energy-bar-seg.high { background: var(--hud-red); }

        /* BOTONES FLOTANTES */
        #filter-controls-container { 
            position: absolute; top: 50%; right: 10px; transform: translateY(-50%); 
            display: flex; flex-direction: column; gap: 8px; z-index: 100;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .filter-btn { 
            width: 45px; height: 40px; background: rgba(0, 10, 20, 0.9); 
            color: var(--hud-cyan); font-family: 'Orbitron'; font-size: 0.6rem; 
            border: 1px solid var(--hud-cyan); cursor: pointer;
            clip-path: polygon(10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%);
        }
        .filter-btn.active { background: var(--hud-cyan); color: #000; box-shadow: 0 0 10px var(--hud-cyan); }
        
        /* BOT√ìN HUD: Sin 'active' por defecto */
        #btn-hud { background: rgba(0, 10, 20, 0.9); color: var(--hud-cyan); }
        #btn-hud.active { background: var(--hud-cyan); color: #000; }

        .ui-hiding { animation: waterPop 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards !important; pointer-events: none; }
        @keyframes waterPop { 0% { transform: scale(1); opacity: 1; blur(0); } 100% { transform: scale(2.5); opacity: 0; blur(10px); } }

        /* LOADING OVERLAY */
        #loading-overlay { 
            position: fixed; inset: 0; 
            z-index: 99999; /* MAXIMO Z-INDEX */
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            background-color: #000; /* Fallback */
            background-image: url('fondo_pantalla.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .horror-logo { width: 100px; margin-bottom: 20px; animation: horrorGlitch 0.3s infinite; filter: contrast(1.5) brightness(1.2); }
        
        #loading-text-main { color: var(--hud-cyan); font-family: 'Orbitron'; letter-spacing: 2px; font-size: 1.2rem; text-shadow: 0 0 5px var(--hud-cyan); margin-bottom: 5px; }
        #loading-text-sub { color: #ccc; font-family: 'Share Tech Mono'; font-size: 0.8rem; letter-spacing: 1px; margin-bottom: 15px; height: 1rem; text-shadow: 1px 1px 2px #000; }
        
        .loading-bar-container { width: 280px; background: rgba(0,0,0,0.5); height: 4px; border: 1px solid #333; position: relative; }
        #loading-bar { width: 0%; height: 100%; background: var(--hud-cyan); box-shadow: 0 0 10px var(--hud-cyan); transition: width 0.1s linear; }
        #loading-percent { color: var(--hud-cyan); font-family: 'VT323'; font-size: 1.2rem; margin-top: 5px; text-align: right; width: 280px; text-shadow: 1px 1px 2px #000; }
        
        #enter-btn { display: none; padding: 15px 40px; border: 2px solid var(--hud-green); color: var(--hud-green); background: rgba(0,0,0,0.7); font-family: 'Orbitron'; font-size: 1.2rem; cursor: pointer; margin-top: 30px; text-transform: uppercase; letter-spacing: 2px; box-shadow: 0 0 15px var(--hud-green); }
        /* Boton Glitch Horror */
        .btn-glitch { animation: btnGlitch 0.2s infinite; }
        @keyframes btnGlitch {
            0% { transform: translate(0,0); } 20% { transform: translate(-2px, 1px); filter: hue-rotate(90deg); } 40% { transform: translate(2px, -1px); } 60% { transform: translate(-1px, -1px); filter: invert(1); } 80% { transform: translate(1px, 1px); } 100% { transform: translate(0,0); }
        }

        @media (max-width: 768px) {
            :root { --left-panel-w: 140px; --bottom-panel-h: 110px; }
            .digital-display { font-size: 1.5rem; }
            .btn-control { font-size: 0.6rem; padding: 5px; }
            .sb-display-area { font-size: 0.7rem; padding: 5px; }
            #spirit-box-section { margin-bottom: 5px; padding: 4px; }
            .dials-grid { gap: 4px; }
            .sensor-item { font-size: 0.55rem; padding: 2px 4px; }
            #follow-banner { bottom: 10px; }
        }
    </style>
</head>
<body class="panels-hidden"> 

<!-- LOADING SCREEN -->
<div id="loading-overlay">
    <img src="obr-logo.png" class="horror-logo" id="load-logo">
    <div id="loading-text-main">CARGANDO M√ìDULOS...</div>
    <div id="loading-text-sub">INICIALIZANDO KERNEL...</div>
    
    <div class="loading-bar-container">
        <div id="loading-bar"></div>
    </div>
    <div id="loading-percent">0%</div>
    
    <button id="enter-btn" onclick="enterApp()">INICIAR SISTEMA</button>
</div>

<!-- LAYOUT GRID -->
<div id="app-ui" onclick="handleUITap(event)">
    
    <div id="left-panel" class="panel-container">
        <div id="spirit-box-section">
            <div class="section-title">SPIRIT BOX <div id="voice-led" class="voice-led"></div></div>
            <div class="sb-display-area"><span id="sb-status">OFFLINE</span></div>
            <button id="btn-pwr" class="btn-control" onclick="toggleSpirit()">ENCENDER</button>
            
            <div style="margin-top:8px; display:flex; flex-direction:column; gap:5px;">
                <div style="display:flex; justify-content:space-between; font-size:0.6rem; color:#888;">
                    <span>VOLUMEN</span><span id="vol-txt">100%</span>
                </div>
                <input type="range" id="vol-slider" min="0" max="100" value="100" style="width:100%; accent-color:var(--hud-green);">
                
                <div style="display:flex; justify-content:space-between; font-size:0.6rem; color:#888; margin-top:5px;">
                    <span>SCAN SPEED</span><span id="spd-txt">1</span>
                </div>
                <input type="range" id="speed-slider" min="1" max="3" step="1" value="1" style="width:100%; accent-color:var(--hud-orange);">
            </div>
        </div>
        
        <div class="panel-section">
            <canvas id="matrix-canvas"></canvas> 
            <div class="section-title">SENSORES</div>
            <div class="sensor-grid">
                <div class="sensor-item status-red" id="sens-mag"><span class="sensor-icon">üß≠</span> MAG</div>
                <div class="sensor-item status-red" id="sens-acc"><span class="sensor-icon">üìâ</span> ACEL</div>
                <div class="sensor-item status-red" id="sens-gyro"><span class="sensor-icon">üí´</span> GIRO</div>
                <div class="sensor-item status-red" id="sens-mic"><span class="sensor-icon">üéôÔ∏è</span> MIC</div>
                <div class="sensor-item status-red" id="sens-prox"><span class="sensor-icon">üì°</span> PROX</div>
                <div class="sensor-item status-red" id="sens-lidar"><span class="sensor-icon">üì∏</span> LIDAR</div>
            </div>
        </div>
    </div>

    <div id="main-view-area">
        <div id="zoom-container">
            <video id="bg-camera-feed" playsinline autoplay muted></video>
            <canvas id="main-filter-canvas" style="display:none;"></canvas>
        </div>
        
        <div class="camera-border"><div class="cb-inner"></div></div>
        <div class="rec-container"><div class="rec-dot"></div>REC</div>
        
        <div class="stats-container">
            <div><span class="stats-val" id="cam-fps">--</span> FPS</div>
            <div><span class="stats-val" id="cam-res">--x--</span></div>
            <div><span class="stats-val" id="zoom-lvl">1.0x</span></div>
        </div>

        <div id="logo-container"><img id="logo-image" src="obr-logo.png"></div>

        <div id="follow-banner">
            <div class="banner-content">
                <div id="step-1" class="seq-step">S√çGUENOS EN</div>
                <div id="step-2" class="seq-step" style="display:none; gap:15px; justify-content:center;">
                    <i class="fab fa-tiktok social-icon" style="color:#ff0050;"></i>
                    <i class="fab fa-facebook social-icon" style="color:#1877f2;"></i>
                    <i class="fab fa-youtube social-icon" style="color:#f00;"></i>
                </div>
                <div id="step-3" class="seq-step">@EXPLORACIONES OBR</div>
            </div>
        </div>

        <div id="filter-controls-container">
            <button class="filter-btn" onclick="toggleFilter('night-vision')">NVG</button>
            <button class="filter-btn" onclick="toggleFilter('sls')">SLS</button>
            <button class="filter-btn" onclick="toggleFilter('negative')">NEG</button>
            <button class="filter-btn" onclick="toggleFilter('lum')">LUM</button>
            <!-- BOT√ìN HUD SIN 'active' -->
            <button class="filter-btn" id="btn-hud" onclick="toggleHUD()">HUD</button>
        </div>
    </div>

    <div id="bottom-panel" class="panel-container">
        <div class="dials-grid">
            <div class="instrument-wrapper">
                <div class="digital-display digi-cyan" id="mag-val">000</div>
                <div class="knob-label">MAG</div>
            </div>
            <div class="instrument-wrapper">
                <div class="digital-display digi-green" id="emf-val">0.0</div>
                <div class="knob-label">EMF</div>
            </div>
            <div class="instrument-wrapper">
                <div class="digital-display digi-orange" id="temp-display">--.-</div>
                <div class="knob-label">TEMP</div>
            </div>
            <div class="instrument-wrapper">
                <div class="digital-display digi-red" id="prox-val">0</div>
                <div class="knob-label">PROX</div>
            </div>
        </div>
        <div style="margin-top:5px;">
            <div id="energy-container"></div>
            <div class="knob-label" style="text-align:left;">ENERGY LEVEL</div>
        </div>
    </div>

</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzOf3crQxBdPylwMTAd34W-nBShN31MkIUtaMdKsZHMZVVniI2HjMesD6DpOlO363T1/exec";
    const FALLBACK_AUTO = ["¬øHay alguien?", "Te escucho", "Ac√©rcate", "Detr√°s", "Fr√≠o", "Ayuda", "Vete", "S√≥tano", "Miedo", "Luz", "Oscuridad", "Aqu√≠"];
    
    let audioCtx, masterGain, micSource, analyser;
    let bgBuffer, bgNode, bgGain;
    let noiseNode, noiseGain;
    let recognition, isSpiritOn = false;
    let autoData = [...FALLBACK_AUTO], progData = new Map();
    let videoTrack, currentFilter = 'none', uiVisible = false, hideTimeout;
    let proxSensor, energyBars = [];
    let isRecognizing = false; 
    let scanSpeed = 1.0;
    let interferenceInterval;
    
    // Variables ZOOM
    let zoomLevel = 1;
    let zoomTapCount = 0;
    let zoomTapTimer = null;
    const zoomContainer = document.getElementById('zoom-container');
    const mainView = document.getElementById('main-view-area');

    const vid = document.getElementById('bg-camera-feed');
    const canvasSLS = document.getElementById('main-filter-canvas'); const ctxSLS = canvasSLS.getContext('2d');
    
    // MATRIX VARS
    const matrixCanvas = document.getElementById('matrix-canvas');
    const mCtx = matrixCanvas.getContext('2d');
    let matrixDrops = [];

    // LOADING VARS
    let loadProgress = 0;
    let loadInterval;
    let dataLoaded = false;
    let dataStats = { prog: 0, auto: 0 };

    window.onload = () => {
        const eContainer = document.getElementById('energy-container');
        for(let i=0; i<20; i++){
            let d = document.createElement('div'); d.className = 'energy-bar-seg';
            eContainer.appendChild(d); energyBars.push(d);
        }
        
        setupZoomEvents();
        startLoadingSequence();
        // Cargar datos en segundo plano
        loadData();
    };

    function startLoadingSequence() {
        const txtMain = document.getElementById('loading-text-main');
        const txtSub = document.getElementById('loading-text-sub');
        const bar = document.getElementById('loading-bar');
        const perc = document.getElementById('loading-percent');
        const btn = document.getElementById('enter-btn');
        const logo = document.getElementById('load-logo');

        loadInterval = setInterval(() => {
            loadProgress += Math.random() * 2; 
            if(loadProgress > 100) loadProgress = 100;

            // Fases de Texto
            if(loadProgress > 30 && loadProgress < 60) {
                txtMain.innerText = "ACTIVANDO SENSORES...";
                txtSub.innerText = "CALIBRANDO GIROSCOPIO...";
            } else if(loadProgress > 60 && loadProgress < 90) {
                txtMain.innerText = "SINTONIZANDO...";
                if(dataLoaded) {
                    txtSub.innerText = `SINCRONIZADO PROG:${dataStats.prog} | AUTO:${dataStats.auto}`;
                    txtSub.style.color = "var(--hud-green)";
                } else {
                    txtSub.innerText = "ESPERANDO RED...";
                }
            } else if(loadProgress >= 99) {
                // CORRECCI√ìN: Si falla la carga, forzamos el 100% de todas formas
                if(!dataLoaded) {
                     dataLoaded = true; // Force continue
                }
                
                clearInterval(loadInterval);
                loadProgress = 100;
                txtMain.innerText = "LISTO...";
                
                if(dataStats.prog > 0) {
                     txtSub.innerText = "SISTEMA ONLINE";
                } else {
                     txtSub.innerText = "FALLO CR√çTICO EN SENSORES";
                     txtSub.style.color = "var(--hud-red)";
                }
                
                btn.style.display = "block";
                btn.classList.add('btn-glitch');
            }

            bar.style.width = loadProgress + "%";
            perc.innerText = Math.floor(loadProgress) + "%";

        }, 50);
    }

    function initMatrix() {
        const pSection = matrixCanvas.parentElement;
        if(!pSection) return;
        matrixCanvas.width = pSection.clientWidth;
        matrixCanvas.height = pSection.clientHeight;
        const columns = Math.floor(matrixCanvas.width / 15);
        matrixDrops = Array(columns).fill(1);
    }
    
    function drawMatrix() {
        mCtx.fillStyle = 'rgba(0, 0, 0, 0.1)'; 
        mCtx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);
        mCtx.fillStyle = '#00f3ff'; 
        mCtx.font = '10px Share Tech Mono';
        
        for(let i = 0; i < matrixDrops.length; i++) {
            let text = String.fromCharCode(65 + Math.floor(Math.random() * 26)); 
            if (Math.random() > 0.99 && autoData.length > 0) {
                text = autoData[Math.floor(Math.random() * autoData.length)].toUpperCase(); 
                mCtx.fillStyle = '#ff0055'; 
            } else {
                mCtx.fillStyle = '#00f3ff';
            }
            const x = i * 15;
            const y = matrixCanvas.height - (matrixDrops[i] * 15);
            mCtx.fillText(text, x, y);
            if(y < 0 && Math.random() > 0.975) matrixDrops[i] = 0;
            matrixDrops[i]++;
        }
    }

    function setupZoomEvents() {
        mainView.addEventListener('touchend', handleTapZoom);
        mainView.addEventListener('click', handleTapZoom); 
    }

    function handleTapZoom(e) {
        const now = new Date().getTime();
        const timeSince = now - (window.lastTapTime || 0);
        
        let clientX, clientY;
        if (e.changedTouches && e.changedTouches.length > 0) {
            clientX = e.changedTouches[0].clientX;
            clientY = e.changedTouches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }

        if (timeSince < 300 && timeSince > 0) zoomTapCount++; else zoomTapCount = 1;
        window.lastTapTime = now;

        clearTimeout(zoomTapTimer);
        zoomTapTimer = setTimeout(() => {
            const rect = mainView.getBoundingClientRect();
            const x = clientX - rect.left;
            const y = clientY - rect.top;

            if (zoomTapCount === 1) { zoomLevel = 1.0; zoomContainer.style.transformOrigin = "center center"; } 
            else if (zoomTapCount === 2) { zoomLevel = 3.0; zoomContainer.style.transformOrigin = `${x}px ${y}px`; } 
            else if (zoomTapCount >= 3) { zoomLevel = 5.0; zoomContainer.style.transformOrigin = `${x}px ${y}px`; }
            
            applyZoom();
            zoomTapCount = 0; 
        }, 300); 
    }

    function applyZoom() {
        zoomContainer.style.transform = `scale(${zoomLevel})`;
        document.getElementById('zoom-lvl').innerText = zoomLevel.toFixed(1) + "x";
    }

    async function enterApp(){
        document.getElementById('loading-overlay').style.display='none';
        document.getElementById('app-ui').style.opacity = 1;
        document.getElementById('app-ui').style.pointerEvents = 'auto';
        document.body.classList.add('panels-hidden');
        
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        masterGain = audioCtx.createGain(); masterGain.connect(audioCtx.destination);
        bgBuffer = await loadAudio('FONDO_1.mp3');
        
        initMic(); await startCam(); await initMoveNet(); initSensors();
        initMatrix();
        startBannerLoop();
        loop();
    }

    function startBannerLoop() {
        const banner = document.getElementById('follow-banner');
        const step1 = document.getElementById('step-1'); const step2 = document.getElementById('step-2'); const step3 = document.getElementById('step-3');
        const runSequence = () => {
            banner.classList.add('active');
            step1.classList.add('active');
            setTimeout(() => { step1.classList.remove('active'); step2.style.display='flex'; step2.classList.add('active'); }, 2000);
            setTimeout(() => { step2.classList.remove('active'); step2.style.display='none'; step3.classList.add('active'); }, 5000);
            setTimeout(() => { step3.classList.remove('active'); banner.classList.remove('active'); setTimeout(runSequence, 15000); }, 8000);
        };
        runSequence();
    }

    async function startCam(){
        try{
            const constraints = { audio: false, video: { facingMode: { exact: "environment" }, width: { ideal: 3840 }, height: { ideal: 2160 } } };
            try { const s = await navigator.mediaDevices.getUserMedia(constraints); handleStream(s); } 
            catch (e) { 
                 const fallbackConstraints = { audio: false, video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } };
                 const s = await navigator.mediaDevices.getUserMedia(fallbackConstraints); handleStream(s);
            }
        }catch(e){ console.log("Cam error", e); }
    }
    
    function handleStream(stream) {
        vid.srcObject = stream; videoTrack = stream.getVideoTracks()[0];
        vid.onloadedmetadata = ()=> { resize(); document.getElementById('cam-res').innerText = `${vid.videoWidth}x${vid.videoHeight}`; }; 
        window.onresize = resize;
    }

    function resize(){
        const area = document.getElementById('main-view-area');
        canvasSLS.width = area.clientWidth; canvasSLS.height = area.clientHeight;
        const pSection = document.querySelector('.panel-section');
        if(pSection) { matrixCanvas.width = pSection.clientWidth; matrixCanvas.height = pSection.clientHeight; }
    }

    async function toggleFilter(f){
        if(currentFilter===f) f='none';
        document.body.classList.remove('filter-night-vision', 'filter-negative', 'filter-sls', 'filter-lum');
        document.querySelectorAll('.filter-btn').forEach(b=> { if(b.id !== 'btn-hud') b.classList.remove('active'); });
        if(f!=='none') {
            document.body.classList.add('filter-'+f);
            document.querySelector(`button[onclick="toggleFilter('${f}')"]`).classList.add('active');
        }
        document.getElementById('main-filter-canvas').style.display = f==='sls'?'block':'none';
        if(videoTrack) try{ await videoTrack.applyConstraints({advanced:[{torch: f==='night-vision'}]}); }catch(e){}
        currentFilter = f;
    }

    function toggleHUD(){
        const body = document.body; const btn = document.getElementById('btn-hud');
        body.classList.toggle('panels-hidden');
        if(body.classList.contains('panels-hidden')) btn.classList.remove('active'); else btn.classList.add('active');
        setTimeout(resize, 550);
    }

    function handleUITap(e){
        if(e.target.closest('.panel-container') || e.target.closest('button') || e.target.closest('input')) return;
        if(uiVisible) hideControls(); else showControls();
    }
    function showControls() {
        uiVisible = true;
        document.getElementById('filter-controls-container').style.opacity = '1'; document.getElementById('filter-controls-container').style.pointerEvents = 'auto';
        document.getElementById('logo-container').classList.add('ui-hiding'); document.getElementById('follow-banner').classList.add('ui-hiding');
        clearTimeout(hideTimeout); hideTimeout = setTimeout(hideControls, 5000);
    }
    function hideControls() {
        uiVisible = false;
        document.getElementById('filter-controls-container').style.opacity = '0'; document.getElementById('filter-controls-container').style.pointerEvents = 'none';
        document.getElementById('logo-container').classList.remove('ui-hiding'); document.getElementById('follow-banner').classList.remove('ui-hiding');
    }

    function setSensorStatus(id, status) {
        const el = document.getElementById(id); if (!el) return;
        el.className = 'sensor-item';
        if(status === 'main') el.classList.add('status-green');
        else if(status === 'backup') el.classList.add('status-blue');
        else if(status === 'sim') el.classList.add('status-orange');
        else el.classList.add('status-red');
    }

    function initSensors(){
        let magActive = false; let motionActive = false;
        const requestAccess = async () => {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try { const p = await DeviceOrientationEvent.requestPermission(); if (p === 'granted') window.addEventListener('deviceorientation', handleOrientation); } catch (e) {}
            } else window.addEventListener('deviceorientation', handleOrientation);

            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                try { const p = await DeviceMotionEvent.requestPermission(); if (p === 'granted') window.addEventListener('devicemotion', handleMotion); } catch (e) {}
            } else window.addEventListener('devicemotion', handleMotion);
        };
        const handleOrientation = (e) => {
            if(e.alpha !== null) { document.getElementById('mag-val').innerText = Math.round(e.alpha).toString().padStart(3,'0'); setSensorStatus('sens-mag', 'main'); magActive = true; }
        };
        const handleMotion = (e) => {
            const a = e.accelerationIncludingGravity; const r = e.rotationRate;
            if(a){
                let t = Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z);
                let emf = (t * 2.5).toFixed(1); document.getElementById('emf-val').innerText = emf;
                setSensorStatus('sens-acc', 'main'); setSensorStatus('sens-lidar', 'sim'); motionActive = true;
            }
            if(r && (r.alpha || r.beta || r.gamma)) setSensorStatus('sens-gyro', 'main');
        };
        requestAccess(); initProximity();

        setInterval(() => {
            if(!magActive) { setSensorStatus('sens-mag', 'sim'); document.getElementById('mag-val').innerText = Math.floor(Math.random()*360).toString().padStart(3,'0'); }
            if(!motionActive) { setSensorStatus('sens-acc', 'sim'); setSensorStatus('sens-gyro', 'sim'); setSensorStatus('sens-lidar', 'status-red'); let noise = (0.3 + Math.random() * 0.9).toFixed(1); document.getElementById('emf-val').innerText = noise; }
        }, 500);
    }

    function initProximity(){
        if('ProximitySensor' in window){
            try {
                proxSensor = new ProximitySensor({frequency: 10});
                proxSensor.addEventListener('reading', () => { document.getElementById('prox-val').innerText = proxSensor.value ? proxSensor.value.toFixed(0) : "0"; setSensorStatus('sens-prox', 'main'); });
                proxSensor.start();
            } catch(e){ setSensorStatus('sens-prox', 'status-red'); }
        } else { 
            setSensorStatus('sens-prox', 'sim'); 
            setInterval(() => { if(Math.random() > 0.95) { document.getElementById('prox-val').innerText = Math.floor(Math.random() * 5); setTimeout(() => document.getElementById('prox-val').innerText = "0", 800); } }, 1000);
        }
    }

    async function loadAudio(u){ try{const r=await fetch(u);const b=await r.arrayBuffer();return await audioCtx.decodeAudioData(b);}catch(e){return null;} }
    async function initMic(){
        try{
            const s = await navigator.mediaDevices.getUserMedia({audio:true});
            micSource = audioCtx.createMediaStreamSource(s);
            analyser = audioCtx.createAnalyser(); analyser.fftSize=64; 
            micSource.connect(analyser);
            setSensorStatus('sens-mic', 'main');
        }catch(e){ setSensorStatus('sens-mic', 'status-red'); }
    }
    
    function toggleSpirit(){
        isSpiritOn = !isSpiritOn;
        const btn = document.getElementById('btn-pwr');
        const status = document.getElementById('sb-status');
        if(isSpiritOn){
            btn.innerText="APAGAR"; btn.classList.add('pwr-on');
            status.innerText = "INICIANDO...";
            
            if(audioCtx.state==='suspended') audioCtx.resume();
            
            if(bgBuffer){
                bgNode = audioCtx.createBufferSource(); bgNode.buffer=bgBuffer; bgNode.loop=true;
                bgNode.playbackRate.value = scanSpeed; 
                bgGain = audioCtx.createGain(); bgGain.gain.value=0.8;  
                bgNode.connect(bgGain); bgGain.connect(masterGain); bgNode.start(0);
            } else { startFallbackNoise(); }
            startListeningCycle();
        }else{
            btn.innerText="ENCENDER"; btn.classList.remove('pwr-on');
            status.innerText = "APAGADO";
            // Apagar LED al apagar Spirit Box
            document.getElementById('voice-led').classList.remove('listening');
            
            if(bgNode) { bgNode.stop(); bgNode = null; }
            if(noiseNode) { noiseNode.stop(); noiseNode = null; }
            if(interferenceInterval) clearInterval(interferenceInterval);
            if(window.speechSynthesis) window.speechSynthesis.cancel();
            if(recognition) recognition.stop();
        }
    }

    function startFallbackNoise() {
        if(noiseNode) return; 
        const bSize = audioCtx.sampleRate * 2; const b = audioCtx.createBuffer(1, bSize, audioCtx.sampleRate);
        const d = b.getChannelData(0); for (let i = 0; i < bSize; i++) d[i] = Math.random() * 2 - 1;
        noiseNode = audioCtx.createBufferSource(); noiseNode.buffer = b; noiseNode.loop = true;
        const filter = audioCtx.createBiquadFilter(); filter.type = "bandpass"; filter.frequency.value = 1000;
        noiseGain = audioCtx.createGain(); noiseGain.gain.value = 0.15;
        noiseNode.connect(filter); filter.connect(noiseGain); noiseGain.connect(masterGain); noiseNode.start(0);
    }

    document.getElementById('speed-slider').addEventListener('input', (e) => {
        scanSpeed = parseFloat(e.target.value);
        let rate = 1.0; if(scanSpeed === 1) rate = 0.8; if(scanSpeed === 2) rate = 1.0; if(scanSpeed === 3) rate = 1.5;
        document.getElementById('spd-txt').innerText = scanSpeed;
        if(bgNode) bgNode.playbackRate.value = rate;
    });

    function startListeningCycle(){
        if(!isSpiritOn) return;
        if(isRecognizing) return;
        
        // LED VERDE = ESCUCHANDO
        document.getElementById('voice-led').classList.add('listening');
        
        if(!recognition) {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(SR) {
                recognition = new SR(); recognition.lang='es-MX'; recognition.continuous=false;
                recognition.onstart = () => { isRecognizing = true; };
                recognition.onend = () => { 
                    isRecognizing = false; 
                    // LED APAGADO = NO ESCUCHANDO (PROCESANDO)
                    document.getElementById('voice-led').classList.remove('listening');
                    if(isSpiritOn && !window.speechSynthesis.speaking) setTimeout(startListeningCycle, 1500); // Pausa 1.5s antes de volver a escuchar
                };
                recognition.onresult = (e) => { processVoiceCommand(e.results[0][0].transcript.toLowerCase().trim()); };
                recognition.onerror = () => { 
                    isRecognizing = false; 
                    document.getElementById('voice-led').classList.remove('listening');
                    if(isSpiritOn) setTimeout(startListeningCycle, 1000); 
                };
            }
        }
        try{ recognition.start(); }catch(e){}
    }
    
    function processVoiceCommand(txt){
        // LED ya apagado en onend, pero aseguramos
        document.getElementById('voice-led').classList.remove('listening');
        document.getElementById('sb-status').innerText = "PROCESANDO...";
        let response = null;
        for (let [key, value] of progData) { if (txt.includes(key)) { response = value; break; } }
        if (!response) response = autoData[Math.floor(Math.random()*autoData.length)];
        
        // Respuesta en 1.5s (reducido de 4s)
        setTimeout(() => speak(response), 1500); 
    }
    
    function speak(txt){
        if(!window.speechSynthesis) return;
        document.getElementById('sb-status').innerText = "DESCODIFICANDO...";
        
        if(bgGain) {
            bgGain.gain.cancelScheduledValues(audioCtx.currentTime);
            bgGain.gain.setValueAtTime(bgGain.gain.value, audioCtx.currentTime);
            bgGain.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime + 0.1);
        }
        if(noiseGain) {
            noiseGain.gain.cancelScheduledValues(audioCtx.currentTime);
            noiseGain.gain.setValueAtTime(noiseGain.gain.value, audioCtx.currentTime);
            noiseGain.gain.linearRampToValueAtTime(0.02, audioCtx.currentTime + 0.1);
        }
        
        if(interferenceInterval) clearInterval(interferenceInterval);
        interferenceInterval = setInterval(() => {
            if(!bgGain) return;
            const randomSpike = 0.05 + (Math.random() * 0.1); 
            bgGain.gain.cancelScheduledValues(audioCtx.currentTime);
            bgGain.gain.setValueAtTime(randomSpike, audioCtx.currentTime);
            bgGain.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime + 0.1);
        }, 250); 

        const u = new SpeechSynthesisUtterance(txt); u.lang='es-MX'; u.rate = 0.85; u.pitch = 0.9; u.volume = 1.0; 

        u.onend = () => { 
            clearInterval(interferenceInterval);
            if(bgGain) {
                bgGain.gain.cancelScheduledValues(audioCtx.currentTime);
                bgGain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                bgGain.gain.linearRampToValueAtTime(0.8, audioCtx.currentTime + 0.5);
            }
            if(noiseGain) {
                noiseGain.gain.cancelScheduledValues(audioCtx.currentTime);
                noiseGain.gain.linearRampToValueAtTime(0.15, audioCtx.currentTime + 0.5);
            }
            if(isSpiritOn) setTimeout(startListeningCycle, 3000); 
        };
        window.speechSynthesis.speak(u);
    }

    document.getElementById('vol-slider').addEventListener('input', e=>{
        if(masterGain) masterGain.gain.value = e.target.value/100;
        document.getElementById('vol-txt').innerText=e.target.value+"%";
    });

    let lastFps=0, frames=0;
    function loop(){
        frames++;
        if(performance.now()-lastFps>=1000){
            document.getElementById('cam-fps').innerText = frames;
            frames=0; lastFps=performance.now();
            document.getElementById('temp-display').innerText = (18+Math.random()*3).toFixed(1);
        }
        
        if(currentFilter==='sls'){
            ctxSLS.clearRect(0,0,canvasSLS.width,canvasSLS.height);
            if (latestPoses.length > 0) drawSLS(latestPoses);
        }
        
        drawMatrix();
        
        if(analyser){
            const data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);
            for(let i=0; i<20; i++){
                let val = (data[i] || 0);
                let bar = energyBars[i];
                bar.className = 'energy-bar-seg';
                if(val>50) bar.classList.add('active'); if(val>150) bar.classList.add('mid'); if(val>220) bar.classList.add('high');
                bar.style.height = Math.max(5, (val/255)*100) + "%";
            }
        }
        requestAnimationFrame(loop);
    }

    // DATA LOADING
    async function loadData(){
        try {
            const r=await fetch(SCRIPT_URL); 
            if(!r.ok) throw new Error("Red");
            const d=await r.json();
            
            if(d.automatico) autoData=d.automatico.map(x=>x.TEXTO);
            if(d.programado) d.programado.forEach(i=>{if(i.PREGUNTA) progData.set(i.PREGUNTA.toLowerCase().trim(), i.RESPUESTA)});
            
            dataLoaded = true;
            dataStats.prog = d.programado ? d.programado.length : 0;
            dataStats.auto = d.automatico ? d.automatico.length : 0;
        } catch(e) {
            console.error("Load error", e);
            dataLoaded = false;
        }
    }

    let latestPoses = [];
    async function initMoveNet() {
        await tf.ready();
        const detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet, { modelType: poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING });
        setInterval(async () => { 
            if(currentFilter==='sls' && vid.readyState===4) {
                try { latestPoses = await detector.estimatePoses(vid); } catch(e) { latestPoses = []; }
            } else { latestPoses = []; }
        }, 100);
    }
    const conns = [['left_shoulder','right_shoulder'],['left_shoulder','left_hip'],['right_shoulder','right_hip'],['left_hip','right_hip'],['left_shoulder','left_elbow'],['left_elbow','left_wrist'],['right_shoulder','right_elbow'],['right_elbow','right_wrist'],['left_hip','left_knee'],['left_knee','left_ankle'],['right_hip','right_knee'],['right_knee','right_ankle']];
    function drawSLS(poses) {
        const vidW = vid.videoWidth, vidH = vid.videoHeight; const canW = canvasSLS.width, canH = canvasSLS.height;
        const scale = Math.max(canW/vidW, canH/vidH); const xo = (canW - vidW*scale)/2, yo = (canH - vidH*scale)/2;
        ctxSLS.lineWidth = 3; ctxSLS.lineCap = 'round'; ctxSLS.strokeStyle = '#00ff41'; ctxSLS.shadowBlur = 10; ctxSLS.shadowColor = '#00ff41';
        poses.forEach(p => {
            if(p.score<0.25)return; const kp=p.keypoints; const m={}; kp.forEach(k=>m[k.name]=k);
            ctxSLS.beginPath(); conns.forEach(([a,b])=>{ const p1=m[a],p2=m[b]; if(p1&&p2&&p1.score>0.3&&p2.score>0.3){ctxSLS.moveTo(p1.x*scale+xo,p1.y*scale+yo);ctxSLS.lineTo(p2.x*scale+xo,p2.y*scale+yo);} }); ctxSLS.stroke();
            ctxSLS.fillStyle='#ff0055'; kp.forEach(k=>{if(k.score>0.3){ctxSLS.beginPath();ctxSLS.arc(k.x*scale+xo,k.y*scale+yo,4,0,2*Math.PI);ctxSLS.fill();}});
        });
    }
</script>
</body>
</html>
