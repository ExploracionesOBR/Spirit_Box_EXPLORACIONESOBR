<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>DETECTOR-OBR v12.5 MASTER-LINK</title> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@500;700;900&family=Creepster&family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <style>
        /* --- ESTILOS BASE --- */
        :root { --hud-cyan: #00f3ff; --hud-green: #00ff41; --hud-red: #ff3333; --glass: rgba(5, 8, 15, 0.95); }
        body { font-family: 'Share Tech Mono', monospace; background: #000; color: var(--hud-cyan); overflow: hidden; width: 100vw; height: 100vh; margin: 0; user-select: none; }
        
        #app-ui { display: grid; width: 100%; height: 100%; grid-template-columns: 280px 1fr; grid-template-rows: 1fr 160px; grid-template-areas: "left cam" "left bottom"; transition: 0.5s; opacity: 0; pointer-events: none; }
        body.panels-hidden #app-ui { grid-template-columns: 0px 1fr; grid-template-rows: 1fr 0px; }

        #left-panel { grid-area: left; border-right: 2px solid var(--hud-cyan); overflow: hidden; z-index: 50; background: var(--glass); padding: 10px; }
        #bottom-panel { grid-area: bottom; border-top: 2px solid var(--hud-cyan); overflow: hidden; z-index: 50; background: var(--glass); padding: 10px; display: flex; flex-direction: column; }
        #main-view-area { grid-area: cam; position: relative; overflow: hidden; background: #000; }
        body.panels-hidden #left-panel, body.panels-hidden #bottom-panel { display: none; }

        /* --- BOTON RX PERSONALIZADO (COLORES EXACTOS) --- */
        .btn-rx { 
            margin-top: 10px; padding: 10px; border-radius: 4px; font-weight: bold; 
            text-align: center; cursor: pointer; font-family: 'Orbitron'; letter-spacing: 1px;
            font-size: 0.8rem; transition: all 0.2s; text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        
        /* ROJO (OFF) */
        .rx-off {
            background: #330000; 
            border: 2px solid #ff0000; 
            color: #ff0000;
            box-shadow: inset 0 0 10px #550000;
        }

        /* VERDE (ON) */
        .rx-on {
            background: #004400; 
            border: 2px solid #00ff41; 
            color: #00ff41;
            box-shadow: 0 0 15px #00ff41;
            animation: none;
        }

        /* Resto de UI (Sensores, Spirit Box, etc) */
        .section-title { font-family: 'Orbitron'; font-size: 0.65rem; font-weight: 800; color: var(--hud-cyan); margin-bottom: 5px; border-bottom: 1px solid rgba(0, 243, 255, 0.3); }
        .sensor-grid { display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
        .sensor-item { display: flex; justify-content: space-between; font-size: 0.65rem; padding: 4px; background: rgba(20,20,30,0.6); border-left: 2px solid #333; }
        .status-green { border-left-color: var(--hud-green); color: var(--hud-green); }
        .status-red { border-left-color: var(--hud-red); color: #777; }
        
        /* Elementos Esenciales */
        #bg-camera-feed { width: 100%; height: 100%; object-fit: cover; }
        #main-filter-canvas, #matrix-canvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; }
        #zoom-container { width: 100%; height: 100%; transform-origin: center center; transition: transform 0.3s; }
        
        /* Loading */
        #loading-overlay { position: fixed; inset: 0; z-index: 999; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #enter-btn { display: none; padding: 15px 40px; border: 2px solid #0f0; color: #0f0; background: transparent; font-family: 'Orbitron'; font-size: 1.2rem; margin-top: 20px; }
    </style>
</head>
<body class="panels-hidden"> 

<div id="loading-overlay">
    <h1 style="font-family: 'Creepster'; font-size: 3rem; color: #00f3ff;">SISTEMA OBR</h1>
    <div style="color:#888; font-family: monospace; margin-top:10px;">CARGANDO M√ìDULOS...</div>
    <button id="enter-btn" onclick="enterApp()">INICIAR</button>
</div>

<div id="app-ui">
    
    <div id="left-panel">
        <div class="section-title">SPIRIT BOX</div>
        <div style="border: 1px solid #333; padding: 5px; margin-bottom: 10px;">
            <div style="text-align: center; color: #0f0; font-family: monospace;">OFFLINE</div>
        </div>

        <div class="section-title">AUDIO RX (ENLACE)</div>
        <div id="btn-rx" class="btn-rx rx-off" onclick="toggleRX()">
            üî¥ RX OFF<br><span style="font-size:0.6rem; font-weight:normal;">(AUDIO EN MEZCLADOR)</span>
        </div>

        <div class="section-title" style="margin-top: 15px;">SENSORES</div>
        <div class="sensor-grid">
            <div class="sensor-item status-green"><span>üß≠ MAG</span><span>ACTIVO</span></div>
            <div class="sensor-item status-green"><span>üìâ ACEL</span><span>ACTIVO</span></div>
            <div class="sensor-item status-green"><span>üéôÔ∏è MIC</span><span>ACTIVO</span></div>
        </div>
    </div>

    <div id="main-view-area">
        <div id="zoom-container">
            <video id="bg-camera-feed" playsinline autoplay muted></video>
            <canvas id="main-filter-canvas"></canvas>
        </div>
        <div style="position:absolute; top:10px; left:10px; color:red; font-weight:bold;">REC ‚óè</div>
    </div>

    <div id="bottom-panel">
        <div style="display: flex; justify-content: space-around; align-items: center; height: 100%;">
            <div style="text-align:center;"><div style="font-size:2rem; color:#00f3ff; font-family:'VT323';">000</div><div style="font-size:0.6rem; color:#666;">MAG</div></div>
            <div style="text-align:center;"><div style="font-size:2rem; color:#00ff41; font-family:'VT323';">0.0</div><div style="font-size:0.6rem; color:#666;">EMF</div></div>
            <div style="text-align:center;"><div style="font-size:2rem; color:#ffae00; font-family:'VT323';">22.5</div><div style="font-size:0.6rem; color:#666;">TEMP</div></div>
        </div>
    </div>

    <audio id="incoming-feed" autoplay></audio>
</div>

<script>
    const MIXER_ID = "obr-mezclador-central";
    let peer, dataConn;
    let incomingAudioEl = document.getElementById('incoming-feed');
    let isRxOn = false;

    function enterApp(){
        document.getElementById('loading-overlay').style.display='none';
        document.getElementById('app-ui').style.opacity = 1;
        document.getElementById('app-ui').style.pointerEvents = 'auto';
        document.body.classList.remove('panels-hidden');
        
        startCam();
        initPeer();
    }

    // --- LOGICA PEERJS (EL CEREBRO) ---
    function initPeer() {
        peer = new Peer(); // ID aleatorio
        
        peer.on('open', id => {
            console.log("Detector ID:", id);
            connectData(); // 1. Conectar canal de datos
        });

        // 2. Recibir Audio (Llamada)
        peer.on('call', call => {
            call.answer();
            call.on('stream', remoteStream => {
                incomingAudioEl.srcObject = remoteStream;
                incomingAudioEl.muted = true; // Empieza muteado (RX OFF)
            });
        });
    }

    function connectData() {
        // Conectar canal de mensajes al mezclador
        dataConn = peer.connect(MIXER_ID);
        dataConn.on('open', () => {
            console.log("Canal de Comandos Abierto");
            // Forzar estado inicial OFF
            sendCmd('RX_OFF'); 
        });
    }

    function sendCmd(cmd) {
        if(dataConn && dataConn.open) {
            dataConn.send({ cmd: cmd });
        }
    }

    // --- BOTON RX (INTERACCION) ---
    function toggleRX() {
        isRxOn = !isRxOn;
        const btn = document.getElementById('btn-rx');

        if (isRxOn) {
            // ESTADO: ON (VERDE)
            btn.className = "btn-rx rx-on";
            btn.innerHTML = "üü¢ RX ON<br><span style='font-size:0.6rem; font-weight:normal;'>(AUDIO AQU√ç)</span>";
            
            // Audio Local: Se escucha
            incomingAudioEl.muted = false;
            incomingAudioEl.play().catch(e=>console.log("Click needed"));

            // Orden Remota: Calla al mezclador
            sendCmd('RX_ON');

        } else {
            // ESTADO: OFF (ROJO)
            btn.className = "btn-rx rx-off";
            btn.innerHTML = "üî¥ RX OFF<br><span style='font-size:0.6rem; font-weight:normal;'>(AUDIO EN MEZCLADOR)</span>";
            
            // Audio Local: Mute
            incomingAudioEl.muted = true;

            // Orden Remota: Activa al mezclador
            sendCmd('RX_OFF');
        }
    }

    // --- UTILIDADES BASICAS (CAMARA) ---
    async function startCam(){
        try { 
            const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
            document.getElementById('bg-camera-feed').srcObject = s;
        } catch(e) { console.log("Error cam"); }
    }

    // Simulaci√≥n de carga
    setTimeout(() => { document.getElementById('enter-btn').style.display = 'block'; }, 1500);
</script>
</body>
</html>
