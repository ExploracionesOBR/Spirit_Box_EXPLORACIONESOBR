<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>DETECTOR OBR</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <style>
        :root {
            --neon-green: #39FF14;
            --alert-red: #FF3333;
            --sim-orange: #FFB000;
            --sensor-blue: #00BFFF; 
            --panel-bg-dark: #1A1A1A;
            --border-color-dark: rgba(57, 255, 20, 0.4);
            --text-color-light: #E0E0E0; 
            --text-dim-grey: #777;
            --panel-width-landscape: 300px;
            --panel-height-landscape: 160px;
            --bottom-panel-height-vertical: 200px;
        }
        
        /* --- RESET & BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: #000;
            color: var(--text-color-light);
            overflow: hidden;
            width: 100vw;
            height: 100dvh; /* dvh para mejor soporte m√≥vil */
        }

        #app-ui {
            width: 100%; height: 100%; position: relative; touch-action: none;
            /* Respetar Notch e Islas Din√°micas */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* --- C√ÅMARA Y FILTROS --- */
        #main-view-area {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: 5; background: #000;
        }

        #bg-camera-feed {
            position: absolute; top: 50%; left: 50%;
            min-width: 100%; min-height: 100%; width: auto; height: auto;
            object-fit: cover; transform: translate(-50%, -50%);
            z-index: 1;
            transition: filter 0.3s ease;
        }
        
        /* Filtros CSS */
        body.filter-night #bg-camera-feed {
            filter: grayscale(1) sepia(1) hue-rotate(50deg) contrast(1.5) saturate(3) brightness(1.5);
        }
        body.filter-sls #bg-camera-feed {
            filter: grayscale(1) contrast(1.2) brightness(0.8);
        }
        body.filter-negative #bg-camera-feed {
            filter: invert(1) contrast(1.1);
        }

        #main-filter-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2; pointer-events: none; display: none;
        }
        body.filter-sls #main-filter-canvas { display: block; }

        /* --- ESTILOS APP PRO (Glassmorphism) --- */
        .panel, .panel-section, #panel-cam-stats {
            background: rgba(10, 15, 10, 0.75) !important; 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(57, 255, 20, 0.3) !important;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5) !important;
        }

        /* Botones con efecto de presi√≥n */
        .filter-btn, #knob-scan, #knob-power {
            transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s !important;
            touch-action: manipulation;
        }
        .filter-btn:active, #knob-scan:active, #knob-power:active {
            transform: scale(0.92);
            box-shadow: 0 0 5px var(--neon-green) inset !important;
        }

        /* --- PANELES --- */
        #left-panel, #bottom-panel {
            position: fixed; display: flex; flex-direction: column;
            z-index: 20; pointer-events: none;
            /* Animaci√≥n Burbuja */
            clip-path: circle(0% at 50% 50%);
            transition: clip-path 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        
        body.panels-active #left-panel,
        body.panels-active #bottom-panel {
            clip-path: circle(150% at 50% 50%);
            pointer-events: auto;
        }

        .panel {
            display: flex; flex-direction: column; padding: 8px; 
            flex-grow: 1; gap: 8px; overflow: hidden; position: relative;
        }
        .panel.alert { border-color: var(--alert-red) !important; box-shadow: 0 0 20px var(--alert-red) inset !important; }

        .panel-header-main {
            font-family: 'Orbitron', sans-serif; font-size: 0.9rem; text-align: center;
            color: var(--neon-green); text-shadow: 0 0 8px var(--neon-green);
            border-bottom: 1px solid var(--border-color-dark); padding: 6px 0;
            background: rgba(57, 255, 20, 0.08); letter-spacing: 2px;
        }
        
        .section-title {
            font-family: 'Orbitron', sans-serif; font-size: 0.7rem;
            color: var(--sim-orange); text-transform: uppercase; margin-bottom: 5px; 
            text-align: center; letter-spacing: 1.5px; font-weight: 700;
            background: rgba(57, 255, 20, 0.1) !important; padding: 4px !important; border-radius: 4px;
        }
        
        .panel-section {
            display: flex; flex-direction: column; padding: 8px; flex-shrink: 0;
            border-radius: 8px;
        }

        /* --- COMPONENTES UI --- */
        .sensor-status-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: center; }
        .status-light-group { display: flex; flex-direction: column; align-items: center; font-size: 0.65rem; }
        .status-light-group .emoji { font-size: 1.4rem; margin-bottom: 2px; }
        .status-led-indicator { width: 12px; height: 12px; border-radius: 50%; background-color: #222; border: 1px solid #444; margin-bottom: 6px; transition: all 0.3s; }
        
        /* Colores de estado */
        .status-light-group[data-status="connected"] .status-led-indicator { background-color: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); animation: pulseGlow 1.5s infinite; }
        .status-light-group[data-status="fallback"] .status-led-indicator { background-color: var(--sensor-blue); box-shadow: 0 0 10px var(--sensor-blue); }
        .status-light-group[data-status="simulated"] .status-led-indicator { background-color: var(--sim-orange); box-shadow: 0 0 10px var(--sim-orange); }
        .status-light-group[data-status="unavailable"] .status-led-indicator { background-color: var(--alert-red); box-shadow: 0 0 10px var(--alert-red); }

        /* Spirit Box UI */
        .spirit-box-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: center; }
        
        #knob-scan, #knob-power {
            width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--border-color-dark);
            position: relative; cursor: pointer; background: #111;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Orbitron', sans-serif; font-size: 0.8rem; color: var(--text-dim-grey);
            box-shadow: 0 4px 6px #000, 0 0 8px rgba(57, 255, 20, 0.3) inset;
        }
        
        #knob-scan::before { content: "SCAN"; }
        #knob-scan.speed-1 { border-color: var(--sensor-blue); color: var(--sensor-blue); box-shadow: 0 0 15px var(--sensor-blue) inset; }
        #knob-scan.speed-2 { border-color: var(--sim-orange); color: var(--sim-orange); box-shadow: 0 0 15px var(--sim-orange) inset; }
        #knob-scan.speed-3 { border-color: var(--alert-red); color: var(--alert-red); box-shadow: 0 0 15px var(--alert-red) inset; }

        #knob-power::before { content: "REC"; color: var(--alert-red); }
        #knob-power.active { border-color: var(--alert-red); background: #330000; box-shadow: 0 0 20px var(--alert-red) inset; }
        #knob-power.active::before { text-shadow: 0 0 10px var(--alert-red); animation: pulseRec 1.5s infinite; }

        .volume-control-group { display: flex; align-items: center; gap: 10px; width: 100%; grid-column: 1 / -1; margin-top: 10px; }
        input[type=range] { flex-grow: 1; -webkit-appearance: none; height: 6px; background: #333; border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--neon-green); border-radius: 50%; box-shadow: 0 0 10px var(--neon-green); }

        /* Diales y Medidores */
        .dials-grid { display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 12px; align-items: center; justify-items: center; }
        .dial-container { position: relative; width: 75px; height: 75px; background: #000; border-radius: 50%; border: 2px solid var(--border-color-dark); overflow: hidden; }
        .dial-needle { width: 3px; height: 40%; position: absolute; bottom: 50%; left: 50%; transform-origin: bottom center; transition: transform 0.5s; z-index: 10; }
        
        #compass-needle { background: var(--neon-green); box-shadow: 0 0 8px var(--neon-green); }
        #main-needle { background: var(--alert-red); box-shadow: 0 0 8px var(--alert-red); transform: rotate(-60deg); }

        #temp-val { font-size: 1.6rem; font-family: 'Orbitron', sans-serif; color: var(--neon-green); text-align: center; }
        
        #vu-meter-container { width: 100%; height: 45px; background: #000; border: 1px solid var(--border-color-dark); padding: 4px; }
        #vu-meter-canvas { width: 100%; height: 100%; }

        /* --- CONTROLES FLOTANTES (Mejorados) --- */
        #filter-controls-container {
            position: fixed; top: 50%; right: 15px; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 15px; z-index: 100;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            padding: 10px; border-radius: 30px;
            border: 1px solid rgba(57, 255, 20, 0.3);
            transition: opacity 0.3s;
        }
        
        .filter-btn {
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(0, 50, 50, 0.7); border: 2px solid var(--neon-green);
            color: var(--neon-green); font-family: 'Share Tech Mono', monospace;
            font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.3);
        }
        .filter-btn.active { background: var(--neon-green); color: #000; box-shadow: 0 0 20px var(--neon-green); }

        /* --- LOADING SCREEN (Estilo Glitch) --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a201a 0%, #000000 100%);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            transition: opacity 0.5s ease-out;
        }
        #loading-text {
            font-family: 'Orbitron', sans-serif; font-size: 1.5rem; letter-spacing: 3px;
            color: var(--neon-green); animation: textGlitch 3s infinite alternate;
        }
        @keyframes textGlitch {
            0% { text-shadow: 2px 0 red, -2px 0 blue; opacity: 1; }
            95% { text-shadow: 4px 0 red, -4px 0 blue; opacity: 0.8; transform: skewX(10deg); }
            100% { text-shadow: 0 0 0; opacity: 1; transform: skewX(0); }
        }

        /* --- RESPONSIVE --- */
        @media (max-aspect-ratio: 1/1) { /* Vertical */
            #left-panel { top: 0; left: 0; width: 100vw; height: calc(100vh - var(--bottom-panel-height-vertical)); clip-path: circle(0% at 50% 0%); }
            body.panels-active #left-panel { clip-path: circle(150% at 50% 0%); }
            
            #bottom-panel { bottom: 0; left: 0; width: 100vw; height: var(--bottom-panel-height-vertical); clip-path: circle(0% at 50% 100%); padding-bottom: env(safe-area-inset-bottom); }
            body.panels-active #bottom-panel { clip-path: circle(150% at 50% 100%); }
            
            #bottom-panel .panel { flex-direction: row; }
            #bottom-panel .dials-grid { grid-template-columns: 1fr 1fr; }
            #detector-dial-container { grid-column: span 1; width: 80px; height: 80px; }
            #temp-readout { display: none; } /* Ocultar temp en vertical si falta espacio */
            #panel-cam-stats { display: none; }

            /* Ocultar vista principal al abrir paneles en vertical */
            body.panels-active #main-view-area { opacity: 0.1; pointer-events: none; }
            body.panels-active #filter-controls-container { display: none; }
        }

        @media (min-aspect-ratio: 1/1) { /* Horizontal */
            #left-panel { width: var(--panel-width-landscape); height: 100vh; top: 0; left: 0; clip-path: circle(0% at 0% 50%); }
            body.panels-active #left-panel { clip-path: circle(150% at 0% 50%); }
            
            #bottom-panel { width: calc(100% - var(--panel-width-landscape)); height: var(--panel-height-landscape); bottom: 0; left: var(--panel-width-landscape); clip-path: circle(0% at 50% 100%); }
            body.panels-active #bottom-panel { clip-path: circle(150% at 50% 100%); }
            
            #bottom-panel .panel { flex-direction: row; }
            body.panels-active #main-view-area { left: var(--panel-width-landscape); width: calc(100% - var(--panel-width-landscape)); height: calc(100% - var(--panel-height-landscape)); }
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="app-ui"> 

    <div id="loading-overlay">
        <div id="loading-content">
            <div id="loading-text">DETECTOR OBR</div>
            <div id="loading-bar-container" style="width: 200px; height: 4px; background: #333; margin-top: 20px; border-radius: 2px;">
                <div id="loading-bar" style="width: 0%; height: 100%; background: var(--neon-green); transition: width 0.3s;"></div>
            </div>
        </div>
    </div>

    <div id="main-view-area" onclick="handleUITap(event)">
        <video id="bg-camera-feed" playsinline autoplay muted></video>
        <canvas id="main-filter-canvas"></canvas>
    </div>
    
    <canvas id="ai-canvas" class="hidden"></canvas>
    
    <div id="left-panel">
        <div class="panel">
            <div class="panel-header-main">PANEL DE MANDO</div>
            
            <div class="panel-section">
                <div class="section-title">Estado de Sensores</div>
                <div class="sensor-status-grid">
                    <div class="status-light-group" id="mic-status" data-status="off">
                        <div class="status-led-indicator"></div>
                        <div class="emoji">üéôÔ∏è</div>
                        <span>MIC</span>
                    </div>
                    <div class="status-light-group" id="mag-status" data-status="off">
                        <div class="status-led-indicator"></div>
                        <div class="emoji">üß≠</div>
                        <span>MAG</span>
                    </div>
                    <div class="status-light-group" id="prox-status" data-status="off">
                        <div class="status-led-indicator"></div>
                        <div class="emoji">‚ö°</div>
                        <span>EMF</span>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <div class="section-title">Spirit Box</div>
                <div class="spirit-box-grid">
                    <div style="display: flex; flex-direction:column; align-items: center;">
                        <div id="knob-power"></div>
                        <div style="font-size: 0.6rem; color: #777; margin-top: 5px;">ENCENDER</div>
                    </div>

                    <div style="display: flex; flex-direction:column; align-items: center;">
                        <div id="knob-scan"></div>
                        <div style="font-size: 0.6rem; color: #777; margin-top: 5px;">FRECUENCIA</div>
                    </div>
                    
                    <div class="volume-control-group">
                        <span style="font-size: 0.7rem;">VOL</span>
                        <input type="range" min="0" max="100" value="80" id="vol-slider">
                        <span id="vol-percent" style="font-size: 0.7rem; width: 30px; text-align: right; color: var(--neon-green);">80%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="bottom-panel">
        <div class="panel">
            <div class="panel-section">
                <div class="section-title">Lecturas de Campo</div>
                <div class="dials-grid">
                    <div id="mag-dial-container" class="dial-container">
                        <div id="compass-needle" class="dial-needle"></div>
                        <div style="position:absolute; bottom: 5px; width: 100%; text-align: center; font-size: 0.5rem; color: #777;">MAG</div>
                    </div>
                    <div id="detector-dial-container" class="dial-container">
                        <div id="main-needle" class="dial-needle"></div>
                        <div style="position:absolute; bottom: 5px; width: 100%; text-align: center; font-size: 0.5rem; color: #777;">DET</div>
                    </div>
                    <div id="temp-readout">
                        <div id="temp-val">--.-¬∞C</div>
                        <div style="font-size: 0.6rem; text-align:center; color: #777;">AMB</div>
                    </div>
                </div>
            </div>
            
            <div class="panel-section" style="flex-grow: 1.5;">
                <div class="section-title">Audio (VU)</div>
                <div id="vu-meter-container">
                    <canvas id="vu-meter-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="filter-controls-container">
        <button class="filter-btn" onclick="setFilter('night')">NV</button>
        <button class="filter-btn" onclick="setFilter('sls')">SLS</button>
        <button class="filter-btn" onclick="setFilter('negative')">NEG</button>
        <button class="filter-btn" id="btn-panel" onclick="togglePanels()">PAN</button>
    </div>

</div> 

<script>
    /* --- L√ìGICA PRINCIPAL --- */
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzOf3crQxBdPylwMTAd34W-nBShN31MkIUtaMdKsZHMZVVniI2HjMesD6DpOlO363T1/exec";
    
    let videoTrack;
    let isRunning = false;
    let currentFilter = 'none';
    let scanSpeed = 1; 
    const videoBg = document.getElementById('bg-camera-feed');
    const mainFilterCanvas = document.getElementById('main-filter-canvas');
    const mainFilterCtx = mainFilterCanvas.getContext('2d');
    
    // Audio Contexts
    let audioCtx, masterGain, micStreamSource;
    let vuAnalyserNode, vuDataArray, vuCanvas, vuCtx;
    let audioSource_Fondo1, gain_Fondo1, audioBuffer_Fondo1;
    let audioSource_Fondo2, gain_Fondo2, audioBuffer_Fondo2;
    
    let recognition;
    let programadoData = new Map();
    let automaticoData = [];
    let scanTimer = null;
    let spiritBoxState = "OFF";
    let spiritBoxTimeout = null;
    
    // Sensores
    let magnetometer, proximitySensor, orientationSensor;
    let emfValue = 0;
    let currentTemp = 19.8;
    let visualLoopInterval;

    // IA Pose
    let poseDetector, latestPoses = [], isDetectingPose = false;

    /* --- FUNCI√ìN H√ÅPTICA (Vibraci√≥n) --- */
    function vibrar(tipo) {
        if (!window.navigator.vibrate) return;
        try {
            switch(tipo) {
                case 'click': navigator.vibrate(15); break;
                case 'success': navigator.vibrate([10, 30, 10]); break;
                case 'alert': navigator.vibrate([50, 50, 50]); break;
                default: navigator.vibrate(15);
            }
        } catch(e){}
    }

    /* --- INICIO C√ÅMARA --- */
    async function startCamera() {
        try {
            const constraints = {
                video: {
                    facingMode: { ideal: "environment" }, 
                    width: { ideal: 1920 }, height: { ideal: 1080 },
                    frameRate: { ideal: 30 }
                },
                audio: false
            };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            videoTrack = stream.getVideoTracks()[0];
            
            // Intentar enfoque continuo
            if (videoTrack && typeof videoTrack.applyConstraints === 'function') {
                videoTrack.applyConstraints({ advanced: [{ focusMode: 'continuous' }] }).catch(e=>{});
            }
            
            videoBg.srcObject = stream;
            videoBg.onloadedmetadata = () => {
                resizeAllCanvas();
                drawLoop();
            };
        } catch (e) { console.log("Error c√°mara", e); }
    }

    /* --- CONTROL DE LINTERNA (Auxiliar) --- */
    async function controlTorch(state) {
        if (!videoTrack) return;
        try {
            const capabilities = videoTrack.getCapabilities();
            if (capabilities.torch) {
                await videoTrack.applyConstraints({ advanced: [{ torch: state }] });
            }
        } catch (e) { console.warn("No se pudo controlar la linterna", e); }
    }

    /* --- SISTEMA DE FILTROS (MODIFICADO) --- */
    function setFilter(f) {
        vibrar('click');
        
        // Limpiar estados anteriores
        document.querySelectorAll('.filter-btn').forEach(b => { if(b.id !== 'btn-panel') b.classList.remove('active'); });
        document.body.classList.remove('filter-night', 'filter-sls', 'filter-negative');
        mainFilterCanvas.style.display = 'none';

        // Si tocamos el mismo filtro, lo desactivamos
        if (currentFilter === f) {
            currentFilter = 'none';
            controlTorch(false); // Apagar linterna al salir
        } else {
            currentFilter = f;
            const targetBtn = event.target;
            if(targetBtn) targetBtn.classList.add('active');
            
            document.body.classList.add('filter-' + f);
            
            // L√≥gica Espec√≠fica
            if (f === 'sls') {
                mainFilterCanvas.style.display = 'block';
                controlTorch(false); // Asegurar apagado en SLS
            } else if (f === 'night') {
                // Visi√≥n Nocturna: Activar Linterna
                controlTorch(true);
            } else {
                controlTorch(false);
            }
        }
    }

    /* --- UI & EVENTOS --- */
    function togglePanels() {
        vibrar('click');
        document.body.classList.toggle('panels-active');
        document.getElementById('btn-panel').classList.toggle('active', document.body.classList.contains('panels-active'));
        
        if (document.body.classList.contains('panels-active')) {
            setTimeout(resizeAllCanvas, 500);
        }
    }

    function handleUITap(event) {
        if (!event.target.closest('.panel') && !event.target.closest('.filter-btn')) {
            const controls = document.getElementById('filter-controls-container');
            controls.style.opacity = controls.style.opacity === '0' ? '1' : '0';
            controls.style.pointerEvents = controls.style.opacity === '0' ? 'none' : 'auto';
        }
    }

    /* --- SPIRIT BOX (Resumido) --- */
    document.getElementById('knob-power').addEventListener('click', async function() {
        if (!audioCtx) await initAudio();
        
        isRunning = !this.classList.contains('active');
        this.classList.toggle('active', isRunning);
        
        if(isRunning) {
            vibrar('success');
            if(audioCtx.state === 'suspended') audioCtx.resume();
            playFondo1();
            spiritBoxState = "SCANNING";
            playFondo2_Fragment();
            runSpiritBoxLoop();
        } else {
            vibrar('click');
            spiritBoxState = "OFF";
            if(audioSource_Fondo1) try{audioSource_Fondo1.stop()}catch(e){}
            if(scanTimer) clearTimeout(scanTimer);
            if(recognition) recognition.abort();
        }
    });

    document.getElementById('knob-scan').addEventListener('click', function() {
        vibrar('click');
        scanSpeed = (scanSpeed + 1) % 3;
        this.className = ''; // reset classes
        if(scanSpeed === 0) this.classList.add('speed-1');
        else if(scanSpeed === 1) this.classList.add('speed-2');
        else this.classList.add('speed-3');
    });

    /* --- INICIALIZACI√ìN --- */
    window.onload = async () => {
        updateLoading(10, "INICIANDO C√ÅMARA");
        await startCamera();
        
        updateLoading(30, "CARGANDO IA");
        await initMLModel();
        detectPoseLoop();
        
        updateLoading(60, "CONECTANDO SENSORES");
        requestSensorPermissions();
        startVisualLoop();
        setInterval(updateTemp, 2000);
        
        updateLoading(80, "SINCRONIZANDO DATOS");
        loadSheetData(); // Esta funci√≥n termina cerrando el loading
        
        document.getElementById('knob-scan').classList.add('speed-2');
    };

    function updateLoading(percent, text) {
        document.getElementById('loading-bar').style.width = percent + '%';
        document.getElementById('loading-text').innerText = text;
        if(percent >= 100) {
            setTimeout(() => { document.getElementById('loading-overlay').style.opacity = '0'; }, 500);
            setTimeout(() => { document.getElementById('loading-overlay').style.display = 'none'; }, 1000);
        }
    }

    /* --- FUNCIONES DE APOYO (Simplificadas para caber) --- */
    function resizeAllCanvas() {
        const w = document.getElementById('main-view-area').clientWidth;
        const h = document.getElementById('main-view-area').clientHeight;
        mainFilterCanvas.width = w; mainFilterCanvas.height = h;
        
        const vuContainer = document.getElementById('vu-meter-container');
        if(vuContainer) {
            vuCanvas = document.getElementById('vu-meter-canvas');
            vuCanvas.width = vuContainer.clientWidth; vuCanvas.height = vuContainer.clientHeight;
            vuCtx = vuCanvas.getContext('2d');
        }
    }

    async function initMLModel() {
        try {
            const model = poseDetection.SupportedModels.MoveNet;
            poseDetector = await poseDetection.createDetector(model, {modelType: poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING});
        } catch(e){ console.log("IA Error", e); }
    }

    function requestSensorPermissions() {
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission().then(res => {
                if(res==='granted') initSensors();
                else startSimulatedSensors();
            }).catch(() => startSimulatedSensors());
        } else { initSensors(); }
    }

    function initSensors() {
        try {
            orientationSensor = new AbsoluteOrientationSensor({ frequency: 10 });
            orientationSensor.onreading = () => {
                let q = orientationSensor.quaternion;
                let yaw = Math.atan2(2 * (q[0] * q[1] + q[2] * q[3]), 1 - 2 * (q[1] * q[1] + q[2] * q[2])) * (180 / Math.PI);
                document.getElementById('compass-needle').style.transform = `translateX(-50%) rotate(${-yaw}deg)`;
                document.getElementById('mag-status').dataset.status = 'connected';
            };
            orientationSensor.start();
        } catch(e) { document.getElementById('mag-status').dataset.status = 'unavailable'; }

        try {
            // Simulaci√≥n de EMF usando magnet√≥metro raw si existe
            magnetometer = new Magnetometer({ frequency: 10 });
            magnetometer.onreading = () => {
                let str = Math.sqrt(magnetometer.x**2 + magnetometer.y**2 + magnetometer.z**2);
                emfValue = Math.min(100, (str/100)*100);
                document.getElementById('prox-status').dataset.status = 'connected';
            };
            magnetometer.start();
        } catch(e) {
             startEmfSimulation(); 
             document.getElementById('prox-status').dataset.status = 'simulated';
        }
    }
    
    function startSimulatedSensors() {
        document.getElementById('mag-status').dataset.status = 'unavailable';
        document.getElementById('prox-status').dataset.status = 'simulated';
        startEmfSimulation();
    }
    
    function startEmfSimulation() {
        setInterval(() => { emfValue = Math.random() * 20; }, 200);
    }
    
    function startVisualLoop() {
        setInterval(() => {
            const needle = document.getElementById('main-needle');
            if(needle) needle.style.transform = `translateX(-50%) rotate(${-60 + (emfValue/100)*120}deg)`;
        }, 100);
    }
    
    function updateTemp() {
        if (!isRunning) {
            currentTemp += (Math.random()*0.2 - 0.1);
            document.getElementById('temp-val').innerText = currentTemp.toFixed(1)+"¬∞C";
        }
    }

    /* --- AUDIO ENGINE (Carga de archivos y mic) --- */
    async function initAudio() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = audioCtx.createGain(); masterGain.connect(audioCtx.destination);
        
        // Cargar Audios (Debes tener FONDO_1.mp3 y FONDO_2.mp3 en la misma carpeta)
        try {
            const b1 = await fetch('FONDO_1.mp3').then(r=>r.arrayBuffer());
            audioBuffer_Fondo1 = await audioCtx.decodeAudioData(b1);
            const b2 = await fetch('FONDO_2.mp3').then(r=>r.arrayBuffer());
            audioBuffer_Fondo2 = await audioCtx.decodeAudioData(b2);
            
            gain_Fondo1 = audioCtx.createGain(); gain_Fondo1.connect(masterGain); gain_Fondo1.gain.value = 0;
            gain_Fondo2 = audioCtx.createGain(); gain_Fondo2.connect(masterGain); gain_Fondo2.gain.value = 0;
        } catch(e) { console.log("Falta audio mp3"); }

        // Micr√≥fono
        try {
            const stream = await navigator.mediaDevices.getUserMedia({audio:true});
            micStreamSource = audioCtx.createMediaStreamSource(stream);
            vuAnalyserNode = audioCtx.createAnalyser(); vuAnalyserNode.fftSize = 256;
            micStreamSource.connect(vuAnalyserNode);
            vuDataArray = new Uint8Array(vuAnalyserNode.frequencyBinCount);
            drawVUMeter();
            document.getElementById('mic-status').dataset.status = 'connected';
            
            // Speech Rec
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'es-MX'; recognition.continuous = false;
                recognition.onresult = (e) => {
                    let t = e.results[0][0].transcript.toLowerCase();
                    console.log("Voz:", t);
                    // L√≥gica simple de respuesta
                    if(programadoData.has(t)) speak(programadoData.get(t));
                    else if(automaticoData.length) speak(automaticoData[Math.floor(Math.random()*automaticoData.length)]);
                };
                recognition.onend = () => { if(spiritBoxState === "LISTENING") recognition.start(); };
            }
        } catch(e) { document.getElementById('mic-status').dataset.status = 'unavailable'; }
    }

    function playFondo1() {
        if(!audioBuffer_Fondo1) return;
        audioSource_Fondo1 = audioCtx.createBufferSource();
        audioSource_Fondo1.buffer = audioBuffer_Fondo1; audioSource_Fondo1.loop = true;
        audioSource_Fondo1.connect(gain_Fondo1); audioSource_Fondo1.start();
        gain_Fondo1.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 1);
    }

    function playFondo2_Fragment() {
        if(!isRunning || !audioBuffer_Fondo2) return;
        audioSource_Fondo2 = audioCtx.createBufferSource();
        audioSource_Fondo2.buffer = audioBuffer_Fondo2;
        audioSource_Fondo2.connect(gain_Fondo2);
        const dur = 0.5 + Math.random();
        audioSource_Fondo2.start(0, Math.random()*(audioBuffer_Fondo2.duration-2), dur);
        gain_Fondo2.gain.value = 0.8;
        
        const delays = [1500, 700, 200];
        scanTimer = setTimeout(playFondo2_Fragment, dur*1000 + delays[scanSpeed]);
    }

    function runSpiritBoxLoop() {
        if(!isRunning) return;
        // L√≥gica simplificada: cada 5-8s intenta escuchar
        spiritBoxTimeout = setTimeout(() => {
            if(!isRunning) return;
            spiritBoxState = "LISTENING";
            gain_Fondo2.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime); // Bajar ruido
            try { recognition.start(); } catch(e){}
            
            setTimeout(() => {
                if(!isRunning) return;
                spiritBoxState = "SCANNING";
                gain_Fondo2.gain.linearRampToValueAtTime(0.8, audioCtx.currentTime);
                try { recognition.stop(); } catch(e){}
                runSpiritBoxLoop();
            }, 4000);
        }, 5000 + Math.random()*3000);
    }

    function speak(text) {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'es-MX'; u.rate = 0.8; u.pitch = 0.2;
        window.speechSynthesis.speak(u);
    }

    async function loadSheetData() {
        try {
            const res = await fetch(GOOGLE_SCRIPT_URL).then(r=>r.json());
            automaticoData = res.automatico.map(r=>r.TEXTO);
            res.programado.forEach(r => programadoData.set(r.PREGUNTA.toLowerCase(), r.RESPUESTA));
            updateLoading(100, "LISTO");
        } catch(e) { updateLoading(100, "OFFLINE MODE"); }
    }

    function drawVUMeter() {
        if(!vuCtx) return requestAnimationFrame(drawVUMeter);
        vuAnalyserNode.getByteTimeDomainData(vuDataArray);
        let sum = 0; for(let i=0; i<vuDataArray.length; i++) sum += Math.pow((vuDataArray[i]/128.0)-1, 2);
        let rms = Math.sqrt(sum/vuDataArray.length);
        let vol = Math.min(100, rms*1000); // escala simple
        
        let w = vuCanvas.width, h = vuCanvas.height;
        vuCtx.fillStyle = '#000'; vuCtx.fillRect(0,0,w,h);
        
        let bars = 20, barW = w/bars;
        for(let i=0; i<bars; i++) {
            let barH = (i/bars) * vol * (h/50);
            vuCtx.fillStyle = i > 15 ? 'red' : (i > 10 ? 'orange' : 'lime');
            if(barH > 5) vuCtx.fillRect(i*barW, h-barH, barW-2, barH);
        }
        requestAnimationFrame(drawVUMeter);
    }

    /* --- LOOP DE DIBUJO (SLS) --- */
    async function drawLoop() {
        if (videoBg.readyState >= 2 && currentFilter === 'sls' && latestPoses.length) {
            mainFilterCtx.clearRect(0, 0, mainFilterCanvas.width, mainFilterCanvas.height);
            // Dibujo de esqueleto (Simplificado)
            mainFilterCtx.strokeStyle = '#39FF14'; mainFilterCtx.lineWidth = 4;
            latestPoses.forEach(pose => {
                 pose.keypoints.forEach(kp => {
                     if(kp.score > 0.3) {
                         mainFilterCtx.beginPath(); mainFilterCtx.arc(kp.x, kp.y, 4, 0, 2*Math.PI); mainFilterCtx.stroke();
                     }
                 });
            });
        } else {
            mainFilterCtx.clearRect(0, 0, mainFilterCanvas.width, mainFilterCanvas.height);
        }
        requestAnimationFrame(drawLoop);
    }

    async function detectPoseLoop() {
        while(true) {
            if(currentFilter === 'sls' && poseDetector && videoBg.readyState >= 2) {
                try { latestPoses = await poseDetector.estimatePoses(videoBg); } catch(e){}
            }
            await new Promise(r => setTimeout(r, 100));
        }
    }
</script>
</body>
</html>
