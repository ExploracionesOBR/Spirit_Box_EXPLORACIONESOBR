<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>DETECTOR OBR PRO</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@500;700&family=Creepster&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <style>
        :root {
            --neon-green: #39FF14;
            --alert-red: #FF3333;
            --sim-orange: #FFB000;
            --sensor-blue: #00BFFF; 
            --panel-bg-dark: rgba(5, 10, 5, 0.95);
            --border-color-dark: rgba(57, 255, 20, 0.4);
            --panel-width-landscape: 300px;
            --bottom-panel-height-vertical: 180px;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: #000; color: #E0E0E0;
            overflow: hidden; width: 100vw; height: 100dvh;
        }

        /* --- PANTALLA DE CARGA (RESTAURADA) --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease-out;
        }
        #loading-logo { width: 100px; height: 100px; margin-bottom: 20px; filter: drop-shadow(0 0 10px var(--neon-green)); animation: pulse 2s infinite; }
        #loading-text {
            font-family: 'Orbitron', sans-serif; font-size: 1rem; color: var(--neon-green);
            letter-spacing: 2px; margin-bottom: 10px; text-shadow: 0 0 5px var(--neon-green);
        }
        #loading-bar-container {
            width: 80%; max-width: 300px; height: 4px; background: #222; border-radius: 2px; overflow: hidden;
        }
        #loading-bar {
            width: 0%; height: 100%; background: var(--neon-green);
            transition: width 0.3s ease-out; box-shadow: 0 0 10px var(--neon-green);
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* --- CÁMARA Y VISUALIZACIÓN --- */
        #main-view-area {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: 1; background: #000;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #bg-camera-feed {
            position: absolute; top: 50%; left: 50%;
            min-width: 100%; min-height: 100%; width: auto; height: auto;
            object-fit: cover; transform: translate(-50%, -50%);
            z-index: 1;
        }
        
        /* Filtros */
        body.filter-night #bg-camera-feed { filter: grayscale(1) sepia(1) hue-rotate(50deg) contrast(1.2) brightness(1.3); }
        body.filter-negative #bg-camera-feed { filter: invert(1) contrast(1.2); }
        
        #main-filter-canvas { /* SLS Canvas */
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 3; pointer-events: none; display: none;
        }
        body.filter-sls #main-filter-canvas { display: block; }

        /* --- LOGO FLOTANTE --- */
        #logo-image {
            position: fixed; top: 20px; right: 20px; width: 70px; height: 70px;
            z-index: 50; pointer-events: none;
            transition: all 0.5s ease; filter: drop-shadow(0 0 5px var(--neon-green));
        }
        #logo-image.hiding { transform: scale(0) rotate(180deg); opacity: 0; }

        /* --- SOCIAL OVERLAY (DENTRO DE CÁMARA) --- */
        #social-overlay {
            position: absolute; 
            bottom: 30px; 
            left: 50%; 
            transform: translateX(-50%); /* Centrado perfecto relativo a la cámara */
            z-index: 40; pointer-events: none; text-align: center; width: 100%;
            opacity: 0; transition: opacity 0.5s;
        }
        #social-overlay.visible { opacity: 1; animation: glitch-anim 0.3s infinite; }
        
        .social-title {
            font-family: 'Creepster', cursive; color: #FF0000; font-size: 1.4rem;
            text-shadow: 2px 0 #000; margin-bottom: 5px; letter-spacing: 2px;
        }
        .social-icons { display: flex; gap: 15px; justify-content: center; margin-bottom: 5px; }
        .social-icon-svg { width: 24px; height: 24px; fill: #fff; filter: drop-shadow(0 0 5px red); }
        .social-handle { font-family: 'Orbitron', sans-serif; color: #fff; font-size: 0.9rem; text-shadow: 0 0 10px red; }

        @keyframes glitch-anim {
            0% { transform: translateX(-50%) skewX(0deg); }
            20% { transform: translateX(-51%) skewX(-10deg); }
            40% { transform: translateX(-49%) skewX(10deg); }
            60% { transform: translateX(-50%) skewX(0deg); }
            80% { transform: translateX(-50%) skewX(5deg); filter: hue-rotate(90deg); }
            100% { transform: translateX(-50%) skewX(0deg); }
        }

        /* --- CONTROLES FLOTANTES --- */
        #filter-controls-container {
            position: absolute; top: 50%; right: 10px; transform: translateY(-50%) scale(0);
            display: flex; flex-direction: column; gap: 12px; z-index: 45;
            padding: 8px; opacity: 0; pointer-events: none;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #filter-controls-container.visible { opacity: 1; pointer-events: auto; transform: translateY(-50%) scale(1); }
        
        .filter-btn {
            width: 45px; height: 45px; border-radius: 50%;
            background: rgba(0, 20, 0, 0.6); border: 1px solid var(--neon-green);
            color: var(--neon-green); font-family: 'Share Tech Mono', monospace; font-size: 0.7rem;
            font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 5px rgba(57, 255, 20, 0.3); backdrop-filter: blur(4px);
        }
        .filter-btn:active, .filter-btn.active { background: var(--neon-green); color: #000; box-shadow: 0 0 15px var(--neon-green); }

        /* --- PANELES UI --- */
        .panel {
            background: var(--panel-bg-dark) !important; 
            border-right: 1px solid var(--border-color-dark);
            border-top: 1px solid var(--border-color-dark);
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            position: relative; overflow: hidden;
        }
        
        #matrix-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; opacity: 0.15; pointer-events: none;
        }

        #left-panel {
            position: fixed; top: 0; left: 0; height: 100%; width: var(--panel-width-landscape);
            display: flex; flex-direction: column; z-index: 20; 
            transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #bottom-panel {
            position: fixed; bottom: 0; left: var(--panel-width-landscape); right: 0; height: 130px;
            display: flex; z-index: 20;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ESTADOS ACTIVOS */
        body.panels-active #left-panel { transform: translateX(0); }
        body.panels-active #bottom-panel { transform: translateY(0); }

        .panel-content { position: relative; z-index: 1; padding: 10px; display: flex; flex-direction: column; gap: 10px; height: 100%; overflow-y: auto; }
        
        .section-title {
            font-family: 'Orbitron', sans-serif; font-size: 0.65rem; color: var(--sim-orange);
            text-transform: uppercase; font-weight: 700; letter-spacing: 1px;
            border-bottom: 1px dashed rgba(57,255,20,0.3); margin-bottom: 5px; padding-bottom: 2px;
        }

        /* Componentes Internos */
        .sensor-row { display: flex; justify-content: space-around; margin-bottom: 5px; }
        .status-item { display: flex; flex-direction: column; align-items: center; font-size: 0.6rem; color: #777; }
        .led { width: 8px; height: 8px; border-radius: 50%; background: #333; margin-bottom: 4px; border: 1px solid #555; }
        .led.on { background: var(--neon-green); box-shadow: 0 0 8px var(--neon-green); }

        .spirit-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: center; }
        .knob-wrapper { display: flex; flex-direction: column; align-items: center; }
        
        #knob-power, #knob-scan {
            width: 55px; height: 55px; border-radius: 50%; border: 2px solid #333;
            background: radial-gradient(circle, #222 30%, #000 100%);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            font-family: 'Orbitron'; font-size: 0.7rem; color: #555;
            box-shadow: 0 2px 5px #000; transition: all 0.2s;
        }
        #knob-power.active { border-color: var(--alert-red); color: var(--alert-red); text-shadow: 0 0 5px var(--alert-red); background: radial-gradient(circle, #410000 30%, #1a0000 100%); }
        #knob-scan.active { border-color: var(--sim-orange); color: var(--sim-orange); }

        .vol-wrapper { grid-column: 1 / -1; display: flex; align-items: center; gap: 8px; margin-top: 5px; }
        input[type=range] { flex: 1; height: 4px; background: #333; -webkit-appearance: none; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: var(--neon-green); border-radius: 50%; box-shadow: 0 0 5px var(--neon-green); }

        #vu-container { width: 100%; height: 30px; background: #000; border: 1px solid #333; margin-top: 2px; }
        #vu-canvas { width: 100%; height: 100%; }

        #bottom-content { display: flex; width: 100%; height: 100%; align-items: center; justify-content: space-around; padding: 0 10px; }
        .dial-box { position: relative; width: 70px; height: 70px; border: 1px solid #444; border-radius: 50%; background: #000; }
        .dial-needle { position: absolute; top: 50%; left: 50%; width: 50%; height: 2px; background: red; transform-origin: 0% 50%; transform: rotate(-90deg); transition: transform 0.2s; }
        
        #seismic-container { width: 100px; height: 60px; background: #000; border: 1px solid #333; position: relative; overflow: hidden; }
        #seismic-canvas { width: 100%; height: 100%; }

        /* --- RESPONSIVE (Redimensión Real) --- */
        @media (min-aspect-ratio: 1/1) { /* Horizontal */
            body.panels-active #main-view-area {
                left: var(--panel-width-landscape);
                width: calc(100% - var(--panel-width-landscape));
            }
        }

        @media (max-aspect-ratio: 1/1) { /* Vertical */
            #left-panel { width: 100%; height: auto; bottom: var(--bottom-panel-height-vertical); top: 0; transform: translateY(-100%); border-right: none; border-bottom: 1px solid var(--border-color-dark); }
            #bottom-panel { left: 0; height: var(--bottom-panel-height-vertical); }
            
            body.panels-active #left-panel { transform: translateY(0); }
            
            #bottom-content { display: grid; grid-template-columns: 1fr 1fr; justify-items: center; gap: 10px; }
            #seismic-container { grid-column: span 2; width: 90%; }
        }
    </style>
</head>
<body>

<div id="loading-overlay">
    <img id="loading-logo" src="obr-logo.png" alt="Logo" onerror="this.style.display='none'">
    <div id="loading-text">INICIANDO SISTEMA...</div>
    <div id="loading-bar-container"><div id="loading-bar"></div></div>
</div>

<div id="main-view-area">
    <video id="bg-camera-feed" playsinline autoplay muted></video>
    <canvas id="main-filter-canvas"></canvas> <div id="social-overlay">
        <div class="social-title">SÍGUENOS EN</div>
        <div class="social-icons">
            <svg class="social-icon-svg" viewBox="0 0 24 24"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>
            <svg class="social-icon-svg" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
            <svg class="social-icon-svg" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
        </div>
        <div class="social-handle">@EXPLORACIONESOBR</div>
    </div>

    <div id="filter-controls-container">
        <button class="filter-btn" onclick="setFilter('night')">NV</button>
        <button class="filter-btn" onclick="setFilter('sls')">SLS</button>
        <button class="filter-btn" onclick="setFilter('negative')">NEG</button>
        <button class="filter-btn" id="btn-panel" onclick="togglePanels()">PAN</button>
    </div>
</div>

<img id="logo-image" src="obr-logo.png" alt="Logo">

<div id="left-panel" class="panel">
    <canvas id="matrix-canvas"></canvas>
    <div class="panel-content">
        <div class="section-title">Sensores Activos</div>
        <div class="sensor-row">
            <div class="status-item" id="st-mic"><div class="led"></div>MIC</div>
            <div class="status-item" id="st-mag"><div class="led"></div>MAG</div>
            <div class="status-item" id="st-gyro"><div class="led"></div>GYRO</div>
        </div>

        <div class="section-title">Spirit Box v2.0</div>
        <div class="spirit-controls">
            <div class="knob-wrapper">
                <div id="knob-power">REC</div><span style="font-size:0.6rem; color:#555; margin-top:4px;">POWER</span>
            </div>
            <div class="knob-wrapper">
                <div id="knob-scan" class="speed-1">SCAN</div><span style="font-size:0.6rem; color:#555; margin-top:4px;" id="speed-label">NORMAL</span>
            </div>
            <div class="vol-wrapper">
                <span style="font-size:0.7rem">VOL</span><input type="range" id="vol-slider" min="0" max="100" value="80">
                <span id="vol-text" style="font-size:0.7rem; width:25px; text-align:right; color:var(--neon-green)">80</span>
            </div>
            <div style="grid-column: 1/-1;"><div id="vu-container"><canvas id="vu-canvas"></canvas></div></div>
        </div>
    </div>
</div>

<div id="bottom-panel" class="panel">
    <div id="bottom-content">
        <div class="dial-wrapper" style="text-align:center">
            <div class="dial-box"><div id="compass-arrow" class="dial-needle" style="background:var(--neon-green)"></div></div><span style="font-size:0.6rem; color:#777">MAG</span>
        </div>
        <div style="display:flex; flex-direction:column; align-items:center;">
            <div id="seismic-container"><canvas id="seismic-canvas"></canvas></div><span style="font-size:0.6rem; color:#777">SISMÓGRAFO</span>
        </div>
        <div class="dial-wrapper" style="text-align:center">
            <div class="dial-box"><div id="emf-arrow" class="dial-needle"></div></div><span style="font-size:0.6rem; color:#777">EMF</span>
        </div>
    </div>
</div>

<script>
    /* --- CONFIG --- */
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzOf3crQxBdPylwMTAd34W-nBShN31MkIUtaMdKsZHMZVVniI2HjMesD6DpOlO363T1/exec";
    const SOCIAL_INTERVAL = 15000; 
    
    let isRunning = false;
    let audioCtx, masterGain, noiseGain;
    let programadoData = new Map(), automaticoData = [];
    let uiHideTimeout, currentFilter = 'none';
    let recognition;

    /* --- LOADING SCREEN CONTROL --- */
    function updateLoading(percent, text) {
        const bar = document.getElementById('loading-bar');
        const txt = document.getElementById('loading-text');
        const overlay = document.getElementById('loading-overlay');
        
        if(bar) bar.style.width = percent + '%';
        if(txt) txt.innerText = text;
        
        if(percent >= 100) {
            setTimeout(() => {
                overlay.style.opacity = 0;
                setTimeout(() => overlay.style.display = 'none', 500);
            }, 800);
        }
    }

    /* --- SLS KINECT LOGIC (Fixed) --- */
    let poseDetector, latestPoses = [];
    const skeletonMap = [
        ['left_shoulder', 'right_shoulder'], ['left_shoulder', 'left_elbow'],
        ['left_elbow', 'left_wrist'], ['right_shoulder', 'right_elbow'],
        ['right_elbow', 'right_wrist'], ['left_shoulder', 'left_hip'],
        ['right_shoulder', 'right_hip'], ['left_hip', 'right_hip'],
        ['left_hip', 'left_knee'], ['left_knee', 'left_ankle'],
        ['right_hip', 'right_knee'], ['right_knee', 'right_ankle']
    ];

    async function initMLModel() {
        const model = poseDetection.SupportedModels.MoveNet;
        poseDetector = await poseDetection.createDetector(model, {modelType: poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING});
        detectPoseLoop();
    }

    async function detectPoseLoop() {
        const video = document.getElementById('bg-camera-feed');
        while(true) {
            if(currentFilter === 'sls' && poseDetector && video.readyState >= 2) {
                try { latestPoses = await poseDetector.estimatePoses(video); } catch(e){}
            }
            await new Promise(r => setTimeout(r, 100));
        }
    }

    function drawLoop() {
        const canvas = document.getElementById('main-filter-canvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('bg-camera-feed');
        
        canvas.width = document.getElementById('main-view-area').clientWidth;
        canvas.height = document.getElementById('main-view-area').clientHeight;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (currentFilter === 'sls' && latestPoses.length > 0 && video.readyState >= 2) {
            // Cálculo de escala CORRECTO
            const videoAspect = video.videoWidth / video.videoHeight;
            const canvasAspect = canvas.width / canvas.height;
            let scale, offsetX, offsetY;
            
            if (canvasAspect > videoAspect) {
                scale = canvas.width / video.videoWidth;
                offsetX = 0;
                offsetY = (canvas.height - video.videoHeight * scale) / 2;
            } else {
                scale = canvas.height / video.videoHeight;
                offsetX = (canvas.width - video.videoWidth * scale) / 2;
                offsetY = 0;
            }

            latestPoses.forEach(pose => {
                const keypointMap = new Map();
                pose.keypoints.forEach(kp => keypointMap.set(kp.name, kp));

                ctx.fillStyle = '#FF0000'; // Puntos ROJOS
                pose.keypoints.forEach(kp => {
                    if(kp.score > 0.3) {
                        ctx.beginPath(); ctx.arc(kp.x * scale + offsetX, kp.y * scale + offsetY, 5, 0, 2 * Math.PI); ctx.fill();
                    }
                });

                ctx.strokeStyle = '#39FF14'; // Lineas VERDE NEON
                ctx.lineWidth = 3;
                skeletonMap.forEach(conn => {
                    const p1 = keypointMap.get(conn[0]);
                    const p2 = keypointMap.get(conn[1]);
                    if(p1 && p2 && p1.score > 0.3 && p2.score > 0.3) {
                        ctx.beginPath();
                        ctx.moveTo(p1.x * scale + offsetX, p1.y * scale + offsetY);
                        ctx.lineTo(p2.x * scale + offsetX, p2.y * scale + offsetY);
                        ctx.stroke();
                    }
                });
            });
        }
        requestAnimationFrame(drawLoop);
    }

    window.onload = async () => {
        updateLoading(10, "INICIANDO HARDWARE...");
        await startCamera();
        updateLoading(30, "CARGANDO IA...");
        await initMLModel(); 
        drawLoop(); 
        initMatrixEffect();
        initSeismicGraph();
        startSensors();
        startVisualLoops();
        
        // Carga de datos con actualización de pantalla
        await loadSheetData();
        
        initSocialTimer();
        
        document.getElementById('main-view-area').addEventListener('click', (e) => {
            if(e.target.id !== 'btn-panel') toggleControls(true);
        });
        
        document.getElementById('vol-slider').addEventListener('input', (e) => {
            const val = e.target.value;
            document.getElementById('vol-text').innerText = val;
            if(masterGain) masterGain.gain.value = val / 100;
        });
    };

    /* --- SPIRIT BOX --- */
    async function initAudioAndSpeech() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.8;
        masterGain.connect(audioCtx.destination);
        noiseGain = audioCtx.createGain(); noiseGain.connect(masterGain);
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'es-MX'; recognition.continuous = false; recognition.interimResults = false;
            recognition.onstart = () => document.getElementById('st-mic').querySelector('.led').style.background = 'var(--alert-red)';
            recognition.onend = () => {
                document.getElementById('st-mic').querySelector('.led').style.background = '#333';
                if(isRunning) recognition.start();
            };
            recognition.onresult = (e) => processSpiritBoxResponse(e.results[0][0].transcript.toLowerCase().trim());
        }
        initVUMeter();
    }

    function processSpiritBoxResponse(text) {
        let found = false;
        for (let [key, value] of programadoData) {
            if (text.includes(key)) { speak(value); found = true; break; }
        }
        if (!found && automaticoData.length > 0) {
            speak(automaticoData[Math.floor(Math.random() * automaticoData.length)]);
        }
    }

    document.getElementById('knob-power').addEventListener('click', async function() {
        if (!audioCtx) await initAudioAndSpeech();
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        
        isRunning = !isRunning;
        this.classList.toggle('active', isRunning);
        document.getElementById('st-mic').querySelector('.led').classList.toggle('on', isRunning);
        
        if(isRunning) {
            startWhiteNoise();
            try { recognition.start(); } catch(e){}
            if(navigator.vibrate) navigator.vibrate([10,50,10]);
        } else {
            stopWhiteNoise();
            try { recognition.abort(); } catch(e){}
            window.speechSynthesis.cancel();
            if(navigator.vibrate) navigator.vibrate(20);
        }
    });

    let noiseSource;
    function startWhiteNoise() {
        const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 2, audioCtx.sampleRate);
        const output = buffer.getChannelData(0);
        for (let i = 0; i < output.length; i++) output[i] = Math.random() * 2 - 1;
        noiseSource = audioCtx.createBufferSource();
        noiseSource.buffer = buffer; noiseSource.loop = true;
        noiseSource.connect(noiseGain); noiseGain.gain.value = 0.05;
        noiseSource.start();
    }
    function stopWhiteNoise() { if(noiseSource) { noiseSource.stop(); noiseSource = null; } }
    function speak(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'es-MX'; u.pitch = Math.random()*0.4 + 0.6; u.rate = 0.9;
        window.speechSynthesis.speak(u);
    }

    /* --- UI --- */
    function initMatrixEffect() {
        const cvs = document.getElementById('matrix-canvas');
        const ctx = cvs.getContext('2d');
        let w, h;
        const resize = () => {
            w = cvs.width = document.getElementById('left-panel').clientWidth || 300;
            h = cvs.height = document.getElementById('left-panel').clientHeight || window.innerHeight;
        };
        window.addEventListener('resize', resize); setTimeout(resize, 500);
        const cols = Math.floor(300 / 15) + 1;
        const ypos = Array(cols).fill(0).map(() => Math.random() * 500);

        function matrixDraw() {
            ctx.fillStyle = 'rgba(0, 10, 0, 0.1)'; ctx.fillRect(0, 0, w, h);
            ctx.fillStyle = '#0F0'; ctx.font = '12px monospace';
            ypos.forEach((y, i) => {
                const text = Math.random() > 0.98 && automaticoData.length ? automaticoData[Math.floor(Math.random()*automaticoData.length)].charAt(0) : (Math.random()>0.5?'1':'0');
                const x = i * 15; ctx.fillText(text, x, y);
                ypos[i] = y < 0 ? h : y - (Math.random() * 10 + 5);
            });
            requestAnimationFrame(matrixDraw);
        }
        matrixDraw();
    }

    function initSeismicGraph() {
        const cvs = document.getElementById('seismic-canvas');
        const ctx = cvs.getContext('2d');
        let data = Array(60).fill(30);
        function drawSeismic() {
            const w = cvs.width = cvs.offsetWidth; const h = cvs.height = cvs.offsetHeight;
            data.shift(); let val = h/2;
            if(isRunning) val += (Math.random() * 10 - 5);
            data.push(val);
            ctx.clearRect(0,0,w,h); ctx.beginPath(); ctx.strokeStyle = 'var(--sensor-blue)'; ctx.lineWidth = 1;
            for(let i=0; i<data.length; i++) { const x = (i / data.length) * w; if(i===0) ctx.moveTo(x, data[i]); else ctx.lineTo(x, data[i]); }
            ctx.stroke(); requestAnimationFrame(drawSeismic);
        }
        drawSeismic();
    }

    function toggleControls(show) {
        const ctrls = document.getElementById('filter-controls-container');
        const logo = document.getElementById('logo-image');
        if(show) {
            ctrls.classList.add('visible'); logo.classList.add('hiding');
            clearTimeout(uiHideTimeout); uiHideTimeout = setTimeout(() => toggleControls(false), 2000);
        } else {
            ctrls.classList.remove('visible'); logo.classList.remove('hiding');
        }
    }
    function togglePanels() { document.body.classList.toggle('panels-active'); document.getElementById('btn-panel').classList.toggle('active'); }
    function setFilter(f) {
        document.body.className = document.body.className.replace(/filter-\w+/g, '');
        if(currentFilter !== f) { document.body.classList.add('filter-'+f); currentFilter = f; } else { currentFilter = 'none'; }
        toggleControls(true);
    }
    async function startCamera() { try { const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}); document.getElementById('bg-camera-feed').srcObject = s; }catch(e){} }
    function startSensors() { window.addEventListener('deviceorientation', (e) => { if(e.alpha) document.getElementById('compass-arrow').style.transform = `rotate(${-e.alpha}deg)`; }, true); }
    function initSocialTimer() { setInterval(() => { const el = document.getElementById('social-overlay'); el.classList.add('visible'); setTimeout(() => el.classList.remove('visible'), 4000); }, SOCIAL_INTERVAL); }
    function initVUMeter() {
        const cv = document.getElementById('vu-canvas'); const ctx = cv.getContext('2d');
        const an = audioCtx.createAnalyser(); masterGain.connect(an); an.fftSize=32; const da = new Uint8Array(an.frequencyBinCount);
        function d() {
            if(!cv.offsetParent) return requestAnimationFrame(d);
            const w = cv.width = cv.offsetWidth; const h = cv.height = cv.offsetHeight;
            an.getByteFrequencyData(da);
            const avg = da.reduce((a,b)=>a+b,0)/da.length;
            const bars=15, barW=(w/bars)-1, act=Math.floor((avg/255)*bars*1.5);
            ctx.clearRect(0,0,w,h);
            for(let i=0;i<bars;i++) { ctx.fillStyle=i<act?(i>10?'#F00':(i>6?'#FC0':'#0F0')):'#222'; ctx.fillRect(i*(barW+1),2,barW,h-4); }
            requestAnimationFrame(d);
        } d();
    }
    async function loadSheetData() { 
        updateLoading(50, "CONECTANDO CON GOOGLE...");
        try { 
            const r = await fetch(GOOGLE_SCRIPT_URL).then(res => res.json()); 
            updateLoading(80, "PROCESANDO DATOS...");
            if(r.automatico) automaticoData = r.automatico.map(x => x.TEXTO); 
            if(r.programado) r.programado.forEach(x => programadoData.set(x.PREGUNTA.toLowerCase(), x.RESPUESTA)); 
            updateLoading(100, "SISTEMA LISTO");
        }catch(e){ 
            updateLoading(100, "ERROR DE CONEXIÓN (MODO OFFLINE)"); 
        } 
    }
    function startVisualLoops() { setInterval(() => { let rot = Math.random() * 120 - 60; document.getElementById('emf-arrow').style.transform = `rotate(${rot}deg)`; }, 150); }
</script>
</body>
</html>
