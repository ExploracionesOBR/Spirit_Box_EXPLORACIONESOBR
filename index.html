<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="apple-touch-icon" href="obr-logo.png">

    <title>DETECTOR-OBR</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <style>
        :root {
            --neon-green: #39FF14; 
            --alert-red: #FF3333;
            --sim-orange: #FFB000;
            --sensor-blue: #00BFFF;
            --panel-bg: rgba(0, 20, 0, 0.4); /* Fondo de cristal oscuro */
            --border-color: rgba(57, 255, 20, 0.3);
            --border-strong: rgba(57, 255, 20, 0.7);
            --text-color: #E0E0E0;
            --text-dim: #999;
            
            /* --- 游늸 TAMA칌OS DEL NUEVO HUD --- */
            --hud-bottom-height: 160px; /* Altura de la barra inferior */
            --hud-left-width: 100px; /* Ancho de la barra izquierda */
            --hud-gap: 15px; /* Espacio entre los bordes y las barras */
            --panel-section-padding: 6px;
        }
        
        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: #000;
            color: var(--neon-green);
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex; /* Para el layout principal de la app */
            justify-content: center;
            align-items: center;
        }

        #app-ui {
            position: relative;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-areas:
                "left-panel camera-view"
                "bottom-panel bottom-panel";
            grid-template-columns: var(--hud-left-width) 1fr;
            grid-template-rows: 1fr var(--hud-bottom-height);
            background-color: #000; /* Fondo base para asegurar que la c치mara no se escape */
            touch-action: none; /* Desactiva el desplazamiento por defecto en pantallas t치ctiles */
        }
        
        /* Contenedor de la c치mara */
        #main-view-area {
            grid-area: camera-view;
            position: relative; /* Es crucial que sea relative para que los flotantes se posicionen dentro */
            overflow: hidden;
            z-index: 5;
            background: #000;
            transition: filter 0.3s ease-in-out;
        }
        
        /* Paneles de la Cabina en L */
        #left-panel-container {
            grid-area: left-panel;
            background: var(--panel-bg);
            border-right: 1px solid var(--border-strong);
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.2) inset, 0 0 8px rgba(57, 255, 20, 0.2);
            border-radius: 0 8px 0 0; /* Bordes redondeados correctos */
            z-index: 20;
            display: flex;
            flex-direction: column;
            padding: var(--panel-section-padding);
            gap: var(--panel-section-padding);
            transition: transform 0.4s ease-out, opacity 0.4s ease-out;
            pointer-events: auto;
        }

        #bottom-panel-container {
            grid-area: bottom-panel;
            background: var(--panel-bg);
            border-top: 1px solid var(--border-strong);
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.2) inset, 0 0 8px rgba(57, 255, 20, 0.2);
            border-radius: 8px 0 0 0; /* Bordes redondeados correctos */
            z-index: 20;
            display: flex;
            flex-direction: row; /* Horizontal para la barra inferior */
            padding: var(--panel-section-padding);
            gap: var(--panel-section-padding);
            transition: transform 0.4s ease-out, opacity 0.4s ease-out;
            pointer-events: auto;
            align-items: center; /* Centrar verticalmente el contenido */
        }

        /* 游늸 Efecto de ocultar paneles y flotantes */
        body.ui-hidden #left-panel-container {
            transform: translateX(-100%);
            opacity: 0;
            pointer-events: none;
        }
        body.ui-hidden #bottom-panel-container {
            transform: translateY(100%);
            opacity: 0;
            pointer-events: none;
        }
        
        /* Filtros de la c치mara */
        #main-view-area.filter-vno {
            filter: grayscale(1) contrast(1.5) brightness(1.2) sepia(1) hue-rotate(50deg) saturate(20);
        }
        #main-view-area.filter-neg {
            filter: invert(1) hue-rotate(180deg) brightness(1.1);
        }

        #bg-camera-feed {
            position: absolute;
            top: 50%;
            left: 50%;
            min-width: 100%; 
            min-height: 100%; 
            width: auto;
            height: auto;
            object-fit: cover; 
            transform: translate(-50%, -50%) scale(1);
            z-index: 1;
            transition: transform 0.3s ease-out;
        }
        
        #main-filter-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; 
            height: 100%; 
            z-index: 10; /* Encima del video */
            pointer-events: none; 
            display: none; /* Oculto por defecto */
        }

        .hidden-canvas { display: none; }
        .hidden { display: none !important; }

        /* --- Controles Flotantes sobre la c치mara (LOGO, LINTERNA, FILTROS) --- */
        #hud-floating-controls {
            position: absolute; /* Posicionado absolutamente dentro de #main-view-area */
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 101; /* Encima del canvas de filtros */
            pointer-events: none; /* El contenedor no bloquea clics, solo los hijos */
            opacity: 1;
            transition: opacity 0.4s ease-out;
        }
        body.ui-hidden #hud-floating-controls {
            opacity: 0;
            pointer-events: none;
        }
        
        #hud-top-logo {
            position: absolute;
            top: var(--hud-gap);
            right: var(--hud-gap);
            width: 60px; height: 60px;
            pointer-events: auto;
            animation: logo-effects 7s infinite linear; 
        }

        #hud-torch-button {
            position: absolute;
            top: var(--hud-gap);
            left: var(--hud-gap);
            width: 50px; height: 50px;
            background: rgba(0, 50, 50, 0.7);
            border: 2px solid var(--border-strong);
            color: var(--neon-green);
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.5);
            transition: all 0.2s;
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #hud-torch-button svg { width: 24px; height: 24px; fill: currentColor; }
        #hud-torch-button:active, #hud-torch-button.active {
            background: var(--neon-green); color: #000; box-shadow: 0 0 20px #fff;
        }

        #hud-filter-controls {
            position: absolute;
            top: 50%;
            right: var(--hud-gap);
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
        }
        .filter-btn {
            width: 50px; height: 50px;
            border-radius: 50%;
            background: rgba(0, 50, 50, 0.7);
            border: 2px solid var(--border-strong);
            color: var(--neon-green);
            font-weight: bold; cursor: pointer;
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.5);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }
        .filter-btn:active, .filter-btn.active {
            background: var(--neon-green); color: #000; box-shadow: 0 0 20px #fff;
        }
        
        /* Animaciones para los elementos flotantes */
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes logo-effects { 0%, 90% { transform: scale(1) translateY(0); opacity: 1; filter: none; } 91% { transform: scale(1.1) translateX(-5px); opacity: 0.8; filter: drop-shadow(2px 0 red) drop-shadow(-2px 0 blue); } 92% { transform: scale(0.9) translateX(5px); opacity: 1; filter: drop-shadow(-2px 0 red) drop-shadow(2px 0 blue); } 93% { transform: scale(1) translateY(0); opacity: 1; filter: none; } 94% { transform: scale(1) translateY(0); opacity: 0.5; filter: blur(2px); } 95% { transform: scale(1) translateY(0); opacity: 1; filter: none; } 96% { transform: scale(1) translateY(-3px); } 97% { transform: scale(1) translateY(3px); } 98%, 100% { transform: scale(1) translateY(0); } }
        /* WaterDrop para ocultar los flotantes, NO los paneles de cabina */
        #hud-top-logo.hiding, #hud-torch-button.hiding, #hud-filter-controls.hiding { animation: waterDrop 0.5s ease-out forwards; }
        @keyframes waterDrop { 0% { opacity: 1; transform: scale(1); filter: blur(0); } 100% { opacity: 0; transform: scale(2.5); filter: blur(5px); } }
        @keyframes pulseGlow { 0%, 100% { opacity: 0.6; } 50% { opacity: 1.0; } }

        /* --- Dise침o de Secciones de Paneles --- */
        .panel-section {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: var(--panel-section-padding);
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: var(--panel-section-padding);
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 3px;
            white-space: nowrap;
        }

        /* Contenido del Panel Izquierdo */
        #left-panel-container .panel-section { flex-grow: 1; justify-content: space-between; }
        #left-panel-container .sensor-status-grid {
            display: flex; /* Cambiado a flex para control vertical */
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }
        .status-light-group { display: flex; flex-direction: column; align-items: center; font-size: 0.6rem; color: var(--text-dim); gap: 4px; }
        .status-led-indicator { width: 12px; height: 12px; border-radius: 50%; background-color: #222; border: 1px solid #444; transition: all 0.3s; }
        .status-light-group[data-status="connected"] .status-led-indicator { background-color: var(--neon-green); box-shadow: 0 0 8px var(--neon-green); animation: pulseGlow 1.5s infinite; }
        .status-light-group[data-status="fallback"] .status-led-indicator { background-color: var(--sensor-blue); box-shadow: 0 0 8px var(--sensor-blue); animation: pulseGlow 1.5s infinite; }
        .status-light-group[data-status="simulated"] .status-led-indicator { background-color: var(--sim-orange); box-shadow: 0 0 8px var(--sim-orange); animation: pulseGlow 2s infinite; }
        .status-light-group[data-status="unavailable"] .status-led-indicator { background-color: var(--alert-red); box-shadow: 0 0 8px var(--alert-red); }
        .status-light-group[data-status="off"] .status-led-indicator { background-color: #333; }
        .status-light-group .emoji { font-size: 1.2rem; line-height: 1; }

        #cam-stats-display {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--alert-red);
            text-align: center;
            animation: rec-pulse 1.5s infinite ease-in-out;
            cursor: default;
            margin-top: 10px; /* Separaci칩n del resto */
        }
        @keyframes rec-pulse { 0%, 100% { opacity: 1; text-shadow: 0 0 8px var(--alert-red); } 50% { opacity: 0.7; text-shadow: 0 0 4px var(--alert-red); } }

        /* Contenido del Panel Inferior */
        #bottom-panel-container .panel-section {
            flex-direction: row; /* Para poner t칤tulo y contenido lado a lado */
            flex-grow: 1;
            align-items: center;
            gap: 10px;
        }
        #bottom-panel-container .section-title {
            writing-mode: vertical-rl; /* T칤tulo vertical */
            text-orientation: mixed;
            border-bottom: none;
            border-right: 1px solid var(--border-color);
            padding-bottom: 0;
            padding-right: 3px;
            font-size: 0.55rem; /* Un poco m치s peque침o */
            flex-shrink: 0;
            height: 100%; /* Ajuste a la altura de la secci칩n */
            display: flex;
            align-items: center;
        }

        /* Lecturas de Campo */
        .dials-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* 3 columnas para los 3 elementos */
            gap: 10px;
            align-items: center;
            justify-items: center;
            flex-grow: 1; /* Ocupa el espacio disponible */
        }
        .dial-container { position: relative; width: 65px; height: 65px; background: radial-gradient(circle, #111, #000); border-radius: 50%; border: 1px solid var(--border-color); box-shadow: 0 0 5px rgba(57, 255, 20, 0.3) inset; }
        .dial-needle { width: 2px; height: 40%; background: var(--neon-green); box-shadow: 0 0 5px var(--neon-green); position: absolute; bottom: 50%; left: 50%; transform-origin: bottom center; transform: translateX(-50%) rotate(-45deg); transition: transform 0.5s cubic-bezier(0.2, 1.5, 0.5, 1); }
        .dial-label { font-size: 0.6rem; color: var(--text-dim); margin-top: 4px; text-align: center; }
        
        #detector-dial-container { width: 90px; height: 90px; } /* M치s grande */
        #detector-dial-needle { height: 45%; background: var(--alert-red); box-shadow: 0 0 8px var(--alert-red); transform: translateX(-50%) rotate(-60deg); }
        
        #temp-readout { text-align: center; }
        #temp-val { font-size: 1.8rem; font-family: 'Orbitron', sans-serif; color: var(--neon-green); line-height: 1; }
        .temp-label { font-size: 0.6rem; color: var(--text-dim); }

        /* Spirit Box */
        .spirit-box-content {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr; /* Pwr | Actividad | Vol */
            grid-template-rows: auto auto; /* Knobs arriba, graph/slider abajo */
            gap: 8px;
            flex-grow: 1;
            height: 100%;
        }
        .knob-container { display: flex; flex-direction: column; align-items: center; }
        .knob-label { font-size: 0.6rem; color: var(--text-dim); margin-top: 4px; }
        .knob-circle { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--border-color); position: relative; cursor: pointer; background: radial-gradient(circle, #222, #000); box-shadow: 0 3px 5px #000, 0 0 5px rgba(57, 255, 20, 0.3) inset; transition: all 0.3s; }
        .knob-circle.active { border-color: var(--neon-green); box-shadow: 0 3px 5px #000, 0 0 10px var(--neon-green) inset, 0 0 10px var(--neon-green); }
        .knob-indicator { position: absolute; top: 6px; left: 50%; width: 3px; height: 15px; background: var(--neon-green); transform: translateX(-50%); border-radius: 2px; box-shadow: 0 0 5px var(--neon-green); }
        #pwr-knob-indicator { height: 8px; width: 8px; border-radius: 50%; top: 8px; background: var(--alert-red); box-shadow: 0 0 5px var(--alert-red); }
        #pwr-knob.active #pwr-knob-indicator { background: var(--neon-green); box-shadow: 0 0 8px var(--neon-green); }

        #activity-graph-container {
            grid-column: 2 / 3; /* Ocupa la columna central */
            grid-row: 1 / 3; /* Ocupa ambas filas */
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #000; border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden;
        }
        #energy-canvas { width: 100%; height: 100%; }

        .volume-control-group {
            grid-column: 3 / 4; /* Columna derecha */
            grid-row: 1 / 3; /* Ocupa ambas filas */
            display: flex;
            flex-direction: column; /* Vertical */
            align-items: center;
            justify-content: center;
            gap: 8px;
            height: 100%;
        }
        .vol-label { font-size: 0.6rem; color: var(--text-dim); white-space: nowrap; }
        #vol-percent { font-size: 0.6rem; color: var(--neon-green); width: 30px; text-align: center; }
        input[type=range] { 
            -webkit-appearance: none; 
            width: 10px; /* Ancho muy peque침o para que sea vertical */
            height: 80px; /* Altura para el rango */
            background: #111; 
            border: 1px solid var(--border-color); 
            border-radius: 10px; 
            overflow: hidden; 
            transform: rotate(-90deg); /* Rotar para que sea vertical */
            transform-origin: center;
            margin: 0; /* Eliminar margen para centrar */
        }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            width: 20px; /* Ancho del thumb */
            height: 20px; /* Altura del thumb */
            background: #444; 
            border: 1px solid #666; 
            border-radius: 50%; 
            box-shadow: -100vw 0 0 100vw var(--neon-green); 
            cursor: pointer; 
        }

        /* --- Pantalla de Carga y "S칤guenos" --- */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s ease-out; }
        #loading-content { text-align: center; }
        #loading-text { font-family: 'Orbitron', sans-serif; font-size: 1.2rem; color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green); animation: pulseGlow 2s infinite ease-in-out; transition: all 0.3s; }
        #loading-bar-container { width: 250px; height: 10px; border: 1px solid var(--neon-green); border-radius: 5px; margin-top: 15px; overflow: hidden; background: rgba(0, 50, 50, 0.3); }
        #loading-bar { width: 0%; height: 100%; background-color: var(--neon-green); transition: width 0.4s ease-out; animation: loading-shimmer 2s infinite linear; background-image: linear-gradient(90deg, var(--neon-green) 0%, #fff 50%, var(--neon-green) 100%); background-size: 200% 100%; }
        @keyframes loading-shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        #follow-container { 
            position: fixed; 
            bottom: var(--hud-bottom-height); /* Encima de la barra inferior */
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 200; 
            pointer-events: none; 
            opacity: 0; /* Por defecto oculto */
            width: 100%; 
            transition: opacity 0.5s ease-out; 
            padding-bottom: 20px; /* Espacio para que no toque la barra */
        }
        #follow-container.visible { opacity: 1; }
        .follow-step { 
            display: none; 
            color: var(--neon-green); 
            font-size: 1.5rem; 
            font-family: 'Orbitron', sans-serif; 
            text-shadow: 0 0 10px var(--neon-green); 
            text-align: center; 
            opacity: 0; 
        }
        #follow-icons { display: flex; align-items: center; justify-content: center; gap: 15px; }
        #follow-icons svg { width: 50px; height: 50px; fill: var(--neon-green); filter: drop-shadow(0 0 5px var(--neon-green)); }
        .fade-in { animation: fadeIn 1s ease-out forwards; }
        .fade-out { animation: fadeOut 1s ease-out forwards; }
        @keyframes fadeIn { 0% { opacity: 0; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { 0% { opacity: 1; } 100% { opacity: 0; } }

        /* --- Media Queries para Adaptabilidad --- */

        /* MODO VERTICAL (PORTRAIT) */
        @media (max-aspect-ratio: 1/1) {
            #app-ui {
                grid-template-areas:
                    "left-panel"
                    "camera-view"
                    "bottom-panel";
                grid-template-columns: 1fr; /* Una sola columna */
                grid-template-rows: var(--hud-left-width) 1fr var(--hud-bottom-height); /* Altura de la izquierda como superior */
            }

            #left-panel-container {
                border-right: none;
                border-bottom: 1px solid var(--border-strong);
                border-radius: 0 0 8px 8px; /* Redondeo abajo */
                width: 100%; /* Ocupa todo el ancho */
                height: var(--hud-left-width); /* Nueva altura */
                flex-direction: row; /* Contenido horizontal */
                justify-content: space-around;
            }

            #left-panel-container .sensor-status-grid {
                flex-direction: row; /* Sensores en fila */
                gap: 20px;
            }

            #left-panel-container .section-title {
                margin-bottom: 0;
                border-bottom: none;
                border-right: 1px solid var(--border-color);
                padding-bottom: 0;
                padding-right: 3px;
                writing-mode: vertical-rl; /* T칤tulo vertical */
                height: 100%;
                font-size: 0.55rem;
            }
            #left-panel-container .panel-section {
                flex-grow: 1;
                flex-direction: row;
                justify-content: center;
                align-items: center;
            }

            #cam-stats-display {
                margin-top: 0; /* Eliminar margen vertical */
                margin-left: 10px; /* Margen a la izquierda */
            }

            #bottom-panel-container {
                border-top: none;
                border-radius: 8px 8px 0 0; /* Redondeo arriba */
                width: 100%;
                flex-direction: column; /* Contenido vertical */
                height: var(--hud-bottom-height);
            }
            #bottom-panel-container .panel-section { flex-direction: column; flex-grow: 1; }
            #bottom-panel-container .section-title {
                writing-mode: horizontal-tb; /* T칤tulo horizontal */
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding-right: 0;
                padding-bottom: 3px;
                font-size: 0.6rem;
            }
            #bottom-panel-container .dials-grid { grid-template-columns: 1fr 1fr; } /* 2 columnas para mantener la forma */
            #detector-dial-container { width: 65px; height: 65px; } /* Ajustar tama침o del dial */
            #detector-dial-needle { height: 40%; }

            .spirit-box-content {
                grid-template-columns: 1fr 1fr; /* 2 columnas */
                grid-template-rows: auto auto auto; /* Mas filas */
            }
            #activity-graph-container { grid-column: 1 / 3; grid-row: 2 / 3; } /* Ocupa el centro */
            .knob-container:first-child { grid-column: 1 / 2; grid-row: 1 / 2; }
            .volume-control-group { grid-column: 2 / 3; grid-row: 1 / 2; flex-direction: row; }
            input[type=range] { transform: rotate(0deg); width: 80px; height: 10px; }
            #vol-percent { text-align: left; }
        }
    </style>
</head>
<body>

<div id="app-ui"> 

    <div id="loading-overlay">
        <div id="loading-content">
            <div id="loading-text">INICIANDO DETECTOR OBR</div>
            <div id="loading-bar-container">
